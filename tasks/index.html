<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://www.jkobject.com/scPRINT-2/tasks/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>tasks - scPRINT-2</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "tasks";
        var mkdocs_page_input_path = "tasks.md";
        var mkdocs_page_url = "/scPRINT-2/tasks/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="..">
          <img src="../fig.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../structure/">structure</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../pretrain/">pre-training</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../umap/nice_umap_scprint2.html">350M subset umap</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">documentation</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../model/">model</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tokenizers/">tokenizers</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">tasks</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#scprint2.tasks.cell_emb">cell_emb</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#scprint2.tasks.cell_emb.Embedder">Embedder</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#scprint2.tasks.cell_emb.Embedder.__call__">__call__</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scprint2.tasks.cell_emb.compute_classification">compute_classification</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scprint2.tasks.cell_emb.compute_corr">compute_corr</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scprint2.tasks.cell_emb.default_benchmark">default_benchmark</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scprint2.tasks.cell_emb.display_confusion_matrix">display_confusion_matrix</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#scprint2.tasks.grn">grn</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#scprint2.tasks.grn.GNInfer">GNInfer</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#scprint2.tasks.grn.GNInfer.__call__">__call__</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#scprint2.tasks.grn.GNInfer.aggregate">aggregate</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#scprint2.tasks.grn.GNInfer.filter">filter</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#scprint2.tasks.grn.GNInfer.predict">predict</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scprint2.tasks.grn.default_benchmark">default_benchmark</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#scprint2.tasks.denoise">denoise</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#scprint2.tasks.denoise.Denoiser">Denoiser</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#scprint2.tasks.denoise.Denoiser.__call__">__call__</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scprint2.tasks.denoise.default_benchmark">default_benchmark</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scprint2.tasks.denoise.split_molecules">split_molecules</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#scprint2.tasks.gene_emb">gene_emb</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#scprint2.tasks.gene_emb.GeneEmbeddingExtractor">GeneEmbeddingExtractor</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#scprint2.tasks.generate">generate</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#scprint2.tasks.generate.Generate">Generate</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#scprint2.tasks.generate.Generate.__call__">__call__</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#scprint2.tasks.impute">impute</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#scprint2.tasks.impute.Imputer">Imputer</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#scprint2.tasks.impute.Imputer.__call__">__call__</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#scprint2.tasks.finetune">finetune</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#scprint2.tasks.finetune.FinetuneBatchClass">FinetuneBatchClass</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#scprint2.tasks.finetune.FinetuneBatchClass.__call__">__call__</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scprint2.tasks.finetune.mmd_loss">mmd_loss</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../utils/">utils</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cli/">cli</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">scPRINT-2</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">documentation</li>
      <li class="breadcrumb-item active">tasks</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="documentation-for-the-tasks">Documentation for the <code>tasks</code></h1>


<div class="doc doc-object doc-module">



<h2 id="scprint2.tasks.cell_emb" class="doc doc-heading">
            <code>scprint2.tasks.cell_emb</code>


</h2>

    <div class="doc doc-contents first">










<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="Embedder (scprint2.tasks.cell_emb.Embedder)" href="#scprint2.tasks.cell_emb.Embedder">Embedder</a></code></td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>




<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="compute_classification (scprint2.tasks.cell_emb.compute_classification)" href="#scprint2.tasks.cell_emb.compute_classification">compute_classification</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Compute classification metrics for the given annotated data.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="compute_corr (scprint2.tasks.cell_emb.compute_corr)" href="#scprint2.tasks.cell_emb.compute_corr">compute_corr</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Compute the correlation between the output and target matrices.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="default_benchmark (scprint2.tasks.cell_emb.default_benchmark)" href="#scprint2.tasks.cell_emb.default_benchmark">default_benchmark</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Run the default benchmark for embedding and annotation using the scPRINT model.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="display_confusion_matrix (scprint2.tasks.cell_emb.display_confusion_matrix)" href="#scprint2.tasks.cell_emb.display_confusion_matrix">display_confusion_matrix</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Display the confusion matrix for true vs predicted cell types.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>





<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="scprint2.tasks.cell_emb.Embedder" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">Embedder</span></code>

</h3>


    <div class="doc doc-contents ">



        <p>Embedder a class to embed and annotate cells using a model</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>batch_size</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>64</code>
)
              –
              <div class="doc-md-description">
                <p>The size of the batches to be used in the DataLoader. Defaults to 64.</p>
              </div>
            </li>
            <li>
              <b><code>num_workers</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>8</code>
)
              –
              <div class="doc-md-description">
                <p>The number of worker processes to use for data loading. Defaults to 8.</p>
              </div>
            </li>
            <li>
              <b><code>how</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>&#39;random expr&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>The method to be used for selecting valid genes. Defaults to "random expr".
- "random expr": random expression
- "most var": highly variable genes in the dataset
- "some": specific genes (from genelist)
- "most expr": most expressed genes in the cell</p>
              </div>
            </li>
            <li>
              <b><code>max_len</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>2000</code>
)
              –
              <div class="doc-md-description">
                <p>The maximum length of the gene sequence given to the model. Defaults to 1000.</p>
              </div>
            </li>
            <li>
              <b><code>doclass</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to perform classification. Defaults to True.</p>
              </div>
            </li>
            <li>
              <b><code>pred_embedding</code></b>
                  (<code><span title="typing.List">List</span>[<span title="str">str</span>]</code>, default:
                      <code>[&#39;all&#39;]</code>
)
              –
              <div class="doc-md-description">
                <p>The list of labels to be used for plotting embeddings. Defaults to [ "cell_type_ontology_term_id", "disease_ontology_term_id", "self_reported_ethnicity_ontology_term_id", "sex_ontology_term_id", ].</p>
              </div>
            </li>
            <li>
              <b><code>doplot</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to generate plots. Defaults to True.</p>
              </div>
            </li>
            <li>
              <b><code>keep_all_labels_pred</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to keep all class predictions. Defaults to False, will only keep the most likely class.</p>
              </div>
            </li>
            <li>
              <b><code>genelist</code></b>
                  (<code><span title="typing.List">List</span>[<span title="str">str</span>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The list of genes to be used for embedding. Defaults to []: In this case, "how" needs to be "most var" or "random expr".</p>
              </div>
            </li>
            <li>
              <b><code>save_every</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>40000</code>
)
              –
              <div class="doc-md-description">
                <p>The number of cells to save at a time. Defaults to 100_000.
This is important to avoid memory issues.</p>
              </div>
            </li>
            <li>
              <b><code>unknown_label</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>&#39;unknown&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>The label to be used for unknown cell types. Defaults to "unknown".</p>
              </div>
            </li>
            <li>
              <b><code>use_knn</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to use k-nearest neighbors information. Defaults to True.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>










<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="__call__ (scprint2.tasks.cell_emb.Embedder.__call__)" href="#scprint2.tasks.cell_emb.Embedder.__call__">__call__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p><strong>call</strong> function to call the embedding</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>



                  <details class="quote">
                    <summary>Source code in <code>scprint2/tasks/cell_emb.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">how</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;random expr&quot;</span><span class="p">,</span>
    <span class="n">max_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>
    <span class="n">doclass</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">pred_embedding</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">doplot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">keep_all_labels_pred</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">genelist</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_every</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">40_000</span><span class="p">,</span>
    <span class="n">unknown_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
    <span class="n">use_knn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Embedder a class to embed and annotate cells using a model</span>

<span class="sd">    Args:</span>
<span class="sd">        batch_size (int, optional): The size of the batches to be used in the DataLoader. Defaults to 64.</span>
<span class="sd">        num_workers (int, optional): The number of worker processes to use for data loading. Defaults to 8.</span>
<span class="sd">        how (str, optional): The method to be used for selecting valid genes. Defaults to &quot;random expr&quot;.</span>
<span class="sd">            - &quot;random expr&quot;: random expression</span>
<span class="sd">            - &quot;most var&quot;: highly variable genes in the dataset</span>
<span class="sd">            - &quot;some&quot;: specific genes (from genelist)</span>
<span class="sd">            - &quot;most expr&quot;: most expressed genes in the cell</span>
<span class="sd">        max_len (int, optional): The maximum length of the gene sequence given to the model. Defaults to 1000.</span>
<span class="sd">        doclass (bool, optional): Whether to perform classification. Defaults to True.</span>
<span class="sd">        pred_embedding (List[str], optional): The list of labels to be used for plotting embeddings. Defaults to [ &quot;cell_type_ontology_term_id&quot;, &quot;disease_ontology_term_id&quot;, &quot;self_reported_ethnicity_ontology_term_id&quot;, &quot;sex_ontology_term_id&quot;, ].</span>
<span class="sd">        doplot (bool, optional): Whether to generate plots. Defaults to True.</span>
<span class="sd">        keep_all_labels_pred (bool, optional): Whether to keep all class predictions. Defaults to False, will only keep the most likely class.</span>
<span class="sd">        genelist (List[str], optional): The list of genes to be used for embedding. Defaults to []: In this case, &quot;how&quot; needs to be &quot;most var&quot; or &quot;random expr&quot;.</span>
<span class="sd">        save_every (int, optional): The number of cells to save at a time. Defaults to 100_000.</span>
<span class="sd">            This is important to avoid memory issues.</span>
<span class="sd">        unknown_label (str, optional): The label to be used for unknown cell types. Defaults to &quot;unknown&quot;.</span>
<span class="sd">        use_knn (bool, optional): Whether to use k-nearest neighbors information. Defaults to True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="o">=</span> <span class="n">num_workers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">=</span> <span class="n">how</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="n">max_len</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pred_embedding</span> <span class="o">=</span> <span class="n">pred_embedding</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">keep_all_labels_pred</span> <span class="o">=</span> <span class="n">keep_all_labels_pred</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">doplot</span> <span class="o">=</span> <span class="n">doplot</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">doclass</span> <span class="o">=</span> <span class="n">doclass</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">genelist</span> <span class="o">=</span> <span class="n">genelist</span> <span class="k">if</span> <span class="n">genelist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_every</span> <span class="o">=</span> <span class="n">save_every</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pred</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">unknown_label</span> <span class="o">=</span> <span class="n">unknown_label</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_knn</span> <span class="o">=</span> <span class="n">use_knn</span>
</code></pre></div></td></tr></table></div>
                  </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="scprint2.tasks.cell_emb.Embedder.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__call__</span></code>

</h4>


    <div class="doc doc-contents ">

        <p><strong>call</strong> function to call the embedding</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>model</code></b>
                  (<code><span title="torch.nn.Module">Module</span></code>)
              –
              <div class="doc-md-description">
                <p>The scPRINT model to be used for embedding and annotation.</p>
              </div>
            </li>
            <li>
              <b><code>adata</code></b>
                  (<code><span title="anndata.AnnData">AnnData</span></code>)
              –
              <div class="doc-md-description">
                <p>The annotated data matrix of shape n_obs x n_vars. Rows correspond to cells and columns to genes.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
                <p>If the model does not have a logger attribute.</p>
              </div>
            </li>
            <li>
                  <code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
                <p>If the model does not have a global_step attribute.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>AnnData</code></b>(                  <code><span title="anndata.AnnData">AnnData</span></code>
)              –
              <div class="doc-md-description">
                <p>The annotated data matrix with embedded cell representations.</p>
              </div>
            </li>
            <li>
<b><code>dict</code></b>(                  <code><span title="dict">dict</span></code>
)              –
              <div class="doc-md-description">
                <p>classification metrics results when some ground truth information was available in the anndata.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>scprint2/tasks/cell_emb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">AnnData</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    __call__ function to call the embedding</span>

<span class="sd">    Args:</span>
<span class="sd">        model (torch.nn.Module): The scPRINT model to be used for embedding and annotation.</span>
<span class="sd">        adata (AnnData): The annotated data matrix of shape n_obs x n_vars. Rows correspond to cells and columns to genes.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the model does not have a logger attribute.</span>
<span class="sd">        ValueError: If the model does not have a global_step attribute.</span>

<span class="sd">    Returns:</span>
<span class="sd">        AnnData: The annotated data matrix with embedded cell representations.</span>
<span class="sd">        dict: classification metrics results when some ground truth information was available in the anndata.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># one of &quot;all&quot; &quot;sample&quot; &quot;none&quot;</span>
    <span class="n">model</span><span class="o">.</span><span class="n">predict_mode</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pred</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">prevkeep</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">keep_all_labels_pred</span>
    <span class="n">model</span><span class="o">.</span><span class="n">keep_all_labels_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_all_labels_pred</span>
    <span class="c1"># Add at least the organism you are working with</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;most var&quot;</span><span class="p">:</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">highly_variable_genes</span><span class="p">(</span>
            <span class="n">adata</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s2">&quot;seurat_v3&quot;</span><span class="p">,</span> <span class="n">n_top_genes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genelist</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">highly_variable</span><span class="p">]</span>
    <span class="n">adataset</span> <span class="o">=</span> <span class="n">SimpleAnnDataset</span><span class="p">(</span>
        <span class="n">adata</span><span class="p">,</span>
        <span class="n">obs_to_output</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;organism_ontology_term_id&quot;</span><span class="p">],</span>
        <span class="n">get_knn_cells</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_knn</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">Collator</span><span class="p">(</span>
        <span class="n">organisms</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">organisms</span><span class="p">,</span>
        <span class="n">valid_genes</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">genes</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">!=</span> <span class="s2">&quot;most var&quot;</span> <span class="k">else</span> <span class="s2">&quot;some&quot;</span><span class="p">,</span>
        <span class="n">max_len</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">,</span>
        <span class="n">add_zero_genes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">genelist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">genelist</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;most var&quot;</span><span class="p">,</span> <span class="s2">&quot;some&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="p">[],</span>
        <span class="n">n_bins</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">n_input_bins</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;binned&quot;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
        <span class="n">adataset</span><span class="p">,</span>
        <span class="n">collate_fn</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">on_predict_epoch_start</span><span class="p">()</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span>
    <span class="n">prevplot</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">doplot</span>
    <span class="n">model</span><span class="o">.</span><span class="n">pred_log_adata</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">model</span><span class="o">.</span><span class="n">doplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doplot</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_all_labels_pred</span>
    <span class="n">model</span><span class="o">.</span><span class="n">save_expr</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">rand</span> <span class="o">=</span> <span class="n">random_str</span><span class="p">()</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">float16</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">transformer</span><span class="p">,</span> <span class="n">FlashTransformer</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">model</span><span class="o">.</span><span class="n">dtype</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">(),</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
            <span class="n">gene_pos</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;genes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span>
                <span class="n">gene_pos</span><span class="p">,</span>
                <span class="n">expression</span><span class="p">,</span>
                <span class="n">depth</span><span class="p">,</span>
                <span class="n">knn_cells</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;knn_cells&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_knn</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">),</span>
                <span class="n">knn_cells_info</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;knn_cells_info&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_knn</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">),</span>
                <span class="n">pred_embedding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pred_embedding</span><span class="p">,</span>
                <span class="n">max_size_in_mem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">save_every</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;embed_&quot;</span> <span class="o">+</span> <span class="n">rand</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_all_labels_pred</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pred</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pred</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">pred</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">pred</span><span class="p">,</span> <span class="n">pred</span><span class="p">])</span>
                    <span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">log_adata</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;embed_&quot;</span> <span class="o">+</span> <span class="n">rand</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">counter</span><span class="p">))</span>

    <span class="n">model</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">model</span><span class="o">.</span><span class="n">expr_pred</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">model</span><span class="o">.</span><span class="n">embs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_all_labels_pred</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pred</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">pred</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">pred</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">pred</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">pred</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">model</span><span class="o">.</span><span class="n">save_expr</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mdir</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">save_dir</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">save_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;data&quot;</span>
        <span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">mdir</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span>
    <span class="n">pred_adata</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">del</span> <span class="n">adataset</span><span class="p">,</span> <span class="n">dataloader</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">mdir</span>
            <span class="o">+</span> <span class="s2">&quot;/step_&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">global_step</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
            <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span>
            <span class="o">+</span> <span class="s2">&quot;_embed_&quot;</span>
            <span class="o">+</span> <span class="n">rand</span>
            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">global_rank</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;.h5ad&quot;</span>
        <span class="p">)</span>
        <span class="n">pred_adata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">pred_adata</span> <span class="o">=</span> <span class="n">concat</span><span class="p">(</span><span class="n">pred_adata</span><span class="p">)</span>
    <span class="n">pred_adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;X_scprint_umap&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;X_umap&quot;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">pred_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;X_umap&quot;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;too few cells to embed into a umap&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;scprint_leiden&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;scprint_leiden&quot;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;too few cells to compute a clustering&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_embedding</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]:</span>
        <span class="n">pred_embedding</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;other&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">classes</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pred_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_embedding</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_embedding</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;scprint_emb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span>
            <span class="s2">&quot;scprint_emb_&quot;</span> <span class="o">+</span> <span class="n">pred_embedding</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;scprint_emb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">pred_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;scprint_emb_&quot;</span> <span class="o">+</span> <span class="n">pred_embedding</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pred_adata</span><span class="o">.</span><span class="n">obsm</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">compressor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;scprint_emb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;scprint_emb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;scprint_emb&quot;</span><span class="p">],</span> <span class="n">v</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)]</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;scprint_emb&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">v</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">compressor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;scprint_emb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;scprint_emb&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">i</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pred_adata</span><span class="o">.</span><span class="n">uns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="n">pred_adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span>
    <span class="n">model</span><span class="o">.</span><span class="n">keep_all_labels_pred</span> <span class="o">=</span> <span class="n">prevkeep</span>
    <span class="n">model</span><span class="o">.</span><span class="n">doplot</span> <span class="o">=</span> <span class="n">prevplot</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">pred_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">pred_adata</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_all_labels_pred</span><span class="p">:</span>
        <span class="n">allclspred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">label_counts</span><span class="p">[</span><span class="n">cl</span><span class="p">]</span>
            <span class="n">columns</span> <span class="o">+=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">label_decoders</span><span class="p">[</span><span class="n">cl</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
        <span class="n">allclspred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">allclspred</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span>
        <span class="p">)</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">allclspred</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doclass</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_all_labels_pred</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">cl</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">class_topred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">label_decoders</span><span class="p">[</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">labels_hierarchy</span><span class="p">:</span>
                <span class="c1"># class_groupings = {</span>
                <span class="c1">#    k: [</span>
                <span class="c1">#        i.ontology_id</span>
                <span class="c1">#        for i in bt.CellType.filter(k).first().children.all()</span>
                <span class="c1">#    ]</span>
                <span class="c1">#    for k in set(adata.obs[cl].unique()) - set(class_topred)</span>
                <span class="c1"># }</span>
                <span class="n">cur_labels_hierarchy</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">label_decoders</span><span class="p">[</span><span class="n">cl</span><span class="p">][</span><span class="n">k</span><span class="p">]:</span> <span class="p">[</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">label_decoders</span><span class="p">[</span><span class="n">cl</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">labels_hierarchy</span><span class="p">[</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cur_labels_hierarchy</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">pred</span><span class="p">,</span> <span class="n">true</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[[</span><span class="s2">&quot;pred_&quot;</span> <span class="o">+</span> <span class="n">cl</span><span class="p">,</span> <span class="n">cl</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pred</span> <span class="o">==</span> <span class="n">true</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_labels_hierarchy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">true</span> <span class="ow">in</span> <span class="n">cur_labels_hierarchy</span><span class="p">:</span>
                        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span> <span class="ow">in</span> <span class="n">cur_labels_hierarchy</span><span class="p">[</span><span class="n">true</span><span class="p">])</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">true</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unknown_label</span><span class="p">:</span>
                        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">true</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">class_topred</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;true label </span><span class="si">{</span><span class="n">true</span><span class="si">}</span><span class="s2"> not in available classes&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">adata</span><span class="p">,</span> <span class="n">metrics</span>
                <span class="k">elif</span> <span class="n">true</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">class_topred</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;true label </span><span class="si">{</span><span class="n">true</span><span class="si">}</span><span class="s2"> not in available classes&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">adata</span><span class="p">,</span> <span class="n">metrics</span>
                <span class="k">elif</span> <span class="n">true</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unknown_label</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># else true is unknown</span>
                <span class="c1"># else we pass</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># true was always unknown</span>
                <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doplot</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    &quot;</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     accuracy:&quot;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">cl</span> <span class="o">+</span> <span class="s2">&quot;_accuracy&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)})</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pred</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">adata</span><span class="p">,</span> <span class="n">metrics</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>


</div>


<div class="doc doc-object doc-function">


<h3 id="scprint2.tasks.cell_emb.compute_classification" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_classification</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute classification metrics for the given annotated data.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>adata</code></b>
                  (<code><span title="anndata.AnnData">AnnData</span></code>)
              –
              <div class="doc-md-description">
                <p>The annotated data matrix of shape n_obs x n_vars. Rows correspond to cells and columns to genes.</p>
              </div>
            </li>
            <li>
              <b><code>classes</code></b>
                  (<code><span title="typing.List">List</span>[<span title="str">str</span>]</code>)
              –
              <div class="doc-md-description">
                <p>List of class labels to be used for classification.</p>
              </div>
            </li>
            <li>
              <b><code>label_decoders</code></b>
                  (<code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Dictionary of label decoders for each class.</p>
              </div>
            </li>
            <li>
              <b><code>labels_hierarchy</code></b>
                  (<code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Dictionary representing the hierarchy of labels.</p>
              </div>
            </li>
            <li>
              <b><code>metric_type</code></b>
                  (<code><span title="typing.List">List</span>[<span title="str">str</span>]</code>, default:
                      <code>[&#39;macro&#39;, &#39;micro&#39;, &#39;weighted&#39;]</code>
)
              –
              <div class="doc-md-description">
                <p>List of metric types to compute. Defaults to ["macro", "micro", "weighted"].</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="float">float</span>]]</code>
              –
              <div class="doc-md-description">
                <p>Dict[str, Dict[str, float]]: A dictionary containing classification metrics for each class.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>scprint2/tasks/cell_emb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_classification</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span>
    <span class="n">classes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">label_decoders</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">labels_hierarchy</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">metric_type</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;macro&quot;</span><span class="p">,</span> <span class="s2">&quot;micro&quot;</span><span class="p">,</span> <span class="s2">&quot;weighted&quot;</span><span class="p">],</span>
    <span class="n">use_unknown</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute classification metrics for the given annotated data.</span>

<span class="sd">    Args:</span>
<span class="sd">        adata (AnnData): The annotated data matrix of shape n_obs x n_vars. Rows correspond to cells and columns to genes.</span>
<span class="sd">        classes (List[str]): List of class labels to be used for classification.</span>
<span class="sd">        label_decoders (Dict[str, Any]): Dictionary of label decoders for each class.</span>
<span class="sd">        labels_hierarchy (Dict[str, Any]): Dictionary representing the hierarchy of labels.</span>
<span class="sd">        metric_type (List[str], optional): List of metric types to compute. Defaults to [&quot;macro&quot;, &quot;micro&quot;, &quot;weighted&quot;].</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, Dict[str, float]]: A dictionary containing classification metrics for each class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">clss</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">clss</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;not in columns&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">labels_topred</span> <span class="o">=</span> <span class="n">label_decoders</span><span class="p">[</span><span class="n">clss</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">clss</span> <span class="ow">in</span> <span class="n">labels_hierarchy</span><span class="p">:</span>
            <span class="n">parentdf</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">bt</span><span class="o">.</span><span class="n">CellType</span><span class="o">.</span><span class="n">filter</span><span class="p">()</span>
                <span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span>
                    <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;parents__ontology_id&quot;</span><span class="p">,</span> <span class="s2">&quot;ontology_id&quot;</span><span class="p">],</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;ontology_id&quot;</span><span class="p">)[[</span><span class="s2">&quot;parents__ontology_id&quot;</span><span class="p">]]</span>
            <span class="p">)</span>
            <span class="n">parentdf</span><span class="o">.</span><span class="n">parents__ontology_id</span> <span class="o">=</span> <span class="n">parentdf</span><span class="o">.</span><span class="n">parents__ontology_id</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">class_groupings</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">get_descendants</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">parentdf</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">clss</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="p">}</span>
        <span class="n">tokeep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="n">adata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">true</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[[</span><span class="s2">&quot;pred_&quot;</span> <span class="o">+</span> <span class="n">clss</span><span class="p">,</span> <span class="n">clss</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pred</span> <span class="o">==</span> <span class="n">true</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">true</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">true</span> <span class="o">==</span> <span class="s2">&quot;unknown&quot;</span><span class="p">:</span>
                <span class="n">tokeep</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">clss</span> <span class="ow">in</span> <span class="n">labels_hierarchy</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">true</span> <span class="ow">in</span> <span class="n">class_groupings</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pred</span> <span class="o">==</span> <span class="s2">&quot;unknown&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">use_unknown</span><span class="p">:</span>
                        <span class="n">tokeep</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">true</span> <span class="k">if</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">class_groupings</span><span class="p">[</span><span class="n">true</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">true</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels_topred</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;true label </span><span class="si">{</span><span class="n">true</span><span class="si">}</span><span class="s2"> not in available classes&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">true</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels_topred</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;true label </span><span class="si">{</span><span class="n">true</span><span class="si">}</span><span class="s2"> not in available classes&quot;</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">clss</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">clss</span><span class="p">][</span><span class="s2">&quot;accuracy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">)[</span><span class="n">tokeep</span><span class="p">]</span> <span class="o">==</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">clss</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">tokeep</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">metric_type</span><span class="p">:</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">clss</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">)[</span><span class="n">tokeep</span><span class="p">],</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">clss</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">tokeep</span><span class="p">],</span> <span class="n">average</span><span class="o">=</span><span class="n">x</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">metrics</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="scprint2.tasks.cell_emb.compute_corr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_corr</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute the correlation between the output and target matrices.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>out</code></b>
                  (<code><span title="numpy.ndarray">ndarray</span></code>)
              –
              <div class="doc-md-description">
                <p>The output matrix.</p>
              </div>
            </li>
            <li>
              <b><code>to</code></b>
                  (<code><span title="numpy.ndarray">ndarray</span></code>)
              –
              <div class="doc-md-description">
                <p>The target matrix.</p>
              </div>
            </li>
            <li>
              <b><code>doplot</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to generate a plot of the correlation coefficients. Defaults to True.</p>
              </div>
            </li>
            <li>
              <b><code>compute_mean_regress</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to compute mean regression. Defaults to False.</p>
              </div>
            </li>
            <li>
              <b><code>plot_corr_size</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>64</code>
)
              –
              <div class="doc-md-description">
                <p>The size of the plot for correlation. Defaults to 64.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>dict</code></b>(                  <code><span title="dict">dict</span></code>
)              –
              <div class="doc-md-description">
                <p>A dictionary containing the computed metrics.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>scprint2/tasks/cell_emb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_corr</span><span class="p">(</span>
    <span class="n">out</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">to</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">doplot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">compute_mean_regress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">plot_corr_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the correlation between the output and target matrices.</span>

<span class="sd">    Args:</span>
<span class="sd">        out (np.ndarray): The output matrix.</span>
<span class="sd">        to (np.ndarray): The target matrix.</span>
<span class="sd">        doplot (bool, optional): Whether to generate a plot of the correlation coefficients. Defaults to True.</span>
<span class="sd">        compute_mean_regress (bool, optional): Whether to compute mean regression. Defaults to False.</span>
<span class="sd">        plot_corr_size (int, optional): The size of the plot for correlation. Defaults to 64.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the computed metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">corr_coef</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">spearmanr</span><span class="p">(</span>
        <span class="n">out</span><span class="p">,</span>
        <span class="n">to</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">corr_coef</span><span class="p">[</span><span class="n">p_value</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># corr_coef[]</span>
    <span class="c1"># only on non zero values,</span>
    <span class="c1"># compare a1-b1 corr with a1-b(n) corr. should be higher</span>

    <span class="c1"># Plot correlation coefficient</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">plot_corr_size</span> <span class="o">+</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">compute_mean_regress</span> <span class="k">else</span> <span class="n">plot_corr_size</span>
    <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;recons_corr&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">corr_coef</span><span class="p">[</span><span class="n">val</span><span class="p">:,</span> <span class="p">:</span><span class="n">plot_corr_size</span><span class="p">]</span><span class="o">.</span><span class="n">diagonal</span><span class="p">())}</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">compute_mean_regress</span><span class="p">:</span>
        <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;mean_regress&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="n">corr_coef</span><span class="p">[</span>
                        <span class="n">plot_corr_size</span> <span class="p">:</span> <span class="n">plot_corr_size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="p">:</span><span class="n">plot_corr_size</span><span class="p">,</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">doplot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">corr_coef</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Correlation Coefficient of expr and i[&quot;x&quot;]&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">metrics</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="scprint2.tasks.cell_emb.default_benchmark" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">default_benchmark</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Run the default benchmark for embedding and annotation using the scPRINT model.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>model</code></b>
                  (<code><span title="torch.nn.Module">Module</span></code>)
              –
              <div class="doc-md-description">
                <p>The scPRINT model to be used for embedding and annotation.</p>
              </div>
            </li>
            <li>
              <b><code>folder_dir</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code><span title="scprint2.tasks.cell_emb.FILE_LOC">FILE_LOC</span> + &#39;/../../data/&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>The directory containing data files.</p>
              </div>
            </li>
            <li>
              <b><code>dataset</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code><span title="scprint2.tasks.cell_emb.FILE_LOC">FILE_LOC</span> + &#39;/../../data/gNNpgpo6gATjuxTE7CCp.h5ad&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>The dataset to use for benchmarking. Can be a path or URL.</p>
              </div>
            </li>
            <li>
              <b><code>do_class</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to perform classification. Defaults to True.</p>
              </div>
            </li>
            <li>
              <b><code>coarse</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to use coarse cell type annotations. Defaults to False.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>dict</code></b>(                  <code><span title="dict">dict</span></code>
)              –
              <div class="doc-md-description">
                <p>A dictionary containing the benchmark metrics.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>scprint2/tasks/cell_emb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">default_benchmark</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
    <span class="n">folder_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">FILE_LOC</span> <span class="o">+</span> <span class="s2">&quot;/../../data/&quot;</span><span class="p">,</span>
    <span class="n">dataset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">FILE_LOC</span> <span class="o">+</span> <span class="s2">&quot;/../../data/gNNpgpo6gATjuxTE7CCp.h5ad&quot;</span><span class="p">,</span>
    <span class="n">do_class</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">coarse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the default benchmark for embedding and annotation using the scPRINT model.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (torch.nn.Module): The scPRINT model to be used for embedding and annotation.</span>
<span class="sd">        folder_dir (str, optional): The directory containing data files.</span>
<span class="sd">        dataset (str, optional): The dataset to use for benchmarking. Can be a path or URL.</span>
<span class="sd">        do_class (bool, optional): Whether to perform classification. Defaults to True.</span>
<span class="sd">        coarse (bool, optional): Whether to use coarse cell type annotations. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the benchmark metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;https://&quot;</span><span class="p">):</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
            <span class="n">folder_dir</span>
            <span class="o">+</span> <span class="n">dataset</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;.h5ad&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">dataset</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.h5ad&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="n">backup_url</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">adata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100_000</span><span class="p">:</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span>
            <span class="n">adata</span><span class="o">.</span><span class="n">obs_names</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">100_000</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
        <span class="p">]</span>
    <span class="n">max_len</span> <span class="o">=</span> <span class="mi">4000</span> <span class="k">if</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">50_000</span> <span class="k">else</span> <span class="mi">8000</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">64</span> <span class="k">if</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">50_000</span> <span class="k">else</span> <span class="mi">32</span>
    <span class="n">log_every</span> <span class="o">=</span> <span class="mi">10_000</span>
    <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;24539942&quot;</span><span class="p">,</span> <span class="s2">&quot;24539828&quot;</span><span class="p">]:</span>  <span class="c1"># lung and pancreas</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;organism_ontology_term_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NCBITaxon:9606&quot;</span>
        <span class="n">use_layer</span> <span class="o">=</span> <span class="s2">&quot;counts&quot;</span>
        <span class="n">is_symbol</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">batch_key</span> <span class="o">=</span> <span class="s2">&quot;tech&quot;</span> <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;24539828&quot;</span> <span class="k">else</span> <span class="s2">&quot;batch&quot;</span>
        <span class="n">label_key</span> <span class="o">=</span> <span class="s2">&quot;celltype&quot;</span> <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;24539828&quot;</span> <span class="k">else</span> <span class="s2">&quot;cell_type&quot;</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;cell_type_ontology_term_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">label_key</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="n">COARSE</span> <span class="k">if</span> <span class="n">coarse</span> <span class="k">else</span> <span class="n">FINE</span>
        <span class="p">)</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;assay_ontology_term_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">batch_key</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="n">COARSE</span> <span class="k">if</span> <span class="n">coarse</span> <span class="k">else</span> <span class="n">FINE</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">use_layer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">is_symbol</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">batch_key</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;batch&quot;</span>
            <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;661d5ec2-ca57-413c-8374-f49b0054ddba.h5ad&quot;</span>
            <span class="k">else</span> <span class="s2">&quot;assay_ontology_term_id&quot;</span>
        <span class="p">)</span>
        <span class="n">label_key</span> <span class="o">=</span> <span class="s2">&quot;cell_type_ontology_term_id&quot;</span>
    <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">Preprocessor</span><span class="p">(</span>
        <span class="n">use_layer</span><span class="o">=</span><span class="n">use_layer</span><span class="p">,</span>
        <span class="n">is_symbol</span><span class="o">=</span><span class="n">is_symbol</span><span class="p">,</span>
        <span class="n">force_preprocess</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">skip_validate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">do_postp</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span><span class="p">,</span>
        <span class="n">drop_non_primary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">adata</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span><span class="p">:</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">use_rep</span><span class="o">=</span><span class="s2">&quot;X_pca&quot;</span><span class="p">)</span>
    <span class="n">embedder</span> <span class="o">=</span> <span class="n">Embedder</span><span class="p">(</span>
        <span class="n">pred_embedding</span><span class="o">=</span><span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">pred_embedding</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">pred_embedding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span>
        <span class="p">),</span>
        <span class="n">doclass</span><span class="o">=</span><span class="n">do_class</span><span class="p">,</span>
        <span class="n">max_len</span><span class="o">=</span><span class="n">max_len</span><span class="p">,</span>
        <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">keep_all_labels_pred</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">save_every</span><span class="o">=</span><span class="n">log_every</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;random expr&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">adata</span><span class="p">,</span> <span class="n">metrics</span> <span class="o">=</span> <span class="n">embedder</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">adata</span><span class="p">)</span>

    <span class="n">bm</span> <span class="o">=</span> <span class="n">Benchmarker</span><span class="p">(</span>
        <span class="n">adata</span><span class="p">,</span>
        <span class="n">batch_key</span><span class="o">=</span><span class="n">batch_key</span><span class="p">,</span>
        <span class="n">label_key</span><span class="o">=</span><span class="n">label_key</span><span class="p">,</span>
        <span class="n">embedding_obsm_keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;scprint_emb&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">bm</span><span class="o">.</span><span class="n">benchmark</span><span class="p">()</span>
    <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;scib&quot;</span><span class="p">:</span> <span class="n">bm</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="n">min_max_scale</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">&quot;scprint_emb&quot;</span><span class="p">]}</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">class_scale</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;classif&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_classification</span><span class="p">(</span>
            <span class="n">adata</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">label_decoders</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">labels_hierarchy</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">metrics</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="scprint2.tasks.cell_emb.display_confusion_matrix" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">display_confusion_matrix</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Display the confusion matrix for true vs predicted cell types.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>nadata</code></b>
                  (<code><span title="anndata.AnnData">AnnData</span></code>)
              –
              <div class="doc-md-description">
                <p>Annotated data object containing predictions and ground truth.</p>
              </div>
            </li>
            <li>
              <b><code>pred</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>&#39;conv_pred_cell_type_ontology_term_id&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Column name for predictions. Defaults to "conv_pred_cell_type_ontology_term_id".</p>
              </div>
            </li>
            <li>
              <b><code>true</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>&#39;cell_type&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Column name for ground truth. Defaults to "cell_type".</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>scprint2/tasks/cell_emb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">display_confusion_matrix</span><span class="p">(</span>
    <span class="n">nadata</span><span class="p">,</span> <span class="n">pred</span><span class="o">=</span><span class="s2">&quot;conv_pred_cell_type_ontology_term_id&quot;</span><span class="p">,</span> <span class="n">true</span><span class="o">=</span><span class="s2">&quot;cell_type&quot;</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display the confusion matrix for true vs predicted cell types.</span>

<span class="sd">    Args:</span>
<span class="sd">        nadata (AnnData): Annotated data object containing predictions and ground truth.</span>
<span class="sd">        pred (str): Column name for predictions. Defaults to &quot;conv_pred_cell_type_ontology_term_id&quot;.</span>
<span class="sd">        true (str): Column name for ground truth. Defaults to &quot;cell_type&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nadata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">true</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">counts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">nadata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">nadata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">true</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">,</span>
                    <span class="n">pred</span><span class="p">,</span>
                <span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
            <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">counts</span><span class="p">,</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                        <span class="n">nadata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                            <span class="n">nadata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">true</span><span class="p">]</span> <span class="o">==</span> <span class="n">k</span><span class="p">,</span>
                            <span class="n">pred</span><span class="p">,</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(),</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">}),</span>
                <span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">T</span>
    <span class="c1"># Fill NaN values with 0 for visualization</span>
    <span class="n">counts_filled</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Create the heatmap</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

    <span class="c1"># Convert to percentages (row-wise normalization)</span>
    <span class="n">counts_percentage</span> <span class="o">=</span> <span class="n">counts_filled</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">counts_filled</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">counts_percentage</span> <span class="o">=</span> <span class="n">counts_percentage</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">counts_percentage</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">]</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
        <span class="n">counts_percentage</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">,</span>
        <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Percentage (%)&quot;</span><span class="p">},</span>
        <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># place the x-label on top</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">tick_top</span><span class="p">()</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
        <span class="s2">&quot;Confusion Matrix: &quot;</span> <span class="o">+</span> <span class="n">true</span> <span class="o">+</span> <span class="s2">&quot; vs &quot;</span> <span class="o">+</span> <span class="n">pred</span> <span class="o">+</span> <span class="s2">&quot; (Percentage)&quot;</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
        <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">true</span> <span class="o">+</span> <span class="s2">&quot; (with counts)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="scprint2.tasks.grn" class="doc doc-heading">
            <code>scprint2.tasks.grn</code>


</h2>

    <div class="doc doc-contents first">










<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="GNInfer (scprint2.tasks.grn.GNInfer)" href="#scprint2.tasks.grn.GNInfer">GNInfer</a></code></td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>




<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="default_benchmark (scprint2.tasks.grn.default_benchmark)" href="#scprint2.tasks.grn.default_benchmark">default_benchmark</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>default_benchmark function to run the default scPRINT GRN benchmark</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>





<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="scprint2.tasks.grn.GNInfer" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">GNInfer</span></code>

</h3>


    <div class="doc doc-contents ">



        <p>GNInfer a class to infer gene regulatory networks from a dataset using a scPRINT model.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>batch_size</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>64</code>
)
              –
              <div class="doc-md-description">
                <p>Batch size for processing. Defaults to 64.</p>
              </div>
            </li>
            <li>
              <b><code>num_workers</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>8</code>
)
              –
              <div class="doc-md-description">
                <p>Number of workers for data loading. Defaults to 8.</p>
              </div>
            </li>
            <li>
              <b><code>drop_unexpressed</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to drop unexpressed genes. Defaults to True.
In this context, genes that have no expression in the dataset are dropped.</p>
              </div>
            </li>
            <li>
              <b><code>num_genes</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>3000</code>
)
              –
              <div class="doc-md-description">
                <p>Number of genes to consider. Defaults to 3000.</p>
              </div>
            </li>
            <li>
              <b><code>max_cells</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>0</code>
)
              –
              <div class="doc-md-description">
                <p>Maximum number of cells to consider. Defaults to 0.
if less than total number of cells, only the top <code>max_cells</code> cells with the most counts will be considered.</p>
              </div>
            </li>
            <li>
              <b><code>cell_type_col</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>&#39;cell_type&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Column name for cell type information. Defaults to "cell_type".</p>
              </div>
            </li>
            <li>
              <b><code>how</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>&#39;most var within&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Method to select genes. Options are "most var", "random expr", "some". Defaults to "most var".
- "most var across": select the most variable genes across all cell types
- "most var within": select the most variable genes within a cell type
- "random expr": select random expressed genes
- "some": select a subset of genes defined in genelist
- "most expr": select the most expressed genes in the cell type</p>
              </div>
            </li>
            <li>
              <b><code>genelist</code></b>
                  (<code><span title="list">list</span></code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>List of genes to consider. Defaults to an empty list.</p>
              </div>
            </li>
            <li>
              <b><code>layer</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="int">int</span>]]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>List of layers to use for the inference. Defaults to None.</p>
              </div>
            </li>
            <li>
              <b><code>preprocess</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>&#39;softmax&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Preprocessing method. Options are "softmax", "sinkhorn", "none". Defaults to "softmax".</p>
              </div>
            </li>
            <li>
              <b><code>head_agg</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>&#39;mean&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Aggregation method for heads. Options are "mean_full", "mean", "sum", "none". Defaults to "mean".</p>
              </div>
            </li>
            <li>
              <b><code>filtration</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>&#39;thresh&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Filtration method for the adjacency matrix. Options are "thresh", "top-k", "mst", "known", "none". Defaults to "thresh".</p>
              </div>
            </li>
            <li>
              <b><code>k</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>10</code>
)
              –
              <div class="doc-md-description">
                <p>Number of top connections to keep if filtration is "top-k". Defaults to 10.</p>
              </div>
            </li>
            <li>
              <b><code>known_grn</code></b>
                  (<code><span title="optional">optional</span></code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Known gene regulatory network to use as a reference. Defaults to None.
- We will only keep the genes that are present in the known GRN.</p>
              </div>
            </li>
            <li>
              <b><code>precomp_attn</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to let the model precompute attn or do it at the end.
This takes more memory but the model can compute mean over the attention matrices instead
of over the qs and ks then taking the product.
It is required for mean_full head_agg. Defaults to False.</p>
              </div>
            </li>
            <li>
              <b><code>symmetrize</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to GRN. Defaults to False.</p>
              </div>
            </li>
            <li>
              <b><code>loc</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>&#39;./&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Location to save results. Defaults to "./".</p>
              </div>
            </li>
            <li>
              <b><code>use_knn</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to use k-nearest neighbors information. Defaults to True.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>










<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="__call__ (scprint2.tasks.grn.GNInfer.__call__)" href="#scprint2.tasks.grn.GNInfer.__call__">__call__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p><strong>call</strong> runs the method</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="aggregate (scprint2.tasks.grn.GNInfer.aggregate)" href="#scprint2.tasks.grn.GNInfer.aggregate">aggregate</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>part to aggregate the qks and compute the attns</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="filter (scprint2.tasks.grn.GNInfer.filter)" href="#scprint2.tasks.grn.GNInfer.filter">filter</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>part to filter the attn matrix given user inputs</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="predict (scprint2.tasks.grn.GNInfer.predict)" href="#scprint2.tasks.grn.GNInfer.predict">predict</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>part to predict the qks or attns matrices from the adata with the model</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>



                  <details class="quote">
                    <summary>Source code in <code>scprint2/tasks/grn.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">drop_unexpressed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">num_genes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">,</span>
    <span class="n">max_cells</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">cell_type_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_type&quot;</span><span class="p">,</span>
    <span class="n">how</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;most var within&quot;</span><span class="p">,</span>  <span class="c1"># random expr, most var within, most var across, some</span>
    <span class="n">genelist</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">layer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">preprocess</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;softmax&quot;</span><span class="p">,</span>  <span class="c1"># sinkhorn, softmax, none</span>
    <span class="n">head_agg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>  <span class="c1"># mean, sum, none, mean_full</span>
    <span class="n">filtration</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;thresh&quot;</span><span class="p">,</span>  <span class="c1"># thresh, top-k, mst, known, none</span>
    <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">known_grn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">precomp_attn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">symmetrize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">loc</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span><span class="p">,</span>
    <span class="n">use_knn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GNInfer a class to infer gene regulatory networks from a dataset using a scPRINT model.</span>

<span class="sd">    Args:</span>
<span class="sd">        batch_size (int, optional): Batch size for processing. Defaults to 64.</span>
<span class="sd">        num_workers (int, optional): Number of workers for data loading. Defaults to 8.</span>
<span class="sd">        drop_unexpressed (bool, optional): Whether to drop unexpressed genes. Defaults to True.</span>
<span class="sd">            In this context, genes that have no expression in the dataset are dropped.</span>
<span class="sd">        num_genes (int, optional): Number of genes to consider. Defaults to 3000.</span>
<span class="sd">        max_cells (int, optional): Maximum number of cells to consider. Defaults to 0.</span>
<span class="sd">            if less than total number of cells, only the top `max_cells` cells with the most counts will be considered.</span>
<span class="sd">        cell_type_col (str, optional): Column name for cell type information. Defaults to &quot;cell_type&quot;.</span>
<span class="sd">        how (str, optional): Method to select genes. Options are &quot;most var&quot;, &quot;random expr&quot;, &quot;some&quot;. Defaults to &quot;most var&quot;.</span>
<span class="sd">            - &quot;most var across&quot;: select the most variable genes across all cell types</span>
<span class="sd">            - &quot;most var within&quot;: select the most variable genes within a cell type</span>
<span class="sd">            - &quot;random expr&quot;: select random expressed genes</span>
<span class="sd">            - &quot;some&quot;: select a subset of genes defined in genelist</span>
<span class="sd">            - &quot;most expr&quot;: select the most expressed genes in the cell type</span>
<span class="sd">        genelist (list, optional): List of genes to consider. Defaults to an empty list.</span>
<span class="sd">        layer (Optional[List[int]], optional): List of layers to use for the inference. Defaults to None.</span>
<span class="sd">        preprocess (str, optional): Preprocessing method. Options are &quot;softmax&quot;, &quot;sinkhorn&quot;, &quot;none&quot;. Defaults to &quot;softmax&quot;.</span>
<span class="sd">        head_agg (str, optional): Aggregation method for heads. Options are &quot;mean_full&quot;, &quot;mean&quot;, &quot;sum&quot;, &quot;none&quot;. Defaults to &quot;mean&quot;.</span>
<span class="sd">        filtration (str, optional): Filtration method for the adjacency matrix. Options are &quot;thresh&quot;, &quot;top-k&quot;, &quot;mst&quot;, &quot;known&quot;, &quot;none&quot;. Defaults to &quot;thresh&quot;.</span>
<span class="sd">        k (int, optional): Number of top connections to keep if filtration is &quot;top-k&quot;. Defaults to 10.</span>
<span class="sd">        known_grn (optional): Known gene regulatory network to use as a reference. Defaults to None.</span>
<span class="sd">            - We will only keep the genes that are present in the known GRN.</span>
<span class="sd">        precomp_attn (bool, optional): Whether to let the model precompute attn or do it at the end.</span>
<span class="sd">            This takes more memory but the model can compute mean over the attention matrices instead</span>
<span class="sd">            of over the qs and ks then taking the product.</span>
<span class="sd">            It is required for mean_full head_agg. Defaults to False.</span>
<span class="sd">        symmetrize (bool, optional): Whether to GRN. Defaults to False.</span>
<span class="sd">        loc (str, optional): Location to save results. Defaults to &quot;./&quot;.</span>
<span class="sd">        use_knn (bool, optional): Whether to use k-nearest neighbors information. Defaults to True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="o">=</span> <span class="n">num_workers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="n">layer</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loc</span> <span class="o">=</span> <span class="n">loc</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">=</span> <span class="n">how</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s2">&quot;most var within&quot;</span><span class="p">,</span>
        <span class="s2">&quot;most var across&quot;</span><span class="p">,</span>
        <span class="s2">&quot;random expr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;some&quot;</span><span class="p">,</span>
        <span class="s2">&quot;most expr&quot;</span><span class="p">,</span>
    <span class="p">],</span> <span class="s2">&quot;how must be one of &#39;most var within&#39;, &#39;most var across&#39;, &#39;random expr&#39;, &#39;some&#39;, &#39;most expr&#39;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_genes</span> <span class="o">=</span> <span class="n">num_genes</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">!=</span> <span class="s2">&quot;some&quot;</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genelist</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span> <span class="o">=</span> <span class="n">preprocess</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cell_type_col</span> <span class="o">=</span> <span class="n">cell_type_col</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">filtration</span> <span class="o">=</span> <span class="n">filtration</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">genelist</span> <span class="o">=</span> <span class="n">genelist</span> <span class="k">if</span> <span class="n">genelist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize</span> <span class="o">=</span> <span class="n">symmetrize</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">known_grn</span> <span class="o">=</span> <span class="n">known_grn</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">head_agg</span> <span class="o">=</span> <span class="n">head_agg</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_cells</span> <span class="o">=</span> <span class="n">max_cells</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">drop_unexpressed</span> <span class="o">=</span> <span class="n">drop_unexpressed</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_knn</span> <span class="o">=</span> <span class="n">use_knn</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtration</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_agg</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;filtration must be &#39;none&#39; when head_agg is &#39;none&#39;&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="scprint2.tasks.grn.GNInfer.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__call__</span></code>

</h4>


    <div class="doc doc-contents ">

        <p><strong>call</strong> runs the method</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>model</code></b>
                  (<code><span title="torch.nn.Module">Module</span></code>)
              –
              <div class="doc-md-description">
                <p>The model to be used for generating the network</p>
              </div>
            </li>
            <li>
              <b><code>adata</code></b>
                  (<code><span title="anndata.AnnData">AnnData</span></code>)
              –
              <div class="doc-md-description">
                <p>Annotated data matrix of shape <code>n_obs</code> × <code>n_vars</code>. <code>n_obs</code> is the number of cells and <code>n_vars</code> is the number of genes.</p>
              </div>
            </li>
            <li>
              <b><code>cell_type</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Specific cell type to filter the data. Defaults to None.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>AnnData</code></b>(                  <code><span title="anndata.AnnData">AnnData</span></code>
)              –
              <div class="doc-md-description">
                <p>Annotated data matrix with predictions and annotations.</p>
              </div>
            </li>
            <li>
                  <code><span title="numpy.ndarray">ndarray</span></code>
              –
              <div class="doc-md-description">
                <p>np.ndarray: Filtered adjacency matrix.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>scprint2/tasks/grn.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span> <span class="n">cell_type</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">AnnData</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    __call__ runs the method</span>

<span class="sd">    Args:</span>
<span class="sd">        model (torch.nn.Module): The model to be used for generating the network</span>
<span class="sd">        adata (AnnData): Annotated data matrix of shape `n_obs` × `n_vars`. `n_obs` is the number of cells and `n_vars` is the number of genes.</span>
<span class="sd">        cell_type (str, optional): Specific cell type to filter the data. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        AnnData: Annotated data matrix with predictions and annotations.</span>
<span class="sd">        np.ndarray: Filtered adjacency matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Add at least the organism you are working with</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">nlayers</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">n_cell_embs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">additional_tokens</span>
    <span class="n">subadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">adata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">)</span>
    <span class="n">adjacencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_agg</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
            <span class="n">adjacencies</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cell_embs</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cell_embs</span> <span class="p">:,</span> <span class="p">:],</span>
            <span class="n">subadata</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">adjacencies</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cell_embs</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cell_embs</span> <span class="p">:],</span>
            <span class="n">subadata</span><span class="p">,</span>
            <span class="n">loc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loc</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="scprint2.tasks.grn.GNInfer.aggregate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggregate</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>part to aggregate the qks and compute the attns
or to aggregate the attns
or do nothing if already done</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>scprint2/tasks/grn.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    part to aggregate the qks and compute the attns</span>
<span class="sd">    or to aggregate the attns</span>
<span class="sd">    or do nothing if already done</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">attn</span><span class="p">,</span> <span class="n">genes</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">model</span><span class="o">.</span><span class="n">genes</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">precomp_attn</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">genes</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">attn</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;random expr&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_unexpressed</span><span class="p">:</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cell_embs</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">genes</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">attn</span> <span class="o">=</span> <span class="n">attn</span><span class="p">[:,</span> <span class="n">keep</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">badloc</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">attn</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span>
    <span class="n">attn</span> <span class="o">=</span> <span class="n">attn</span><span class="p">[:,</span> <span class="o">~</span><span class="n">badloc</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">badloc</span> <span class="o">=</span> <span class="n">badloc</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span><span class="p">)[</span><span class="o">~</span><span class="n">badloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cell_embs</span> <span class="p">:]]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;random expr&quot;</span>
        <span class="k">else</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">genes</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="c1"># attn = attn[:, :, 0, :, :].permute(0, 2, 1, 3) @ attn[:, :, 1, :, :].permute(</span>
    <span class="c1">#    0, 2, 3, 1</span>
    <span class="c1"># )</span>
    <span class="n">attns</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">Qs</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">attn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">attn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">attn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="n">Ks</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">attn</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">attn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">attn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Qs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">attn</span> <span class="o">=</span> <span class="n">Qs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">@</span> <span class="n">Ks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># return attn</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span> <span class="o">==</span> <span class="s2">&quot;sinkhorn&quot;</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">Qs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="o">-</span><span class="mf">0.5</span>
            <span class="n">attn</span> <span class="o">=</span> <span class="n">attn</span> <span class="o">*</span> <span class="n">scale</span>
            <span class="k">if</span> <span class="n">attn</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">100_000_000</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;you can&#39;t sinkhorn such a large matrix&quot;</span><span class="p">)</span>
            <span class="n">sink</span> <span class="o">=</span> <span class="n">SinkhornDistance</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
            <span class="n">attn</span> <span class="o">=</span> <span class="n">sink</span><span class="p">(</span><span class="n">attn</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">attn</span> <span class="o">=</span> <span class="n">attn</span> <span class="o">*</span> <span class="n">Qs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span> <span class="o">==</span> <span class="s2">&quot;softmax&quot;</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">Qs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="o">-</span><span class="mf">0.5</span>
            <span class="n">attn</span> <span class="o">=</span> <span class="n">attn</span> <span class="o">*</span> <span class="n">scale</span>
            <span class="n">attn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">attn</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span> <span class="o">==</span> <span class="s2">&quot;softpick&quot;</span><span class="p">:</span>
            <span class="n">attn</span> <span class="o">=</span> <span class="n">softpick</span><span class="p">(</span><span class="n">attn</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;preprocess must be one of &#39;sinkhorn&#39;, &#39;softmax&#39;, &#39;none&#39;&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize</span><span class="p">:</span>
            <span class="n">attn</span> <span class="o">=</span> <span class="p">(</span><span class="n">attn</span> <span class="o">+</span> <span class="n">attn</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_agg</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">attns</span> <span class="o">=</span> <span class="n">attn</span> <span class="o">+</span> <span class="p">(</span><span class="n">attns</span> <span class="k">if</span> <span class="n">attns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_agg</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
            <span class="n">attns</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">attn</span><span class="p">,</span> <span class="n">attns</span><span class="p">)</span> <span class="k">if</span> <span class="n">attns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">attn</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_agg</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="n">attn</span> <span class="o">=</span> <span class="n">attn</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">attn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">attn</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">attns</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">attns</span><span class="p">,</span> <span class="n">attn</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">attns</span> <span class="o">=</span> <span class="n">attn</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;head_agg must be one of &#39;mean&#39;, &#39;mean_full&#39;, &#39;max&#39; or &#39;none&#39;&quot;</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_agg</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
        <span class="n">attns</span> <span class="o">=</span> <span class="n">attns</span> <span class="o">/</span> <span class="n">Qs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">attns</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_agg</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span> <span class="k">else</span> <span class="n">attns</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="scprint2.tasks.grn.GNInfer.filter" class="doc doc-heading">
            <code class="highlight language-python"><span class="nb">filter</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>part to filter the attn matrix given user inputs</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>scprint2/tasks/grn.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adj</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    part to filter the attn matrix given user inputs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtration</span> <span class="o">==</span> <span class="s2">&quot;thresh&quot;</span><span class="p">:</span>
        <span class="n">adj</span><span class="p">[</span><span class="n">adj</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">adj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">adj</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">/</span> <span class="n">adj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="n">adj</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">adj</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtration</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtration</span> <span class="o">==</span> <span class="s2">&quot;top-k&quot;</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">adj</span><span class="p">)</span>
        <span class="n">adj</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">adj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">args</span><span class="p">[:,</span> <span class="p">:</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">adj</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">adj</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtration</span> <span class="o">==</span> <span class="s2">&quot;known&quot;</span> <span class="ow">and</span> <span class="n">gt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gt</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">gt</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">gt</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">gt</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">gt</span> <span class="o">=</span> <span class="n">gt</span><span class="p">[</span><span class="n">gt</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span><span class="p">)]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span>
            <span class="p">:,</span> <span class="n">gt</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span><span class="p">,</span> <span class="n">gt</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span><span class="p">)[</span><span class="n">loc</span><span class="p">]</span>
        <span class="n">adj</span> <span class="o">=</span> <span class="n">adj</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cell_embs</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_cell_embs</span> <span class="p">:][</span><span class="n">loc</span><span class="p">][:,</span> <span class="n">loc</span><span class="p">]</span>
        <span class="n">adj</span><span class="p">[</span><span class="n">gt</span><span class="o">.</span><span class="n">values</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">adj</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">adj</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtration</span> <span class="o">==</span> <span class="s2">&quot;tmfg&quot;</span><span class="p">:</span>
        <span class="n">adj</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">to_scipy_sparse_array</span><span class="p">(</span><span class="n">tmfg</span><span class="p">(</span><span class="n">adj</span><span class="p">))</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtration</span> <span class="o">==</span> <span class="s2">&quot;mst&quot;</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;filtration must be one of &#39;thresh&#39;, &#39;none&#39; or &#39;top-k&#39;&quot;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">adj</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtration</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span> <span class="k">else</span> <span class="n">adj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;avg link count: </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s2">, sparsity: </span><span class="si">{</span><span class="n">res</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">adj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">adj</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="scprint2.tasks.grn.GNInfer.predict" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">predict</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>part to predict the qks or attns matrices from the adata with the model</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>scprint2/tasks/grn.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">adata</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">cell_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    part to predict the qks or attns matrices from the adata with the model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">model</span><span class="o">.</span><span class="n">pred_log_adata</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">cell_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subadata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_type_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell_type</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subadata</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;most var within&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">highly_variable_genes</span><span class="p">(</span>
                <span class="n">subadata</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s2">&quot;seurat_v3&quot;</span><span class="p">,</span> <span class="n">n_top_genes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_genes</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">highly_variable_genes</span><span class="p">(</span>
                <span class="n">subadata</span><span class="p">,</span>
                <span class="n">flavor</span><span class="o">=</span><span class="s2">&quot;seurat_v3&quot;</span><span class="p">,</span>
                <span class="n">n_top_genes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_genes</span><span class="p">,</span>
                <span class="n">span</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">subadata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">subadata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">highly_variable</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">genelist</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;number of expressed genes in this cell type: &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">((</span><span class="n">subadata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;most var across&quot;</span> <span class="ow">and</span> <span class="n">cell_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="n">adata</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">rank_genes_groups</span><span class="p">(</span>
            <span class="n">adata</span><span class="p">,</span>
            <span class="n">mask_var</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">genes</span><span class="p">),</span>
            <span class="n">groupby</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_type_col</span><span class="p">,</span>
            <span class="n">groups</span><span class="o">=</span><span class="p">[</span><span class="n">cell_type</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">diff_expr_genes</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;rank_genes_groups&quot;</span><span class="p">][</span><span class="s2">&quot;names&quot;</span><span class="p">][</span><span class="n">cell_type</span><span class="p">]</span>
        <span class="n">diff_expr_genes</span> <span class="o">=</span> <span class="p">[</span><span class="n">gene</span> <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">diff_expr_genes</span> <span class="k">if</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">genes</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span> <span class="o">=</span> <span class="n">diff_expr_genes</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_genes</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">genelist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;random expr&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">genes</span>
        <span class="c1"># raise ValueError(&quot;cannot do it yet&quot;)</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;some&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genelist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">genelist</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;most expr&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">[</span>
            <span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">A1</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_genes</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;something wrong with your inputs&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_unexpressed</span><span class="p">:</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">subadata</span><span class="o">.</span><span class="n">var</span><span class="p">[(</span><span class="n">subadata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">]</span>
    <span class="c1"># Order cells by total count</span>
    <span class="n">cell_sums</span> <span class="o">=</span> <span class="n">subadata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span>
        <span class="o">-</span><span class="n">cell_sums</span><span class="o">.</span><span class="n">A1</span> <span class="k">if</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">subadata</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="k">else</span> <span class="o">-</span><span class="n">cell_sums</span>
    <span class="p">)</span>
    <span class="n">subadata</span> <span class="o">=</span> <span class="n">subadata</span><span class="p">[</span><span class="n">order</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">subadata</span> <span class="o">=</span> <span class="n">subadata</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cells</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cells</span> <span class="k">else</span> <span class="n">subadata</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subadata</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;no cells in the dataset&quot;</span><span class="p">)</span>
    <span class="n">adataset</span> <span class="o">=</span> <span class="n">SimpleAnnDataset</span><span class="p">(</span>
        <span class="n">subadata</span><span class="p">,</span>
        <span class="n">obs_to_output</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;organism_ontology_term_id&quot;</span><span class="p">],</span>
        <span class="n">get_knn_cells</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_knn</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">Collator</span><span class="p">(</span>
        <span class="n">organisms</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">organisms</span><span class="p">,</span>
        <span class="n">valid_genes</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">genes</span><span class="p">,</span>
        <span class="n">max_len</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_genes</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;random expr&quot;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;some&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">!=</span> <span class="s2">&quot;random expr&quot;</span> <span class="k">else</span> <span class="s2">&quot;random expr&quot;</span><span class="p">,</span>
        <span class="n">genelist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">!=</span> <span class="s2">&quot;random expr&quot;</span> <span class="k">else</span> <span class="p">[],</span>
        <span class="n">n_bins</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">n_input_bins</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;binned&quot;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
        <span class="n">adataset</span><span class="p">,</span>
        <span class="n">collate_fn</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">precomp_attn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_agg</span> <span class="o">==</span> <span class="s2">&quot;mean_full&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_genes</span> <span class="o">&gt;</span> <span class="mi">10_000</span> <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">precomp_attn</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;need less genes for a non-shared-qk version&quot;</span><span class="p">)</span>
    <span class="n">prevplot</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">doplot</span>

    <span class="n">model</span><span class="o">.</span><span class="n">doplot</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">model</span><span class="o">.</span><span class="n">on_predict_epoch_start</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># reparametrize the attn process</span>

    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">attn_type</span> <span class="o">==</span> <span class="s2">&quot;hyper&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">genes</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span><span class="p">]</span>
        <span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_metacell_token</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">classes</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">cell_transformer</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span><span class="p">)</span> <span class="o">+</span> <span class="n">num</span><span class="p">)</span> <span class="o">%</span> <span class="mi">128</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span><span class="p">[</span>
                <span class="p">:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span><span class="p">)</span> <span class="o">//</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">128</span><span class="p">)</span> <span class="o">-</span> <span class="n">num</span>
            <span class="p">]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">!=</span> <span class="s2">&quot;random expr&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">precomp_attn</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">gene_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">genes</span><span class="p">))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">apply_softmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span> <span class="o">==</span> <span class="s2">&quot;softmax&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">subadata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;organism_ontology_term_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;only one organism at a time is supported for precomp_attn&quot;</span>
                <span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">start_idx</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">n</span><span class="p">:</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">gene_dim</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="n">model</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">speciesloc</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">subadata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;organism_ontology_term_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">speciesloc</span> <span class="o">=</span> <span class="n">k</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">precomp_attn</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;full attention (i.e. precomp_attn=True) is not supported for random expr&quot;</span>
        <span class="p">)</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">float16</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">transformer</span><span class="p">,</span> <span class="n">FlashTransformer</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">model</span><span class="o">.</span><span class="n">dtype</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
            <span class="n">gene_pos</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;genes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span>
                <span class="n">gene_pos</span><span class="p">,</span>
                <span class="n">expression</span><span class="p">,</span>
                <span class="n">depth</span><span class="p">,</span>
                <span class="n">knn_cells</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;knn_cells&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_knn</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">),</span>
                <span class="n">knn_cells_info</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;knn_cells_info&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_knn</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">),</span>
                <span class="n">keep_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">get_attention_layer</span><span class="o">=</span><span class="n">layer</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="k">else</span> <span class="p">[</span><span class="n">layer</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">doplot</span> <span class="o">=</span> <span class="n">prevplot</span>
    <span class="k">return</span> <span class="n">subadata</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>


</div>


<div class="doc doc-object doc-function">


<h3 id="scprint2.tasks.grn.default_benchmark" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">default_benchmark</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>default_benchmark function to run the default scPRINT GRN benchmark</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>model</code></b>
                  (<code><span title="typing.Any">Any</span></code>)
              –
              <div class="doc-md-description">
                <p>The scPRINT model to be used for the benchmark.</p>
              </div>
            </li>
            <li>
              <b><code>default_dataset</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>&#39;sroy&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>The default dataset to use for benchmarking. Defaults to "sroy".</p>
              </div>
            </li>
            <li>
              <b><code>cell_types</code></b>
                  (<code><span title="typing.List">List</span>[<span title="str">str</span>]</code>, default:
                      <code>[]</code>
)
              –
              <div class="doc-md-description">
                <p>List of cell types to include in the benchmark. Defaults to [].</p>
              </div>
            </li>
            <li>
              <b><code>maxlayers</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>16</code>
)
              –
              <div class="doc-md-description">
                <p>Maximum number of layers to use from the model. Defaults to 16.</p>
              </div>
            </li>
            <li>
              <b><code>maxgenes</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>5000</code>
)
              –
              <div class="doc-md-description">
                <p>Maximum number of genes to consider. Defaults to 5000.</p>
              </div>
            </li>
            <li>
              <b><code>batch_size</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>32</code>
)
              –
              <div class="doc-md-description">
                <p>Batch size for processing. Defaults to 32.</p>
              </div>
            </li>
            <li>
              <b><code>maxcells</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>1024</code>
)
              –
              <div class="doc-md-description">
                <p>Maximum number of cells to consider. Defaults to 1024.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>dict</code></b>(                  <code><span title="dict">dict</span></code>
)              –
              <div class="doc-md-description">
                <p>A dictionary containing the benchmark metrics.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>scprint2/tasks/grn.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">default_benchmark</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">default_dataset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sroy&quot;</span><span class="p">,</span>
    <span class="n">cell_types</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">maxlayers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
    <span class="n">maxgenes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
    <span class="n">maxcells</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    default_benchmark function to run the default scPRINT GRN benchmark</span>

<span class="sd">    Args:</span>
<span class="sd">        model (Any): The scPRINT model to be used for the benchmark.</span>
<span class="sd">        default_dataset (str, optional): The default dataset to use for benchmarking. Defaults to &quot;sroy&quot;.</span>
<span class="sd">        cell_types (List[str], optional): List of cell types to include in the benchmark. Defaults to [].</span>
<span class="sd">        maxlayers (int, optional): Maximum number of layers to use from the model. Defaults to 16.</span>
<span class="sd">        maxgenes (int, optional): Maximum number of genes to consider. Defaults to 5000.</span>
<span class="sd">        batch_size (int, optional): Batch size for processing. Defaults to 32.</span>
<span class="sd">        maxcells (int, optional): Maximum number of cells to consider. Defaults to 1024.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the benchmark metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">nlayers</span><span class="p">))[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">nlayers</span> <span class="o">-</span> <span class="n">maxlayers</span><span class="p">)</span> <span class="p">:]</span>
    <span class="n">clf_omni</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">default_dataset</span> <span class="o">==</span> <span class="s2">&quot;sroy&quot;</span><span class="p">:</span>
        <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">Preprocessor</span><span class="p">(</span>
            <span class="n">is_symbol</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">force_preprocess</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">skip_validate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">do_postp</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span><span class="p">,</span>
            <span class="n">min_valid_genes_id</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
            <span class="n">min_dataset_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
            <span class="n">keepdata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">clf_self</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">todo</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;han&quot;</span><span class="p">,</span> <span class="s2">&quot;human&quot;</span><span class="p">,</span> <span class="s2">&quot;full&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;mine&quot;</span><span class="p">,</span> <span class="s2">&quot;human&quot;</span><span class="p">,</span> <span class="s2">&quot;full&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;han&quot;</span><span class="p">,</span> <span class="s2">&quot;human&quot;</span><span class="p">,</span> <span class="s2">&quot;chip&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;han&quot;</span><span class="p">,</span> <span class="s2">&quot;human&quot;</span><span class="p">,</span> <span class="s2">&quot;ko&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tran&quot;</span><span class="p">,</span> <span class="s2">&quot;mouse&quot;</span><span class="p">,</span> <span class="s2">&quot;full&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;zhao&quot;</span><span class="p">,</span> <span class="s2">&quot;mouse&quot;</span><span class="p">,</span> <span class="s2">&quot;full&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tran&quot;</span><span class="p">,</span> <span class="s2">&quot;mouse&quot;</span><span class="p">,</span> <span class="s2">&quot;chip&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tran&quot;</span><span class="p">,</span> <span class="s2">&quot;mouse&quot;</span><span class="p">,</span> <span class="s2">&quot;ko&quot;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">da</span><span class="p">,</span> <span class="n">spe</span><span class="p">,</span> <span class="n">gt</span> <span class="ow">in</span> <span class="n">todo</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">gt</span> <span class="o">!=</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s2">&quot;NCBITaxon:10090&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">organisms</span> <span class="ow">and</span> <span class="n">spe</span> <span class="o">==</span> <span class="s2">&quot;mouse&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">gt</span><span class="p">)</span>
            <span class="n">preadata</span> <span class="o">=</span> <span class="n">get_sroy_gt</span><span class="p">(</span><span class="n">get</span><span class="o">=</span><span class="n">da</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">spe</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="n">gt</span><span class="p">)</span>
            <span class="n">adata</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="p">(</span><span class="n">preadata</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span><span class="p">:</span>
                <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">use_rep</span><span class="o">=</span><span class="s2">&quot;X_pca&quot;</span><span class="p">)</span>
            <span class="n">grn_inferer</span> <span class="o">=</span> <span class="n">GNInfer</span><span class="p">(</span>
                <span class="n">layer</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;most var within&quot;</span><span class="p">,</span>
                <span class="n">preprocess</span><span class="o">=</span><span class="p">(</span>
                    <span class="s2">&quot;softpick&quot;</span>
                    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">attention</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;softpick&quot;</span><span class="p">,</span> <span class="s2">&quot;softpick-flash&quot;</span><span class="p">]</span>
                    <span class="k">else</span> <span class="s2">&quot;softmax&quot;</span>
                <span class="p">),</span>
                <span class="n">head_agg</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                <span class="n">filtration</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                <span class="n">num_genes</span><span class="o">=</span><span class="n">maxgenes</span><span class="p">,</span>
                <span class="n">num_workers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                <span class="n">max_cells</span><span class="o">=</span><span class="n">maxcells</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">grn</span> <span class="o">=</span> <span class="n">grn_inferer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">adata</span><span class="p">)</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;ensembl_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_index_unique</span><span class="p">(</span><span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;mean_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">gt</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">preadata</span><span class="p">)</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="k">if</span> <span class="n">spe</span> <span class="o">==</span> <span class="s2">&quot;human&quot;</span><span class="p">:</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;mean_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">gt</span> <span class="o">+</span> <span class="s2">&quot;_base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span><span class="o">.</span><span class="n">scprint_benchmark</span><span class="p">()</span>

            <span class="c1">## OMNI</span>
            <span class="k">if</span> <span class="n">clf_omni</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">clf_omni</span> <span class="o">=</span> <span class="n">train_classifier</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span>
                    <span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">train_size</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                    <span class="n">class_weight</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">return_full</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">clf_omni</span><span class="p">,</span> <span class="s2">&quot;clf_omni.pkl&quot;</span><span class="p">)</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;omni_classifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="n">clf_omni</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">clf_omni</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">clf_omni</span><span class="o">.</span><span class="n">coef_</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">coef</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spe</span> <span class="o">==</span> <span class="s2">&quot;human&quot;</span><span class="p">:</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;omni_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">gt</span> <span class="o">+</span> <span class="s2">&quot;_base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span><span class="o">.</span><span class="n">scprint_benchmark</span><span class="p">()</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;omni_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">gt</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">preadata</span><span class="p">)</span>

            <span class="c1">## SELF</span>
            <span class="k">if</span> <span class="n">clf_self</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">clf_self</span> <span class="o">=</span> <span class="n">train_classifier</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span>
                    <span class="n">other</span><span class="o">=</span><span class="n">preadata</span><span class="p">,</span>
                    <span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">train_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">class_weight</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">return_full</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;self_classifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="n">clf_self</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">clf_self</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">clf_self</span><span class="o">.</span><span class="n">coef_</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">coef</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;self_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">gt</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">preadata</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spe</span> <span class="o">==</span> <span class="s2">&quot;human&quot;</span><span class="p">:</span>
                <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;self_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">gt</span> <span class="o">+</span> <span class="s2">&quot;_base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span><span class="o">.</span><span class="n">scprint_benchmark</span><span class="p">()</span>

            <span class="c1">## chip / ko</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">spe</span><span class="p">,</span> <span class="s2">&quot;chip&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">todo</span><span class="p">:</span>
                <span class="n">preadata</span> <span class="o">=</span> <span class="n">get_sroy_gt</span><span class="p">(</span><span class="n">get</span><span class="o">=</span><span class="n">da</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">spe</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="s2">&quot;chip&quot;</span><span class="p">)</span>
                <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;mean_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;chip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">preadata</span><span class="p">)</span>
                <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">coef</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;omni_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;chip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">preadata</span><span class="p">)</span>

                <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">coef</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;self_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;chip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">preadata</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">spe</span><span class="p">,</span> <span class="s2">&quot;ko&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">todo</span><span class="p">:</span>
                <span class="n">preadata</span> <span class="o">=</span> <span class="n">get_sroy_gt</span><span class="p">(</span><span class="n">get</span><span class="o">=</span><span class="n">da</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">spe</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="s2">&quot;ko&quot;</span><span class="p">)</span>
                <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;mean_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;ko&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">preadata</span><span class="p">)</span>
                <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">coef</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;omni_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;ko&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">preadata</span><span class="p">)</span>
                <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">coef</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;self_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;ko&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">preadata</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">grn</span>
    <span class="k">elif</span> <span class="n">default_dataset</span> <span class="o">==</span> <span class="s2">&quot;gwps&quot;</span><span class="p">:</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">get_perturb_gt</span><span class="p">()</span>
        <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">Preprocessor</span><span class="p">(</span>
            <span class="n">force_preprocess</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">keepdata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">skip_validate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">do_postp</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span><span class="p">,</span>
            <span class="n">min_valid_genes_id</span><span class="o">=</span><span class="n">maxgenes</span><span class="p">,</span>
            <span class="n">min_dataset_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">nadata</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span><span class="p">:</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">nadata</span><span class="p">,</span> <span class="n">use_rep</span><span class="o">=</span><span class="s2">&quot;X_pca&quot;</span><span class="p">)</span>
        <span class="n">nadata</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;isTF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">nadata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">nadata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gene_name</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">grnutils</span><span class="o">.</span><span class="n">TF</span><span class="p">),</span> <span class="s2">&quot;isTF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">nadata</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;isTF&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">grn_inferer</span> <span class="o">=</span> <span class="n">GNInfer</span><span class="p">(</span>
            <span class="n">layer</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;most var within&quot;</span><span class="p">,</span>
            <span class="n">preprocess</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;softpick&quot;</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">attention</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;softpick&quot;</span><span class="p">,</span> <span class="s2">&quot;softpick-flash&quot;</span><span class="p">]</span>
                <span class="k">else</span> <span class="s2">&quot;softmax&quot;</span>
            <span class="p">),</span>
            <span class="n">head_agg</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="n">filtration</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="n">num_genes</span><span class="o">=</span><span class="n">maxgenes</span><span class="p">,</span>
            <span class="n">max_cells</span><span class="o">=</span><span class="n">maxcells</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">grn</span> <span class="o">=</span> <span class="n">grn_inferer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">nadata</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">nadata</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span>

        <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span><span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">adata</span><span class="p">)</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;ensembl_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;mean_base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
            <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span><span class="o">.</span><span class="n">scprint_benchmark</span><span class="p">()</span>

        <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;ensembl_id&quot;</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">clf_omni</span> <span class="o">=</span> <span class="n">train_classifier</span><span class="p">(</span>
            <span class="n">grn</span><span class="p">,</span>
            <span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">train_size</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
            <span class="n">class_weight</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">return_full</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">use_col</span><span class="o">=</span><span class="s2">&quot;gene_name&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="n">clf_omni</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">clf_omni</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">clf_omni</span><span class="o">.</span><span class="n">coef_</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">coef</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;omni&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span><span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">adata</span><span class="p">)</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;omni_classifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;omni_base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
            <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span><span class="o">.</span><span class="n">scprint_benchmark</span><span class="p">()</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;ensembl_id&quot;</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">clf_self</span> <span class="o">=</span> <span class="n">train_classifier</span><span class="p">(</span>
            <span class="n">grn</span><span class="p">,</span>
            <span class="n">other</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
            <span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">train_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">class_weight</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
            <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">return_full</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">use_col</span><span class="o">=</span><span class="s2">&quot;ensembl_id&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="n">clf_self</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">clf_self</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">clf_self</span><span class="o">.</span><span class="n">coef_</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">coef</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;self&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span><span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">adata</span><span class="p">)</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;self_classifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;self_base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
            <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span><span class="o">.</span><span class="n">scprint_benchmark</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">default_dataset</span> <span class="o">==</span> <span class="s2">&quot;genernib&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not implemented&quot;</span><span class="p">)</span>
        <span class="c1"># for adata in [NORMAN, OP, ADAMSON]:</span>
        <span class="c1">#   adata = sc.read_h5ad(adata)</span>
        <span class="c1">#   adata.obs[&quot;organism_ontology_term_id&quot;] = &quot;NCBITaxon:9606&quot;</span>
        <span class="c1">#   preprocessor = Preprocessor(</span>
        <span class="c1">#       force_preprocess=False,</span>
        <span class="c1">#       skip_validate=True,</span>
        <span class="c1">#       drop_non_primary=False,</span>
        <span class="c1">#       do_postp=False,</span>
        <span class="c1">#       min_valid_genes_id=1000,</span>
        <span class="c1">#       min_dataset_size=64,</span>
        <span class="c1">#       keepdata=True,</span>
        <span class="c1">#       is_symbol=True,</span>
        <span class="c1">#       use_raw=False,</span>
        <span class="c1">#   )</span>
        <span class="c1">#   adata = preprocessor(adata.copy())</span>
        <span class="c1">#   run_gene_rnib(</span>
        <span class="c1">#      adata=adata,</span>
        <span class="c1">#      model=model,</span>
        <span class="c1">#      layer=layers,</span>
        <span class="c1">#      how=&quot;most var within&quot;,</span>
        <span class="c1">#      preprocess=&quot;softmax&quot;,</span>
        <span class="c1">#   )</span>
        <span class="c1">#   grn_inferer = GNInfer(</span>
        <span class="c1">#      how=&quot;most var across&quot;,</span>
        <span class="c1">#      preprocess=&quot;softmax&quot;,</span>
        <span class="c1">#      head_agg=&quot;mean&quot;,</span>
        <span class="c1">#      filtration=&quot;none&quot;,</span>
        <span class="c1">#      forward_mode=&quot;none&quot;,</span>
        <span class="c1">#      num_genes=3_000,</span>
        <span class="c1">#      max_cells=3000,</span>
        <span class="c1">#      batch_size=10,</span>
        <span class="c1">#      cell_type_col=&quot;perturbation&quot;,</span>
        <span class="c1">#      layer=list(range(model.nlayers))[:],</span>
        <span class="c1">#   )</span>
        <span class="c1"># grn = grn_inferer(model, adata, cell_type=&quot;ctrl&quot;)</span>
        <span class="c1"># grn.var.index = make_index_unique(grn.var[&quot;symbol&quot;].astype(str))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># max_genes=4000</span>
        <span class="k">if</span> <span class="n">default_dataset</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;https://&quot;</span><span class="p">):</span>
            <span class="n">adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
                <span class="n">FILEDIR</span> <span class="o">+</span> <span class="s2">&quot;/../../data/&quot;</span> <span class="o">+</span> <span class="n">default_dataset</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">backup_url</span><span class="o">=</span><span class="n">default_dataset</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">default_dataset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">default_dataset</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;yBCKp6HmXuHa0cZptMo7.h5ad&quot;</span><span class="p">]:</span>
            <span class="n">use_layer</span> <span class="o">=</span> <span class="s2">&quot;counts&quot;</span>
            <span class="n">is_symbol</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">use_layer</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">is_symbol</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">Preprocessor</span><span class="p">(</span>
            <span class="n">use_layer</span><span class="o">=</span><span class="n">use_layer</span><span class="p">,</span>
            <span class="n">is_symbol</span><span class="o">=</span><span class="n">is_symbol</span><span class="p">,</span>
            <span class="n">force_preprocess</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">skip_validate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">do_postp</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span><span class="p">,</span>
            <span class="n">drop_non_primary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;isTF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">grnutils</span><span class="o">.</span><span class="n">TF</span><span class="p">),</span> <span class="s2">&quot;isTF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;X_pca&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">:</span>
                <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">n_comps</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">use_rep</span><span class="o">=</span><span class="s2">&quot;X_pca&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">celltype</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;cell_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())[:</span><span class="mi">14</span><span class="p">]:</span>
            <span class="c1"># print(celltype)</span>
            <span class="c1"># grn_inferer = GNInfer(</span>
            <span class="c1">#    layer=layers,</span>
            <span class="c1">#    how=&quot;random expr&quot;,</span>
            <span class="c1">#    preprocess=&quot;softmax&quot;,</span>
            <span class="c1">#    head_agg=&quot;max&quot;,</span>
            <span class="c1">#    filtration=&quot;none&quot;,</span>
            <span class="c1">#    num_workers=8,</span>
            <span class="c1">#    num_genes=2200,</span>
            <span class="c1">#    max_cells=maxcells,</span>
            <span class="c1">#    batch_size=batch_size,</span>
            <span class="c1"># )</span>
            <span class="c1">#</span>
            <span class="c1"># grn = grn_inferer(model, adata[adata.X.sum(1) &gt; 500], cell_type=celltype)</span>
            <span class="c1"># grn.var.index = make_index_unique(grn.var[&quot;symbol&quot;].astype(str))</span>
            <span class="c1"># metrics[celltype + &quot;_scprint&quot;] = BenGRN(</span>
            <span class="c1">#    grn, doplot=False</span>
            <span class="c1"># ).scprint_benchmark()</span>
            <span class="c1"># del grn</span>
            <span class="c1"># gc.collect()</span>
            <span class="n">grn_inferer</span> <span class="o">=</span> <span class="n">GNInfer</span><span class="p">(</span>
                <span class="n">layer</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;most var across&quot;</span><span class="p">,</span>
                <span class="n">preprocess</span><span class="o">=</span><span class="p">(</span>
                    <span class="s2">&quot;softpick&quot;</span>
                    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">attention</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;softpick&quot;</span><span class="p">,</span> <span class="s2">&quot;softpick-flash&quot;</span><span class="p">]</span>
                    <span class="k">else</span> <span class="s2">&quot;softmax&quot;</span>
                <span class="p">),</span>
                <span class="n">head_agg</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                <span class="n">filtration</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                <span class="n">num_workers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                <span class="n">num_genes</span><span class="o">=</span><span class="n">maxgenes</span><span class="p">,</span>
                <span class="n">max_cells</span><span class="o">=</span><span class="n">maxcells</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">grn</span> <span class="o">=</span> <span class="n">grn_inferer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">],</span> <span class="n">cell_type</span><span class="o">=</span><span class="n">celltype</span><span class="p">)</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">make_index_unique</span><span class="p">(</span><span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">celltype</span> <span class="o">+</span> <span class="s2">&quot;_scprint_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                <span class="n">grn</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span><span class="o">.</span><span class="n">scprint_benchmark</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">clf_omni</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">clf_omni</span> <span class="o">=</span> <span class="n">train_classifier</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span>
                    <span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">train_size</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                    <span class="n">max_iter</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                    <span class="n">class_weight</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                    <span class="n">return_full</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">clf_omni</span><span class="p">,</span> <span class="s2">&quot;clf_omni.pkl&quot;</span><span class="p">)</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;classifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="n">clf_omni</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">clf_omni</span><span class="o">.</span><span class="n">coef_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">clf_omni</span><span class="o">.</span><span class="n">coef_</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">coef</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">celltype</span> <span class="o">+</span> <span class="s2">&quot;_scprint_class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                <span class="n">grn</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span><span class="o">.</span><span class="n">scprint_benchmark</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">grn</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">metrics</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="scprint2.tasks.denoise" class="doc doc-heading">
            <code>scprint2.tasks.denoise</code>


</h2>

    <div class="doc doc-contents first">










<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="Denoiser (scprint2.tasks.denoise.Denoiser)" href="#scprint2.tasks.denoise.Denoiser">Denoiser</a></code></td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>




<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="default_benchmark (scprint2.tasks.denoise.default_benchmark)" href="#scprint2.tasks.denoise.default_benchmark">default_benchmark</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>default_benchmark function used to run the default denoising benchmark of scPRINT</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="split_molecules (scprint2.tasks.denoise.split_molecules)" href="#scprint2.tasks.denoise.split_molecules">split_molecules</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Splits molecules into two (potentially overlapping) groups.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>





<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="scprint2.tasks.denoise.Denoiser" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">Denoiser</span></code>

</h3>


    <div class="doc doc-contents ">



        <p>Denoiser class for denoising scRNA-seq data using a scPRINT model</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>batch_size</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>10</code>
)
              –
              <div class="doc-md-description">
                <p>Batch size for processing. Defaults to 10.</p>
              </div>
            </li>
            <li>
              <b><code>num_workers</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>1</code>
)
              –
              <div class="doc-md-description">
                <p>Number of workers for data loading. Defaults to 1.</p>
              </div>
            </li>
            <li>
              <b><code>max_len</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>5000</code>
)
              –
              <div class="doc-md-description">
                <p>Maximum number of genes to consider. Defaults to 5000.</p>
              </div>
            </li>
            <li>
              <b><code>how</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>&#39;most var&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Method to select genes. Options are "most var", "random expr", "some". Defaults to "most var".
- "most var": select the most variable genes
- "random expr": select random expressed genes
- "some": select a subset of genes defined in genelist</p>
              </div>
            </li>
            <li>
              <b><code>max_cells</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>500000</code>
)
              –
              <div class="doc-md-description">
                <p>Number of cells to use for plotting correlation. Defaults to 10000.</p>
              </div>
            </li>
            <li>
              <b><code>doplot</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to generate plots of the similarity between the denoised and true expression data. Defaults to False.
Only works when downsample_expr is not None and max_cells &lt; 100.</p>
              </div>
            </li>
            <li>
              <b><code>predict_depth_mult</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>4</code>
)
              –
              <div class="doc-md-description">
                <p>Multiplier for prediction depth. Defaults to 4.
This will artificially increase the sequencing depth (or number of counts) to 4 times the original depth.</p>
              </div>
            </li>
            <li>
              <b><code>downsample_expr</code></b>
                  (<code><span title="typing.Optional">Optional</span>[<span title="float">float</span>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Fraction of expression data to downsample. Defaults to None.
This is usefull to test the ability of the model to denoise the dataset. only to use the input data as a benchmark dataset.
When this option is on, the denoiser will output benchmark metrics</p>
              </div>
            </li>
            <li>
              <b><code>genelist</code></b>
                  (<code><span title="typing.List">List</span>[<span title="str">str</span>]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The list of genes to be used for embedding. Defaults to []: In this case, "how" needs to be "most var" or "random expr".</p>
              </div>
            </li>
            <li>
              <b><code>save_every</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>100000</code>
)
              –
              <div class="doc-md-description">
                <p>The number of cells to save at a time. Defaults to 100_000.
This is important to avoid memory issues.</p>
              </div>
            </li>
            <li>
              <b><code>pred_embedding</code></b>
                  (<code><span title="typing.List">List</span>[<span title="str">str</span>]</code>, default:
                      <code>[&#39;cell_type_ontology_term_id&#39;]</code>
)
              –
              <div class="doc-md-description">
                <p>The embedding type to be used as the denoising will also predict the cell embeddings.</p>
              </div>
            </li>
            <li>
              <b><code>additional_info</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to print additional benchmark information during denoising. Defaults to False.
only useful when downsampling is used.</p>
              </div>
            </li>
            <li>
              <b><code>apply_zero_pred</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to apply zero inflation to the output value during denoising, else uses only the predicted mean.
applying zero inflation might give results closer to the specific biases of sequencing technologies but less biological truthful.</p>
              </div>
            </li>
            <li>
              <b><code>use_knn</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to use knn cells for denoising when the model uses metacell expression embedding. Defaults to True.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>










<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="__call__ (scprint2.tasks.denoise.Denoiser.__call__)" href="#scprint2.tasks.denoise.Denoiser.__call__">__call__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p><strong>call</strong> calling the function</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>



                  <details class="quote">
                    <summary>Source code in <code>scprint2/tasks/denoise.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">max_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5_000</span><span class="p">,</span>
    <span class="n">how</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;most var&quot;</span><span class="p">,</span>
    <span class="n">max_cells</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500_000</span><span class="p">,</span>
    <span class="n">doplot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">predict_depth_mult</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">downsample_expr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">genelist</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">save_every</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100_000</span><span class="p">,</span>
    <span class="n">pred_embedding</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cell_type_ontology_term_id&quot;</span><span class="p">],</span>
    <span class="n">additional_info</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">apply_zero_pred</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">use_knn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Denoiser class for denoising scRNA-seq data using a scPRINT model</span>

<span class="sd">    Args:</span>
<span class="sd">        batch_size (int, optional): Batch size for processing. Defaults to 10.</span>
<span class="sd">        num_workers (int, optional): Number of workers for data loading. Defaults to 1.</span>
<span class="sd">        max_len (int, optional): Maximum number of genes to consider. Defaults to 5000.</span>
<span class="sd">        how (str, optional): Method to select genes. Options are &quot;most var&quot;, &quot;random expr&quot;, &quot;some&quot;. Defaults to &quot;most var&quot;.</span>
<span class="sd">            - &quot;most var&quot;: select the most variable genes</span>
<span class="sd">            - &quot;random expr&quot;: select random expressed genes</span>
<span class="sd">            - &quot;some&quot;: select a subset of genes defined in genelist</span>
<span class="sd">        max_cells (int, optional): Number of cells to use for plotting correlation. Defaults to 10000.</span>
<span class="sd">        doplot (bool, optional): Whether to generate plots of the similarity between the denoised and true expression data. Defaults to False.</span>
<span class="sd">            Only works when downsample_expr is not None and max_cells &lt; 100.</span>
<span class="sd">        predict_depth_mult (int, optional): Multiplier for prediction depth. Defaults to 4.</span>
<span class="sd">            This will artificially increase the sequencing depth (or number of counts) to 4 times the original depth.</span>
<span class="sd">        downsample_expr (Optional[float], optional): Fraction of expression data to downsample. Defaults to None.</span>
<span class="sd">            This is usefull to test the ability of the model to denoise the dataset. only to use the input data as a benchmark dataset.</span>
<span class="sd">            When this option is on, the denoiser will output benchmark metrics</span>
<span class="sd">        genelist (List[str], optional): The list of genes to be used for embedding. Defaults to []: In this case, &quot;how&quot; needs to be &quot;most var&quot; or &quot;random expr&quot;.</span>
<span class="sd">        save_every (int, optional): The number of cells to save at a time. Defaults to 100_000.</span>
<span class="sd">            This is important to avoid memory issues.</span>
<span class="sd">        pred_embedding (List[str], optional): The embedding type to be used as the denoising will also predict the cell embeddings.</span>
<span class="sd">        additional_info (bool, optional): Whether to print additional benchmark information during denoising. Defaults to False.</span>
<span class="sd">            only useful when downsampling is used.</span>
<span class="sd">        apply_zero_pred (bool, optional): Whether to apply zero inflation to the output value during denoising, else uses only the predicted mean.</span>
<span class="sd">            applying zero inflation might give results closer to the specific biases of sequencing technologies but less biological truthful.</span>
<span class="sd">        use_knn (bool, optional): Whether to use knn cells for denoising when the model uses metacell expression embedding. Defaults to True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="o">=</span> <span class="n">num_workers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="n">max_len</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_cells</span> <span class="o">=</span> <span class="n">max_cells</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">doplot</span> <span class="o">=</span> <span class="n">doplot</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">predict_depth_mult</span> <span class="o">=</span> <span class="n">predict_depth_mult</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">=</span> <span class="n">how</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">downsample_expr</span> <span class="o">=</span> <span class="n">downsample_expr</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">genelist</span> <span class="o">=</span> <span class="n">genelist</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_every</span> <span class="o">=</span> <span class="n">save_every</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pred_embedding</span> <span class="o">=</span> <span class="n">pred_embedding</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">additional_info</span> <span class="o">=</span> <span class="n">additional_info</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">apply_zero_pred</span> <span class="o">=</span> <span class="n">apply_zero_pred</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_knn</span> <span class="o">=</span> <span class="n">use_knn</span>
</code></pre></div></td></tr></table></div>
                  </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="scprint2.tasks.denoise.Denoiser.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__call__</span></code>

</h4>


    <div class="doc doc-contents ">

        <p><strong>call</strong> calling the function</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>model</code></b>
                  (<code><span title="torch.nn.Module">Module</span></code>)
              –
              <div class="doc-md-description">
                <p>The scPRINT model to be used for denoising.</p>
              </div>
            </li>
            <li>
              <b><code>adata</code></b>
                  (<code><span title="anndata.AnnData">AnnData</span></code>)
              –
              <div class="doc-md-description">
                <p>The annotated data matrix of shape n_obs x n_vars. Rows correspond to cells and columns to genes.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>dict</code></b>(                  <code><span title="dict">dict</span></code>
)              –
              <div class="doc-md-description">
                <p>The benchmark metrics if downsampling is used.</p>
              </div>
            </li>
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="numpy.ndarray">ndarray</span>]</code>
              –
              <div class="doc-md-description">
                <p>Optional[np.ndarray]: The random set of cells used if max_cells &lt; adata.shape[0].</p>
              </div>
            </li>
            <li>
<b><code>AnnData</code></b>(                  <code><span title="anndata.AnnData">AnnData</span></code>
)              –
              <div class="doc-md-description">
                <p>The denoised annotated data matrix.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>scprint2/tasks/denoise.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">AnnData</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    __call__ calling the function</span>

<span class="sd">    Args:</span>
<span class="sd">        model (torch.nn.Module): The scPRINT model to be used for denoising.</span>
<span class="sd">        adata (AnnData): The annotated data matrix of shape n_obs x n_vars. Rows correspond to cells and columns to genes.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The benchmark metrics if downsampling is used.</span>
<span class="sd">        Optional[np.ndarray]: The random set of cells used if max_cells &lt; adata.shape[0].</span>
<span class="sd">        AnnData: The denoised annotated data matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Select random number</span>
    <span class="n">random_indices</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cells</span> <span class="o">&lt;</span> <span class="n">adata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">random_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
            <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cells</span>
        <span class="p">)</span>
        <span class="n">adataset</span> <span class="o">=</span> <span class="n">SimpleAnnDataset</span><span class="p">(</span>
            <span class="n">adata</span><span class="p">[</span><span class="n">random_indices</span><span class="p">],</span>
            <span class="n">obs_to_output</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;organism_ontology_term_id&quot;</span><span class="p">],</span>
            <span class="n">get_knn_cells</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_knn</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">adataset</span> <span class="o">=</span> <span class="n">SimpleAnnDataset</span><span class="p">(</span>
            <span class="n">adata</span><span class="p">,</span>
            <span class="n">obs_to_output</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;organism_ontology_term_id&quot;</span><span class="p">],</span>
            <span class="n">get_knn_cells</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_knn</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;most var&quot;</span><span class="p">:</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">highly_variable_genes</span><span class="p">(</span>
            <span class="n">adata</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s2">&quot;seurat_v3&quot;</span><span class="p">,</span> <span class="n">n_top_genes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">,</span> <span class="n">span</span><span class="o">=</span><span class="mf">0.99</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genelist</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">highly_variable</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genelist</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">genelist</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">genes</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">genelist</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;working on </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genelist</span><span class="p">)</span><span class="si">}</span><span class="s2"> accepted genes&quot;</span><span class="p">)</span>

    <span class="n">col</span> <span class="o">=</span> <span class="n">Collator</span><span class="p">(</span>
        <span class="n">organisms</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">organisms</span><span class="p">,</span>
        <span class="n">valid_genes</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">genes</span><span class="p">,</span>
        <span class="n">max_len</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;some&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;most var&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span><span class="p">,</span>
        <span class="n">genelist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">genelist</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">!=</span> <span class="s2">&quot;random expr&quot;</span> <span class="k">else</span> <span class="p">[],</span>
        <span class="n">n_bins</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">n_input_bins</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;binned&quot;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
        <span class="n">adataset</span><span class="p">,</span>
        <span class="n">collate_fn</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">prevplot</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">doplot</span>
    <span class="n">model</span><span class="o">.</span><span class="n">doplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doplot</span>
    <span class="n">model</span><span class="o">.</span><span class="n">on_predict_epoch_start</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span>
    <span class="n">model</span><span class="o">.</span><span class="n">pred_log_adata</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">stored_noisy</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">rand</span> <span class="o">=</span> <span class="n">random_str</span><span class="p">()</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">float16</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">transformer</span><span class="p">)</span> <span class="ow">is</span> <span class="n">FlashTransformer</span>
        <span class="k">else</span> <span class="n">model</span><span class="o">.</span><span class="n">dtype</span>
    <span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
    <span class="n">save_expr</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">save_expr</span>
    <span class="n">model</span><span class="o">.</span><span class="n">save_expr</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
            <span class="n">gene_pos</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;genes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">knn_cells</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;knn_cells&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_knn</span>
                <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">expression</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">downsample_profile</span><span class="p">(</span>
                    <span class="n">expression</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_expr</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">knn_cells</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">knn_cells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">knn_cells</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">downsample_profile</span><span class="p">(</span>
                            <span class="n">knn_cells</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_expr</span>
                        <span class="p">)</span>
            <span class="k">if</span> <span class="n">stored_noisy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">stored_noisy</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stored_noisy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">stored_noisy</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span>

            <span class="n">model</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span>
                <span class="n">gene_pos</span><span class="p">,</span>
                <span class="n">expression</span><span class="p">,</span>
                <span class="n">depth</span><span class="p">,</span>
                <span class="n">knn_cells</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;knn_cells&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_knn</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">),</span>
                <span class="n">knn_cells_info</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;knn_cells_info&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_knn</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">),</span>
                <span class="n">do_generate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">depth_mult</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_depth_mult</span><span class="p">,</span>
                <span class="n">pred_embedding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pred_embedding</span><span class="p">,</span>
                <span class="n">max_size_in_mem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">save_every</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;denoise_&quot;</span> <span class="o">+</span> <span class="n">rand</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">log_adata</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;denoise_&quot;</span> <span class="o">+</span> <span class="n">rand</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">counter</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mdir</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">save_dir</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">save_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;data&quot;</span>
        <span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">mdir</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span>
    <span class="n">pred_adata</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">mdir</span>
            <span class="o">+</span> <span class="s2">&quot;/step_&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">global_step</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
            <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span>
            <span class="o">+</span> <span class="s2">&quot;_denoise_&quot;</span>
            <span class="o">+</span> <span class="n">rand</span>
            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">global_rank</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;.h5ad&quot;</span>
        <span class="p">)</span>
        <span class="n">pred_adata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">pred_adata</span> <span class="o">=</span> <span class="n">concat</span><span class="p">(</span><span class="n">pred_adata</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">attn_type</span> <span class="o">==</span> <span class="s2">&quot;hyper&quot;</span><span class="p">:</span>
        <span class="c1"># seq len must be a multiple of 128</span>
        <span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">use_metacell_token</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">classes</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">cell_transformer</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">stored_noisy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">num</span><span class="p">)</span> <span class="o">%</span> <span class="mi">128</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">stored_noisy</span> <span class="o">=</span> <span class="n">stored_noisy</span><span class="p">[</span>
                <span class="p">:,</span> <span class="p">:</span> <span class="p">((</span><span class="n">stored_noisy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">//</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">128</span><span class="p">)</span> <span class="o">-</span> <span class="n">num</span>
            <span class="p">]</span>
    <span class="n">pred_adata</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">stored_noisy</span>

    <span class="n">metrics</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">model</span><span class="o">.</span><span class="n">doplot</span> <span class="o">=</span> <span class="n">prevplot</span>
    <span class="n">model</span><span class="o">.</span><span class="n">save_expr</span> <span class="o">=</span> <span class="n">save_expr</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">reco</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pred_adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;scprint_mu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="n">pred_adata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="c1"># reco = reco * F.sigmoid(</span>
        <span class="c1">#    torch.Tensor(np.array(pred_adata.layers[&quot;scprint_pi&quot;].data).reshape(pred_adata.shape[0], -1)) &lt; 0.5</span>
        <span class="c1"># ).numpy()</span>

        <span class="n">adata</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">adata</span><span class="p">[</span><span class="n">random_indices</span><span class="p">,</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">pred_adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">random_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">adata</span><span class="p">[:,</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">pred_adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="n">true</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span>
            <span class="p">:,</span>
            <span class="n">pred_adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">[</span>
                <span class="n">pred_adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
        <span class="p">]</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_zero_pred</span><span class="p">:</span>
            <span class="n">reco</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">reco</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="mi">1</span>
                    <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span>
                        <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pred_adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;scprint_pi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                                <span class="n">pred_adata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="p">)</span>

        <span class="n">corr_coef</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">spearmanr</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">reco</span><span class="p">[</span><span class="n">true</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="n">stored_noisy</span><span class="p">[</span><span class="n">true</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="n">true</span><span class="p">[</span><span class="n">true</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
        <span class="p">)</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;reco2noisy&quot;</span><span class="p">:</span> <span class="n">corr_coef</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;reco2full&quot;</span><span class="p">:</span> <span class="n">corr_coef</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;noisy2full&quot;</span><span class="p">:</span> <span class="n">corr_coef</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional_info</span><span class="p">:</span>
            <span class="c1"># Sample only 3000 elements for correlation calculation</span>
            <span class="k">if</span> <span class="n">reco</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3000</span><span class="p">:</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">reco</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3000</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">reco</span> <span class="o">=</span> <span class="n">reco</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
                <span class="n">stored_noisy</span> <span class="o">=</span> <span class="n">stored_noisy</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
                <span class="n">true</span> <span class="o">=</span> <span class="n">true</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
            <span class="n">corr</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">spearmanr</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">reco</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                        <span class="n">stored_noisy</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                        <span class="n">true</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
                    <span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;reco2full&quot;</span><span class="p">:</span> <span class="n">corr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                <span class="s2">&quot;noisy2full&quot;</span><span class="p">:</span> <span class="n">corr</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;corr with zeros: &quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
            <span class="n">cell_wise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">spearmanr</span><span class="p">(</span><span class="n">reco</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">true</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="n">true</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">true</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">reco</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">torm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">spearmanr</span><span class="p">(</span><span class="n">stored_noisy</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">true</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="n">true</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">true</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])[</span>
                        <span class="mi">0</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">reco</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">cell_wise</span> <span class="o">-=</span> <span class="n">torm</span>
            <span class="n">cell_wise_zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="p">[</span><span class="n">spearmanr</span><span class="p">(</span><span class="n">reco</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">true</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">reco</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;cell_wise self corr (reco, noisy, true)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;cell_wise_w_zero&quot;</span><span class="p">:</span> <span class="n">cell_wise_zero</span><span class="p">,</span>
                    <span class="s2">&quot;cell_wise_to_noisy&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cell_wise</span><span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;depth-wise plot&quot;</span><span class="p">)</span>
            <span class="n">plot_cell_depth_wise_corr_improvement</span><span class="p">(</span><span class="n">cell_wise</span><span class="p">,</span> <span class="p">(</span><span class="n">true</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doplot</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cells</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">corr_coef</span><span class="p">[</span><span class="n">p_value</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                <span class="n">corr_coef</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Expression Correlation Coefficient&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">random_indices</span><span class="p">,</span> <span class="n">pred_adata</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>


</div>


<div class="doc doc-object doc-function">


<h3 id="scprint2.tasks.denoise.default_benchmark" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">default_benchmark</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>default_benchmark function used to run the default denoising benchmark of scPRINT</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>model</code></b>
                  (<code><span title="typing.Any">Any</span></code>)
              –
              <div class="doc-md-description">
                <p>The scPRINT model to be used for the benchmark.</p>
              </div>
            </li>
            <li>
              <b><code>folder_dir</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code><span title="scprint2.tasks.denoise.FILE_DIR">FILE_DIR</span> + &#39;/../../data/&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Directory containing data files.</p>
              </div>
            </li>
            <li>
              <b><code>dataset</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code><span title="scprint2.tasks.denoise.FILE_DIR">FILE_DIR</span> + &#39;/../../data/gNNpgpo6gATjuxTE7CCp.h5ad&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Path to the dataset to use for benchmarking.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>dict</code></b>(                  <code><span title="dict">dict</span></code>
)              –
              <div class="doc-md-description">
                <p>A dictionary containing the benchmark metrics.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>scprint2/tasks/denoise.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">default_benchmark</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">folder_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">FILE_DIR</span> <span class="o">+</span> <span class="s2">&quot;/../../data/&quot;</span><span class="p">,</span>
    <span class="n">dataset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">FILE_DIR</span>
    <span class="o">+</span> <span class="s2">&quot;/../../data/gNNpgpo6gATjuxTE7CCp.h5ad&quot;</span><span class="p">,</span>  <span class="c1"># r4iCehg3Tw5IbCLiCIbl</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    default_benchmark function used to run the default denoising benchmark of scPRINT</span>

<span class="sd">    Args:</span>
<span class="sd">        model (Any): The scPRINT model to be used for the benchmark.</span>
<span class="sd">        folder_dir (str, optional): Directory containing data files.</span>
<span class="sd">        dataset (str, optional): Path to the dataset to use for benchmarking.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the benchmark metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;https://&quot;</span><span class="p">):</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
            <span class="n">folder_dir</span> <span class="o">+</span> <span class="n">dataset</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">backup_url</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;gNNpgpo6gATjuxTE7CCp.h5ad&quot;</span><span class="p">:</span>
        <span class="n">use_layer</span> <span class="o">=</span> <span class="s2">&quot;counts&quot;</span>
        <span class="n">is_symbol</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">use_layer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">is_symbol</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">max_len</span> <span class="o">=</span> <span class="mi">4000</span> <span class="k">if</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">150_000</span> <span class="k">else</span> <span class="mi">8000</span>
    <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">Preprocessor</span><span class="p">(</span>
        <span class="n">use_layer</span><span class="o">=</span><span class="n">use_layer</span><span class="p">,</span>
        <span class="n">is_symbol</span><span class="o">=</span><span class="n">is_symbol</span><span class="p">,</span>
        <span class="n">force_preprocess</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">skip_validate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">do_postp</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span><span class="p">,</span>
        <span class="n">drop_non_primary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">adata</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;X_pca&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">:</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">n_comps</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">use_rep</span><span class="o">=</span><span class="s2">&quot;X_pca&quot;</span><span class="p">)</span>
    <span class="n">denoise</span> <span class="o">=</span> <span class="n">Denoiser</span><span class="p">(</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="mi">40</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">!=</span> <span class="s2">&quot;metacell&quot;</span> <span class="k">else</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">max_len</span><span class="o">=</span><span class="n">max_len</span><span class="p">,</span>
        <span class="n">max_cells</span><span class="o">=</span><span class="mi">10_000</span><span class="p">,</span>
        <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">predict_depth_mult</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">downsample_expr</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
        <span class="n">pred_embedding</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">pred_embedding</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">denoise</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">adata</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="scprint2.tasks.denoise.split_molecules" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">split_molecules</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Splits molecules into two (potentially overlapping) groups.
:param umis: Array of molecules to split
:param data_split: Proportion of molecules to assign to the first group
:param overlap_factor: Overlap correction factor, if desired
:param random_state: For reproducible sampling
:return: umis_X and umis_Y, representing <code>split</code> and <code>~(1 - split)</code> counts
         sampled from the input array</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>scprint2/tasks/denoise.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">split_molecules</span><span class="p">(</span>
    <span class="n">umis</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">data_split</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">overlap_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">random_state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Splits molecules into two (potentially overlapping) groups.</span>
<span class="sd">    :param umis: Array of molecules to split</span>
<span class="sd">    :param data_split: Proportion of molecules to assign to the first group</span>
<span class="sd">    :param overlap_factor: Overlap correction factor, if desired</span>
<span class="sd">    :param random_state: For reproducible sampling</span>
<span class="sd">    :return: umis_X and umis_Y, representing ``split`` and ``~(1 - split)`` counts</span>
<span class="sd">             sampled from the input array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">random_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">random_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">()</span>

    <span class="n">umis_X_disjoint</span> <span class="o">=</span> <span class="n">random_state</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="n">umis</span><span class="p">,</span> <span class="n">data_split</span> <span class="o">-</span> <span class="n">overlap_factor</span><span class="p">)</span>
    <span class="n">umis_Y_disjoint</span> <span class="o">=</span> <span class="n">random_state</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span>
        <span class="n">umis</span> <span class="o">-</span> <span class="n">umis_X_disjoint</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">data_split</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">data_split</span> <span class="o">+</span> <span class="n">overlap_factor</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">overlap_factor</span> <span class="o">=</span> <span class="n">umis</span> <span class="o">-</span> <span class="n">umis_X_disjoint</span> <span class="o">-</span> <span class="n">umis_Y_disjoint</span>
    <span class="n">umis_X</span> <span class="o">=</span> <span class="n">umis_X_disjoint</span> <span class="o">+</span> <span class="n">overlap_factor</span>
    <span class="n">umis_Y</span> <span class="o">=</span> <span class="n">umis_Y_disjoint</span> <span class="o">+</span> <span class="n">overlap_factor</span>

    <span class="k">return</span> <span class="n">umis_X</span><span class="p">,</span> <span class="n">umis_Y</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="scprint2.tasks.gene_emb" class="doc doc-heading">
            <code>scprint2.tasks.gene_emb</code>


</h2>

    <div class="doc doc-contents first">










<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="GeneEmbeddingExtractor (scprint2.tasks.gene_emb.GeneEmbeddingExtractor)" href="#scprint2.tasks.gene_emb.GeneEmbeddingExtractor">GeneEmbeddingExtractor</a></code></td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>







<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="scprint2.tasks.gene_emb.GeneEmbeddingExtractor" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">GeneEmbeddingExtractor</span></code>

</h3>


    <div class="doc doc-contents ">





<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>genelist</code></b>
                  (<code><span title="list">list</span>[<span title="str">str</span>]</code>)
              –
              <div class="doc-md-description">
                <p>List of genes to restrict to.</p>
              </div>
            </li>
            <li>
              <b><code>batch_size</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>64</code>
)
              –
              <div class="doc-md-description">
                <p>Batch size for the DataLoader. Defaults to 64.</p>
              </div>
            </li>
            <li>
              <b><code>num_workers</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>8</code>
)
              –
              <div class="doc-md-description">
                <p>Number of workers for DataLoader. Defaults to 8.</p>
              </div>
            </li>
            <li>
              <b><code>save_every</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>4000</code>
)
              –
              <div class="doc-md-description">
                <p>Save embeddings every <code>save_every</code> batches. Defaults to 4000.</p>
              </div>
            </li>
            <li>
              <b><code>average</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to average embeddings across all cells. Defaults to False.</p>
              </div>
            </li>
            <li>
              <b><code>save_dir</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Directory to save embeddings. If None, embeddings are not saved. Defaults to None.</p>
              </div>
            </li>
            <li>
              <b><code>use_knn</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to use k-nearest neighbors information. Defaults to False.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>











                  <details class="quote">
                    <summary>Source code in <code>scprint2/tasks/gene_emb.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">genelist</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">save_every</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4_000</span><span class="p">,</span>
    <span class="n">average</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">use_knn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        genelist (list[str]): List of genes to restrict to.</span>
<span class="sd">        batch_size (int): Batch size for the DataLoader. Defaults to 64.</span>
<span class="sd">        num_workers (int): Number of workers for DataLoader. Defaults to 8.</span>
<span class="sd">        save_every (int): Save embeddings every `save_every` batches. Defaults to 4000.</span>
<span class="sd">        average (bool): Whether to average embeddings across all cells. Defaults to False.</span>
<span class="sd">        save_dir (str): Directory to save embeddings. If None, embeddings are not saved. Defaults to None.</span>
<span class="sd">        use_knn (bool): Whether to use k-nearest neighbors information. Defaults to False.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">genelist</span> <span class="o">=</span> <span class="n">genelist</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="o">=</span> <span class="n">num_workers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_every</span> <span class="o">=</span> <span class="n">save_every</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">average</span> <span class="o">=</span> <span class="n">average</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span> <span class="o">=</span> <span class="n">save_dir</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_knn</span> <span class="o">=</span> <span class="n">use_knn</span>
</code></pre></div></td></tr></table></div>
                  </details>



<div class="doc doc-children">












  </div>

    </div>


</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="scprint2.tasks.generate" class="doc doc-heading">
            <code>scprint2.tasks.generate</code>


</h2>

    <div class="doc doc-contents first">










<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="Generate (scprint2.tasks.generate.Generate)" href="#scprint2.tasks.generate.Generate">Generate</a></code></td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>







<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="scprint2.tasks.generate.Generate" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">Generate</span></code>

</h3>


    <div class="doc doc-contents ">



        <p>Embedder a class to embed and annotate cells using a model</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>genelist</code></b>
                  (<code><span title="typing.List">List</span>[<span title="str">str</span>]</code>)
              –
              <div class="doc-md-description">
                <p>The list of genes for which to generate expression data.</p>
              </div>
            </li>
            <li>
              <b><code>batch_size</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>64</code>
)
              –
              <div class="doc-md-description">
                <p>The size of the batches to be used in the DataLoader. Defaults to 64.</p>
              </div>
            </li>
            <li>
              <b><code>embedding_to_use</code></b>
                  (<code><span title="typing.List">List</span>[<span title="str">str</span>]</code>, default:
                      <code>[&#39;all&#39;]</code>
)
              –
              <div class="doc-md-description">
                <p>The list of embeddings to be used for generating expression. Defaults to ["all"].</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>










<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="__call__ (scprint2.tasks.generate.Generate.__call__)" href="#scprint2.tasks.generate.Generate.__call__">__call__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p><strong>call</strong> function to call the embedding</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>



                  <details class="quote">
                    <summary>Source code in <code>scprint2/tasks/generate.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">genelist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
    <span class="n">embedding_to_use</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Embedder a class to embed and annotate cells using a model</span>

<span class="sd">    Args:</span>
<span class="sd">        genelist (List[str]): The list of genes for which to generate expression data.</span>
<span class="sd">        batch_size (int, optional): The size of the batches to be used in the DataLoader. Defaults to 64.</span>
<span class="sd">        embedding_to_use (List[str], optional): The list of embeddings to be used for generating expression. Defaults to [&quot;all&quot;].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">embedding_to_use</span> <span class="o">=</span> <span class="n">embedding_to_use</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">genelist</span> <span class="o">=</span> <span class="n">genelist</span> <span class="k">if</span> <span class="n">genelist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
                  </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="scprint2.tasks.generate.Generate.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__call__</span></code>

</h4>


    <div class="doc doc-contents ">

        <p><strong>call</strong> function to call the embedding</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>model</code></b>
                  (<code><span title="torch.nn.Module">Module</span></code>)
              –
              <div class="doc-md-description">
                <p>The scPRINT model to be used for embedding and annotation.</p>
              </div>
            </li>
            <li>
              <b><code>adata</code></b>
                  (<code><span title="anndata.AnnData">AnnData</span></code>)
              –
              <div class="doc-md-description">
                <p>The annotated data matrix of shape n_obs x n_vars. Rows correspond to cells and columns to genes.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
                <p>If the model does not have a logger attribute.</p>
              </div>
            </li>
            <li>
                  <code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
                <p>If the model does not have a global_step attribute.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>AnnData</code></b>(                  <code><span title="anndata.AnnData">AnnData</span></code>
)              –
              <div class="doc-md-description">
                <p>The annotated data matrix with embedded cell representations.</p>
              </div>
            </li>
            <li>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
              –
              <div class="doc-md-description">
                <p>List[str]: List of gene names used in the embedding.</p>
              </div>
            </li>
            <li>
                  <code><span title="numpy.ndarray">ndarray</span></code>
              –
              <div class="doc-md-description">
                <p>np.ndarray: The predicted expression values if sample"none".</p>
              </div>
            </li>
            <li>
<b><code>dict</code></b>(                  <code><span title="dict">dict</span></code>
)              –
              <div class="doc-md-description">
                <p>Additional metrics and information from the embedding process.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>scprint2/tasks/generate.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">AnnData</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    __call__ function to call the embedding</span>

<span class="sd">    Args:</span>
<span class="sd">        model (torch.nn.Module): The scPRINT model to be used for embedding and annotation.</span>
<span class="sd">        adata (AnnData): The annotated data matrix of shape n_obs x n_vars. Rows correspond to cells and columns to genes.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the model does not have a logger attribute.</span>
<span class="sd">        ValueError: If the model does not have a global_step attribute.</span>

<span class="sd">    Returns:</span>
<span class="sd">        AnnData: The annotated data matrix with embedded cell representations.</span>
<span class="sd">        List[str]: List of gene names used in the embedding.</span>
<span class="sd">        np.ndarray: The predicted expression values if sample&quot;none&quot;.</span>
<span class="sd">        dict: Additional metrics and information from the embedding process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># one of &quot;all&quot; &quot;sample&quot; &quot;none&quot;</span>
    <span class="n">model</span><span class="o">.</span><span class="n">predict_mode</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">on_predict_epoch_start</span><span class="p">()</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">float16</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">transformer</span><span class="p">,</span> <span class="n">FlashTransformer</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">model</span><span class="o">.</span><span class="n">dtype</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_to_use</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]:</span>
        <span class="n">use</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">i</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;scprint_emb_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="s2">&quot;scprint_emb_other&quot;</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding_to_use</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">(),</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="n">gene_pos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
            <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">genes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">genelist</span><span class="p">],</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        <span class="n">gene_pos</span> <span class="o">=</span> <span class="n">gene_pos</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">req_depth</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="n">embeddings</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">batch</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
            <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">batch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">adata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">emb</span> <span class="ow">in</span> <span class="n">use</span><span class="p">:</span>
                <span class="n">embeddings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="n">emb</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">embeddings</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_generate</span><span class="p">(</span>
                <span class="n">gene_pos</span><span class="o">=</span><span class="n">gene_pos</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="p">:],</span>
                <span class="n">cell_embs</span><span class="o">=</span><span class="n">embeddings</span><span class="p">,</span>
                <span class="n">depth_mult</span><span class="o">=</span><span class="n">req_depth</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span>
                <span class="n">req_depth</span><span class="o">=</span><span class="n">req_depth</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span>
                <span class="n">metacell_token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;disp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                        <span class="n">output</span><span class="p">[</span><span class="s2">&quot;zero_logits&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;disp&quot;</span> <span class="ow">in</span> <span class="n">output</span>
                <span class="k">else</span> <span class="n">output</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pred_adata</span> <span class="o">=</span> <span class="n">AnnData</span><span class="p">(</span>
        <span class="n">X</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
        <span class="n">obs</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="n">var</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genelist</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">layers</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="s2">&quot;disp&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
            <span class="s2">&quot;zero_logits&quot;</span><span class="p">:</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">pred_adata</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>


</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="scprint2.tasks.impute" class="doc doc-heading">
            <code>scprint2.tasks.impute</code>


</h2>

    <div class="doc doc-contents first">










<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="Imputer (scprint2.tasks.impute.Imputer)" href="#scprint2.tasks.impute.Imputer">Imputer</a></code></td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>







<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="scprint2.tasks.impute.Imputer" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">Imputer</span></code>

</h3>


    <div class="doc doc-contents ">



        <p>Imputer class for imputing missing values in scRNA-seq data using a scPRINT model</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>batch_size</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>10</code>
)
              –
              <div class="doc-md-description">
                <p>Batch size for processing. Defaults to 10.</p>
              </div>
            </li>
            <li>
              <b><code>num_workers</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>1</code>
)
              –
              <div class="doc-md-description">
                <p>Number of workers for data loading. Defaults to 1.</p>
              </div>
            </li>
            <li>
              <b><code>max_cells</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>500000</code>
)
              –
              <div class="doc-md-description">
                <p>Number of cells to use for plotting correlation. Defaults to 10000.</p>
              </div>
            </li>
            <li>
              <b><code>doplot</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to generate plots of the similarity between the denoised and true expression data. Defaults to False.
Only works when downsample_expr is not None and max_cells &lt; 100.</p>
              </div>
            </li>
            <li>
              <b><code>method</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>&#39;generative&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Imputation method, either 'masking' or 'generative'. Defaults to 'generative'.</p>
              </div>
            </li>
            <li>
              <b><code>predict_depth_mult</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>4</code>
)
              –
              <div class="doc-md-description">
                <p>Multiplier for prediction depth. Defaults to 4.
This will artificially increase the sequencing depth (or number of counts) to 4 times the original depth.</p>
              </div>
            </li>
            <li>
              <b><code>genes_to_use</code></b>
                  (<code><span title="typing.List">List</span>[<span title="str">str</span>]</code>)
              –
              <div class="doc-md-description">
                <p>List of genes to use for imputation. Defaults to None.</p>
              </div>
            </li>
            <li>
              <b><code>genes_to_impute</code></b>
                  (<code><span title="typing.List">List</span>[<span title="str">str</span>]</code>)
              –
              <div class="doc-md-description">
                <p>List of genes to impute. Defaults to None.</p>
              </div>
            </li>
            <li>
              <b><code>save_every</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>100000</code>
)
              –
              <div class="doc-md-description">
                <p>The number of cells to save at a time. Defaults to 100_000.
This is important to avoid memory issues.</p>
              </div>
            </li>
            <li>
              <b><code>apply_zero_pred</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to apply zero prediction adjustment. Defaults to True.
applying zero inflation might give results closer to the specific biases of sequencing technologies but less biological truthful.</p>
              </div>
            </li>
            <li>
              <b><code>use_knn</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to use k-nearest neighbors information. Defaults to True.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>










<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="__call__ (scprint2.tasks.impute.Imputer.__call__)" href="#scprint2.tasks.impute.Imputer.__call__">__call__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p><strong>call</strong> calling the function</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>



                  <details class="quote">
                    <summary>Source code in <code>scprint2/tasks/impute.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">genes_to_use</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">genes_to_impute</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">max_cells</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500_000</span><span class="p">,</span>
    <span class="n">doplot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;generative&quot;</span><span class="p">,</span>
    <span class="n">predict_depth_mult</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">save_every</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100_000</span><span class="p">,</span>
    <span class="n">apply_zero_pred</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">use_knn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Imputer class for imputing missing values in scRNA-seq data using a scPRINT model</span>

<span class="sd">    Args:</span>
<span class="sd">        batch_size (int, optional): Batch size for processing. Defaults to 10.</span>
<span class="sd">        num_workers (int, optional): Number of workers for data loading. Defaults to 1.</span>
<span class="sd">        max_cells (int, optional): Number of cells to use for plotting correlation. Defaults to 10000.</span>
<span class="sd">        doplot (bool, optional): Whether to generate plots of the similarity between the denoised and true expression data. Defaults to False.</span>
<span class="sd">            Only works when downsample_expr is not None and max_cells &lt; 100.</span>
<span class="sd">        method (str, optional): Imputation method, either &#39;masking&#39; or &#39;generative&#39;. Defaults to &#39;generative&#39;.</span>
<span class="sd">        predict_depth_mult (int, optional): Multiplier for prediction depth. Defaults to 4.</span>
<span class="sd">            This will artificially increase the sequencing depth (or number of counts) to 4 times the original depth.</span>
<span class="sd">        genes_to_use (List[str]): List of genes to use for imputation. Defaults to None.</span>
<span class="sd">        genes_to_impute (List[str]): List of genes to impute. Defaults to None.</span>
<span class="sd">        save_every (int, optional): The number of cells to save at a time. Defaults to 100_000.</span>
<span class="sd">            This is important to avoid memory issues.</span>
<span class="sd">        apply_zero_pred (bool, optional): Whether to apply zero prediction adjustment. Defaults to True.</span>
<span class="sd">            applying zero inflation might give results closer to the specific biases of sequencing technologies but less biological truthful.</span>
<span class="sd">        use_knn (bool, optional): Whether to use k-nearest neighbors information. Defaults to True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="o">=</span> <span class="n">num_workers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_cells</span> <span class="o">=</span> <span class="n">max_cells</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">doplot</span> <span class="o">=</span> <span class="n">doplot</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">predict_depth_mult</span> <span class="o">=</span> <span class="n">predict_depth_mult</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_every</span> <span class="o">=</span> <span class="n">save_every</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">genes_to_use</span> <span class="o">=</span> <span class="n">genes_to_use</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">genes_to_impute</span> <span class="o">=</span> <span class="n">genes_to_impute</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">apply_zero_pred</span> <span class="o">=</span> <span class="n">apply_zero_pred</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_knn</span> <span class="o">=</span> <span class="n">use_knn</span>
</code></pre></div></td></tr></table></div>
                  </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="scprint2.tasks.impute.Imputer.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__call__</span></code>

</h4>


    <div class="doc doc-contents ">

        <p><strong>call</strong> calling the function</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>model</code></b>
                  (<code><span title="torch.nn.Module">Module</span></code>)
              –
              <div class="doc-md-description">
                <p>The scPRINT model to be used for denoising.</p>
              </div>
            </li>
            <li>
              <b><code>adata</code></b>
                  (<code><span title="anndata.AnnData">AnnData</span></code>)
              –
              <div class="doc-md-description">
                <p>The anndata of shape n_obs x n_vars. Rows correspond to cells and columns to genes.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Optional">Optional</span>[<span title="numpy.ndarray">ndarray</span>]</code>
              –
              <div class="doc-md-description">
                <p>Optional[np.ndarray]: The random indices of the cells used when max_cells &lt; adata.shape[0].</p>
              </div>
            </li>
            <li>
<b><code>AnnData</code></b>(                  <code><span title="anndata.AnnData">AnnData</span></code>
)              –
              <div class="doc-md-description">
                <p>The imputed anndata.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>scprint2/tasks/impute.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">AnnData</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    __call__ calling the function</span>

<span class="sd">    Args:</span>
<span class="sd">        model (torch.nn.Module): The scPRINT model to be used for denoising.</span>
<span class="sd">        adata (AnnData): The anndata of shape n_obs x n_vars. Rows correspond to cells and columns to genes.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[np.ndarray]: The random indices of the cells used when max_cells &lt; adata.shape[0].</span>
<span class="sd">        AnnData: The imputed anndata.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Select random number</span>
    <span class="n">random_indices</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cells</span> <span class="o">&lt;</span> <span class="n">adata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">random_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
            <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cells</span>
        <span class="p">)</span>
        <span class="n">adataset</span> <span class="o">=</span> <span class="n">SimpleAnnDataset</span><span class="p">(</span>
            <span class="n">adata</span><span class="p">[</span><span class="n">random_indices</span><span class="p">],</span>
            <span class="n">obs_to_output</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;organism_ontology_term_id&quot;</span><span class="p">],</span>
            <span class="n">get_knn_cells</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_knn</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">adataset</span> <span class="o">=</span> <span class="n">SimpleAnnDataset</span><span class="p">(</span>
            <span class="n">adata</span><span class="p">,</span>
            <span class="n">obs_to_output</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;organism_ontology_term_id&quot;</span><span class="p">],</span>
            <span class="n">get_knn_cells</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_knn</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">genes_to_use</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">genes</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genes_to_use</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">genes_to_use</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genes_to_use</span><span class="p">)</span><span class="si">}</span><span class="s2">% of genes to use are available in the model&quot;</span>
    <span class="p">)</span>
    <span class="n">genes_to_impute</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">genes</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genes_to_impute</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">genes_to_impute</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genes_to_impute</span><span class="p">)</span><span class="si">}</span><span class="s2">% of genes to impute are available in the model&quot;</span>
    <span class="p">)</span>
    <span class="n">tot</span> <span class="o">=</span> <span class="n">genes_to_use</span> <span class="o">|</span> <span class="n">genes_to_impute</span>
    <span class="n">tot</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tot</span><span class="p">)</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">Collator</span><span class="p">(</span>
        <span class="n">organisms</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">organisms</span><span class="p">,</span>
        <span class="n">valid_genes</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">genes</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;some&quot;</span><span class="p">,</span>
        <span class="n">genelist</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">genes_to_use</span><span class="p">)</span>
        <span class="o">+</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">genes_to_impute</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;masking&quot;</span> <span class="k">else</span> <span class="p">[]),</span>
        <span class="n">n_bins</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">n_input_bins</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;binned&quot;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
        <span class="n">adataset</span><span class="p">,</span>
        <span class="n">collate_fn</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">generate_on</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;masking&quot;</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span>
            <span class="p">[</span><span class="n">i</span> <span class="ow">in</span> <span class="n">genes_to_use</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tot</span><span class="p">],</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;generative&quot;</span><span class="p">:</span>
        <span class="n">generate_on</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="n">model</span><span class="o">.</span><span class="n">genes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">genes_to_impute</span><span class="p">])</span>
            <span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="o">.</span><span class="n">long</span><span class="p">()</span>
            <span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;need to be one of generative or masking&quot;</span><span class="p">)</span>

    <span class="n">prevplot</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">doplot</span>
    <span class="n">model</span><span class="o">.</span><span class="n">doplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doplot</span>
    <span class="n">model</span><span class="o">.</span><span class="n">on_predict_epoch_start</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span>
    <span class="n">rand</span> <span class="o">=</span> <span class="n">random_str</span><span class="p">()</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">float16</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">transformer</span><span class="p">)</span> <span class="ow">is</span> <span class="n">FlashTransformer</span>
        <span class="k">else</span> <span class="n">model</span><span class="o">.</span><span class="n">dtype</span>
    <span class="p">)</span>
    <span class="n">save_expr</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">save_expr</span>
    <span class="n">model</span><span class="o">.</span><span class="n">save_expr</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
            <span class="n">gene_pos</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;genes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span>
                <span class="n">gene_pos</span><span class="p">,</span>
                <span class="n">expression</span><span class="p">,</span>
                <span class="n">depth</span><span class="p">,</span>
                <span class="n">knn_cells</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;knn_cells&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_knn</span>
                    <span class="k">else</span> <span class="kc">None</span>
                <span class="p">),</span>
                <span class="n">do_generate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;generative&quot;</span><span class="p">,</span>
                <span class="n">depth_mult</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_depth_mult</span><span class="p">,</span>
                <span class="n">max_size_in_mem</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">save_every</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;impute&quot;</span> <span class="o">+</span> <span class="n">rand</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
                <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                <span class="n">generate_on</span><span class="o">=</span><span class="n">generate_on</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">log_adata</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;impute&quot;</span> <span class="o">+</span> <span class="n">rand</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">counter</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mdir</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">save_dir</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">save_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;data&quot;</span>
        <span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">mdir</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span>
    <span class="n">pred_adata</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">mdir</span>
            <span class="o">+</span> <span class="s2">&quot;/step_&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">global_step</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
            <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span>
            <span class="o">+</span> <span class="s2">&quot;_impute&quot;</span>
            <span class="o">+</span> <span class="n">rand</span>
            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">global_rank</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;.h5ad&quot;</span>
        <span class="p">)</span>
        <span class="n">pred_adata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">pred_adata</span> <span class="o">=</span> <span class="n">concat</span><span class="p">(</span><span class="n">pred_adata</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">doplot</span> <span class="o">=</span> <span class="n">prevplot</span>
    <span class="n">model</span><span class="o">.</span><span class="n">save_expr</span> <span class="o">=</span> <span class="n">save_expr</span>

    <span class="c1"># pred_adata.X = adata.X if random_indices is None else adata.X[random_indices]</span>
    <span class="n">true_imp</span> <span class="o">=</span> <span class="n">pred_adata</span><span class="o">.</span><span class="n">X</span><span class="p">[:,</span> <span class="n">pred_adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">genes_to_impute</span><span class="p">)]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">true_imp</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># we had some gt</span>
        <span class="n">pred_imp</span> <span class="o">=</span> <span class="n">pred_adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;scprint_mu&quot;</span><span class="p">][</span>
            <span class="p">:,</span> <span class="n">pred_adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">genes_to_impute</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
        <span class="n">pred_known</span> <span class="o">=</span> <span class="n">pred_adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;scprint_mu&quot;</span><span class="p">][</span>
            <span class="p">:,</span> <span class="n">pred_adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">genes_to_use</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
        <span class="n">true_known</span> <span class="o">=</span> <span class="n">pred_adata</span><span class="o">.</span><span class="n">X</span><span class="p">[</span>
            <span class="p">:,</span> <span class="n">pred_adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">genes_to_use</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_zero_pred</span><span class="p">:</span>
            <span class="n">pred_imp</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pred_imp</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="mi">1</span>
                    <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span>
                        <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span>
                            <span class="n">pred_adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;scprint_pi&quot;</span><span class="p">][</span>
                                <span class="p">:,</span> <span class="n">pred_adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">genes_to_impute</span><span class="p">)</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">pred_known</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pred_known</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="mi">1</span>
                    <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span>
                        <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span>
                            <span class="n">pred_adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;scprint_pi&quot;</span><span class="p">][</span>
                                <span class="p">:,</span> <span class="n">pred_adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">genes_to_use</span><span class="p">)</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="n">cell_wise_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">spearmanr</span><span class="p">(</span><span class="n">pred_imp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">true_imp</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred_imp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">cell_wise_known</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">spearmanr</span><span class="p">(</span><span class="n">pred_known</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">true_known</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pred_known</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;cell_wise_known&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cell_wise_known</span><span class="p">),</span>
                <span class="s2">&quot;cell_wise_pred&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cell_wise_pred</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doplot</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;depth-wise plot&quot;</span><span class="p">)</span>
            <span class="n">plot_cell_depth_wise_corr_improvement</span><span class="p">(</span><span class="n">cell_wise_known</span><span class="p">,</span> <span class="n">cell_wise_pred</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">random_indices</span><span class="p">,</span> <span class="n">pred_adata</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>


</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="scprint2.tasks.finetune" class="doc doc-heading">
            <code>scprint2.tasks.finetune</code>


</h2>

    <div class="doc doc-contents first">










<p><span class="doc-section-title">Classes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><a class="autorefs autorefs-internal" title="FinetuneBatchClass (scprint2.tasks.finetune.FinetuneBatchClass)" href="#scprint2.tasks.finetune.FinetuneBatchClass">FinetuneBatchClass</a></code></td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
          </tr>
      </tbody>
    </table>




<p><span class="doc-section-title">Functions:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="mmd_loss (scprint2.tasks.finetune.mmd_loss)" href="#scprint2.tasks.finetune.mmd_loss">mmd_loss</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Compute Maximum Mean Discrepancy (MMD) loss between two 2D embedding matrices.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>





<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="scprint2.tasks.finetune.FinetuneBatchClass" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">FinetuneBatchClass</span></code>

</h3>


    <div class="doc doc-contents ">



        <p>Embedder a class to embed and annotate cells using a model</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>batch_key</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>&#39;batch&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>The key in adata.obs that indicates the batch information. Defaults to "batch".</p>
              </div>
            </li>
            <li>
              <b><code>learn_batches_on</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The key in adata.obs to learn batch embeddings on. Defaults to None.
if none, will not learn the batch embeddings.
the goal is e.g. when having a new species, to learn an embedding for it during finetuning and replace
the "learn_batches_on" embedding in the model with it, in this case it should be "organism_ontology_term_id".
batch correction might indeed be better learnt with this additional argument in some cases.</p>
              </div>
            </li>
            <li>
              <b><code>do_mmd_on</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The key in adata.obs to learn batch embeddings on. Defaults to None.
this embedding should have less batch information in it, after finetuning.</p>
              </div>
            </li>
            <li>
              <b><code>predict_keys</code></b>
                  (<code><span title="typing.List">List</span>[<span title="str">str</span>]</code>, default:
                      <code>[&#39;cell_type_ontology_term_id&#39;]</code>
)
              –
              <div class="doc-md-description">
                <p>List of keys in adata.obs to predict during fine-tuning. Defaults to ["cell_type_ontology_term_id"].</p>
              </div>
            </li>
            <li>
              <b><code>batch_size</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>16</code>
)
              –
              <div class="doc-md-description">
                <p>The size of the batches to be used in the DataLoader. Defaults to 64.</p>
              </div>
            </li>
            <li>
              <b><code>num_workers</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>8</code>
)
              –
              <div class="doc-md-description">
                <p>The number of worker processes to use for data loading. Defaults to 8.</p>
              </div>
            </li>
            <li>
              <b><code>max_len</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>5000</code>
)
              –
              <div class="doc-md-description">
                <p>The maximum length of the sequences to be processed. Defaults to 5000.</p>
              </div>
            </li>
            <li>
              <b><code>lr</code></b>
                  (<code><span title="float">float</span></code>, default:
                      <code>0.0002</code>
)
              –
              <div class="doc-md-description">
                <p>The learning rate for the optimizer. Defaults to 0.0002.</p>
              </div>
            </li>
            <li>
              <b><code>num_epochs</code></b>
                  (<code><span title="int">int</span></code>, default:
                      <code>8</code>
)
              –
              <div class="doc-md-description">
                <p>The number of epochs to train the model. Defaults to 8.</p>
              </div>
            </li>
            <li>
              <b><code>ft_mode</code></b>
                  (<code><span title="str">str</span></code>, default:
                      <code>&#39;xpressor&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>The fine-tuning mode, either "xpressor" or "full". Defaults to "xpressor".</p>
              </div>
            </li>
            <li>
              <b><code>frac_train</code></b>
                  (<code><span title="float">float</span></code>, default:
                      <code>0.8</code>
)
              –
              <div class="doc-md-description">
                <p>The fraction of data to be used for training. Defaults to 0.8.</p>
              </div>
            </li>
            <li>
              <b><code>loss_scalers</code></b>
                  (<code><span title="dict">dict</span></code>, default:
                      <code>{}</code>
)
              –
              <div class="doc-md-description">
                <p>A dictionary specifying the scaling factors for different loss components. Defaults to {}.
expr, class, mmd, kl, and any of the predict_keys can be specified.</p>
              </div>
            </li>
            <li>
              <b><code>use_knn</code></b>
                  (<code><span title="bool">bool</span></code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to use k-nearest neighbors information. Defaults to True.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>










<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="__call__ (scprint2.tasks.finetune.FinetuneBatchClass.__call__)" href="#scprint2.tasks.finetune.FinetuneBatchClass.__call__">__call__</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p><strong>call</strong> function to call the embedding</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>



                  <details class="quote">
                    <summary>Source code in <code>scprint2/tasks/finetune.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">batch_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;batch&quot;</span><span class="p">,</span>
    <span class="n">predict_keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cell_type_ontology_term_id&quot;</span><span class="p">],</span>
    <span class="n">max_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
    <span class="n">learn_batches_on</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
    <span class="n">num_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">do_mmd_on</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">lr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0002</span><span class="p">,</span>
    <span class="n">ft_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;xpressor&quot;</span><span class="p">,</span>
    <span class="n">frac_train</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
    <span class="n">loss_scalers</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">use_knn</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Embedder a class to embed and annotate cells using a model</span>

<span class="sd">    Args:</span>
<span class="sd">        batch_key (str, optional): The key in adata.obs that indicates the batch information. Defaults to &quot;batch&quot;.</span>
<span class="sd">        learn_batches_on (str, optional): The key in adata.obs to learn batch embeddings on. Defaults to None.</span>
<span class="sd">            if none, will not learn the batch embeddings.</span>
<span class="sd">            the goal is e.g. when having a new species, to learn an embedding for it during finetuning and replace</span>
<span class="sd">            the &quot;learn_batches_on&quot; embedding in the model with it, in this case it should be &quot;organism_ontology_term_id&quot;.</span>
<span class="sd">            batch correction might indeed be better learnt with this additional argument in some cases.</span>
<span class="sd">        do_mmd_on (str, optional):The key in adata.obs to learn batch embeddings on. Defaults to None.</span>
<span class="sd">            this embedding should have less batch information in it, after finetuning.</span>
<span class="sd">        predict_keys (List[str], optional): List of keys in adata.obs to predict during fine-tuning. Defaults to [&quot;cell_type_ontology_term_id&quot;].</span>
<span class="sd">        batch_size (int, optional): The size of the batches to be used in the DataLoader. Defaults to 64.</span>
<span class="sd">        num_workers (int, optional): The number of worker processes to use for data loading. Defaults to 8.</span>
<span class="sd">        max_len (int, optional): The maximum length of the sequences to be processed. Defaults to 5000.</span>
<span class="sd">        lr (float, optional): The learning rate for the optimizer. Defaults to 0.0002.</span>
<span class="sd">        num_epochs (int, optional): The number of epochs to train the model. Defaults to 8.</span>
<span class="sd">        ft_mode (str, optional): The fine-tuning mode, either &quot;xpressor&quot; or &quot;full&quot;. Defaults to &quot;xpressor&quot;.</span>
<span class="sd">        frac_train (float, optional): The fraction of data to be used for training. Defaults to 0.8.</span>
<span class="sd">        loss_scalers (dict, optional): A dictionary specifying the scaling factors for different loss components. Defaults to {}.</span>
<span class="sd">            expr, class, mmd, kl, and any of the predict_keys can be specified.</span>
<span class="sd">        use_knn (bool, optional): Whether to use k-nearest neighbors information. Defaults to True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="o">=</span> <span class="n">num_workers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">batch_key</span> <span class="o">=</span> <span class="n">batch_key</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">learn_batches_on</span> <span class="o">=</span> <span class="n">learn_batches_on</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">predict_keys</span> <span class="o">=</span> <span class="n">predict_keys</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="n">max_len</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_epochs</span> <span class="o">=</span> <span class="n">num_epochs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ft_mode</span> <span class="o">=</span> <span class="n">ft_mode</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">frac_train</span> <span class="o">=</span> <span class="n">frac_train</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">batch_emb</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">batch_encoder</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">do_mmd_on</span> <span class="o">=</span> <span class="n">do_mmd_on</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loss_scalers</span> <span class="o">=</span> <span class="n">loss_scalers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_knn</span> <span class="o">=</span> <span class="n">use_knn</span>
</code></pre></div></td></tr></table></div>
                  </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="scprint2.tasks.finetune.FinetuneBatchClass.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__call__</span></code>

</h4>


    <div class="doc doc-contents ">

        <p><strong>call</strong> function to call the embedding</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>model</code></b>
                  (<code><span title="torch.nn.Module">Module</span></code>)
              –
              <div class="doc-md-description">
                <p>The scPRINT model to be used for embedding and annotation.</p>
              </div>
            </li>
            <li>
              <b><code>adata</code></b>
                  (<code><span title="anndata.AnnData">AnnData</span></code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The annotated data matrix of shape n_obs x n_vars. Rows correspond to cells and columns to genes.
Defaults to None.
if provided, it will be split into training and validation sets.</p>
              </div>
            </li>
            <li>
              <b><code>train_data</code></b>
                  (<code><span title="anndata.AnnData">AnnData</span></code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The training data. Defaults to None.
if adata is provided, this will be ignored.</p>
              </div>
            </li>
            <li>
              <b><code>val_data</code></b>
                  (<code><span title="anndata.AnnData">AnnData</span></code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The validation data. Defaults to None.
if adata is provided, this will be ignored.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
                <p>If the model does not have a logger attribute.</p>
              </div>
            </li>
            <li>
                  <code><span title="ValueError">ValueError</span></code>
              –
              <div class="doc-md-description">
                <p>If the model does not have a global_step attribute.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="torch.nn.Module">Module</span></code>
              –
              <div class="doc-md-description">
                <p>torch.nn.Module: the fine-tuned model</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>scprint2/tasks/finetune.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
    <span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">train_data</span><span class="p">:</span> <span class="n">AnnData</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">val_data</span><span class="p">:</span> <span class="n">AnnData</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    __call__ function to call the embedding</span>

<span class="sd">    Args:</span>
<span class="sd">        model (torch.nn.Module): The scPRINT model to be used for embedding and annotation.</span>
<span class="sd">        adata (AnnData): The annotated data matrix of shape n_obs x n_vars. Rows correspond to cells and columns to genes.</span>
<span class="sd">            Defaults to None.</span>
<span class="sd">            if provided, it will be split into training and validation sets.</span>
<span class="sd">        train_data (AnnData, optional): The training data. Defaults to None.</span>
<span class="sd">            if adata is provided, this will be ignored.</span>
<span class="sd">        val_data (AnnData, optional): The validation data. Defaults to None.</span>
<span class="sd">            if adata is provided, this will be ignored.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the model does not have a logger attribute.</span>
<span class="sd">        ValueError: If the model does not have a global_step attribute.</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.nn.Module: the fine-tuned model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># one of &quot;all&quot; &quot;sample&quot; &quot;none&quot;</span>
    <span class="n">model</span><span class="o">.</span><span class="n">predict_mode</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ft_mode</span> <span class="o">==</span> <span class="s2">&quot;xpressor&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
            <span class="n">val</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># setting all to TRUE</span>

        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">cell_transformer</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
            <span class="n">val</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
            <span class="n">val</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">blocks</span><span class="p">:</span>
            <span class="n">i</span><span class="o">.</span><span class="n">cross_attn</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">compressor</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
            <span class="n">val</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_keys</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">cls_decoders</span><span class="p">[</span><span class="n">val</span><span class="p">]</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
                <span class="n">val</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ft_mode</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
            <span class="n">val</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ft_mode must be one of &#39;xpressor&#39; or &#39;full&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># PREPARING THE DATA</span>
    <span class="k">if</span> <span class="n">adata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frac_train</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">adata</span><span class="p">))</span>
        <span class="n">train_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">adata</span><span class="p">),</span> <span class="n">n_train</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">val_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">adata</span><span class="p">)),</span> <span class="n">train_idx</span><span class="p">)</span>

        <span class="n">train_data</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">train_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">val_data</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training data: </span><span class="si">{</span><span class="n">train_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation data: </span><span class="si">{</span><span class="n">val_data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">mencoders</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">label_decoders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">mencoders</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">va</span><span class="p">:</span> <span class="n">ke</span> <span class="k">for</span> <span class="n">ke</span><span class="p">,</span> <span class="n">va</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="c1"># this needs to remain its original name as it is expect like that by collator, otherwise need to send org_to_id as params</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">train_data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">mencoders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;missing labels for &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">train_data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mencoders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
            <span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;organism_ontology_term_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_keys</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;organism_ontology_term_id&quot;</span><span class="p">)</span>
    <span class="c1"># create datasets</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">batch_encoder</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">i</span><span class="p">:</span> <span class="n">n</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="n">train_data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_key</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span>
        <span class="p">)</span>
    <span class="p">}</span>
    <span class="n">mencoders</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_encoder</span>
    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">SimpleAnnDataset</span><span class="p">(</span>
        <span class="n">train_data</span><span class="p">,</span>
        <span class="n">obs_to_output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_keys</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_key</span><span class="p">],</span>
        <span class="n">get_knn_cells</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_knn</span><span class="p">,</span>
        <span class="n">encoder</span><span class="o">=</span><span class="n">mencoders</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">val_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="s2">&quot;organism_ontology_term_id&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">val_data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">mencoders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">val_data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mencoders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;unknown&quot;</span>
                    <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_encoder</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="n">i</span><span class="p">:</span> <span class="n">n</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_encoder</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="n">val_data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_key</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_encoder</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">mencoders</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_encoder</span>
        <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">SimpleAnnDataset</span><span class="p">(</span>
            <span class="n">val_data</span><span class="p">,</span>
            <span class="n">obs_to_output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_keys</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_key</span><span class="p">],</span>
            <span class="n">get_knn_cells</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">expr_emb_style</span> <span class="o">==</span> <span class="s2">&quot;metacell&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_knn</span><span class="p">,</span>
            <span class="n">encoder</span><span class="o">=</span><span class="n">mencoders</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Create collator</span>
    <span class="n">collator</span> <span class="o">=</span> <span class="n">Collator</span><span class="p">(</span>
        <span class="n">organisms</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">organisms</span><span class="p">,</span>
        <span class="n">valid_genes</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">genes</span><span class="p">,</span>
        <span class="n">class_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_keys</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_key</span><span class="p">],</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;random expr&quot;</span><span class="p">,</span>  <span class="c1"># or &quot;all expr&quot; for full expression</span>
        <span class="n">max_len</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">,</span>
        <span class="n">org_to_id</span><span class="o">=</span><span class="n">mencoders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;organism_ontology_term_id&quot;</span><span class="p">,</span> <span class="p">{}),</span>
    <span class="p">)</span>

    <span class="c1"># Create data loaders</span>
    <span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
        <span class="n">train_dataset</span><span class="p">,</span>
        <span class="n">collate_fn</span><span class="o">=</span><span class="n">collator</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>  <span class="c1"># Adjust based on GPU memory</span>
        <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">val_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">val_dataset</span><span class="p">,</span>
            <span class="n">collate_fn</span><span class="o">=</span><span class="n">collator</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn_batches_on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">val_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;all batch key values in val_data should also be present in train_adata!!!&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_emb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span>
            <span class="n">num_embeddings</span><span class="o">=</span><span class="n">train_data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_key</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span>
            <span class="n">embedding_dim</span><span class="o">=</span><span class="p">(</span>
                <span class="n">model</span><span class="o">.</span><span class="n">compressor</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">learn_batches_on</span><span class="p">]</span><span class="o">.</span><span class="n">fc_mu</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;compressor&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">model</span><span class="o">.</span><span class="n">d_model</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="c1">## PREPARING THE OPTIM</span>
    <span class="n">all_params</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
        <span class="c1"># + list(batch_cls.parameters())</span>
        <span class="o">+</span> <span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_emb</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn_batches_on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="p">[]</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Setup optimizer</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span>
        <span class="n">all_params</span><span class="p">,</span>
        <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">,</span>
        <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
        <span class="n">betas</span><span class="o">=</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.999</span><span class="p">),</span>
        <span class="n">eps</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Setup scheduler</span>
    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">ReduceLROnPlateau</span><span class="p">(</span>
        <span class="n">optimizer</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>

    <span class="c1"># Setup automatic mixed precision</span>
    <span class="n">scaler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">amp</span><span class="o">.</span><span class="n">GradScaler</span><span class="p">()</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">mat_labels_hierarchy</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">model</span><span class="o">.</span><span class="n">mat_labels_hierarchy</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="c1">## train</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_epochs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current learning rate: </span><span class="si">{</span><span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Training phase</span>
        <span class="n">train_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">train_steps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">avg_expr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">avg_cls</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">avg_mmd</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Training&quot;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pbar</span><span class="p">):</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">total_loss</span><span class="p">,</span> <span class="n">cls_loss</span><span class="p">,</span> <span class="n">mmd</span><span class="p">,</span> <span class="n">loss_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_corr_pass</span><span class="p">(</span>
                <span class="n">batch</span><span class="p">,</span> <span class="n">model</span>
            <span class="p">)</span>
            <span class="c1"># Backward pass</span>
            <span class="n">scaler</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">total_loss</span><span class="p">)</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">scaler</span><span class="o">.</span><span class="n">unscale_</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">max_norm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">scaler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span>
            <span class="n">scaler</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

            <span class="n">train_loss</span> <span class="o">+=</span> <span class="n">total_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">train_steps</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">avg_cls</span> <span class="o">+=</span> <span class="n">cls_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">avg_expr</span> <span class="o">+=</span> <span class="n">loss_expr</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">avg_mmd</span> <span class="o">+=</span> <span class="n">mmd</span>
            <span class="c1"># Update progress bar</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">total_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;avg_loss&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">train_loss</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">train_steps</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;cls_loss&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cls_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;mmd_loss&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mmd</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expr_loss&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">loss_expr</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="c1"># Validation phase</span>
        <span class="k">if</span> <span class="n">val_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
            <span class="n">val_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">val_steps</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">val_loss_expr</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">val_mmd</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">val_cls</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">val_loss_to_prt</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">val_loader</span><span class="p">:</span>  <span class="c1"># tqdm(val_loader, desc=&quot;Validation&quot;):</span>
                    <span class="n">loss_val</span><span class="p">,</span> <span class="n">cls_loss</span><span class="p">,</span> <span class="n">mmd</span><span class="p">,</span> <span class="n">loss_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_corr_pass</span><span class="p">(</span>
                        <span class="n">batch</span><span class="p">,</span> <span class="n">model</span>
                    <span class="p">)</span>
                    <span class="n">val_loss_to_prt</span> <span class="o">+=</span> <span class="n">loss_val</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                    <span class="n">val_loss</span> <span class="o">+=</span> <span class="n">loss_val</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                    <span class="n">val_steps</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">val_loss_expr</span> <span class="o">+=</span> <span class="n">loss_expr</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                    <span class="n">val_mmd</span> <span class="o">+=</span> <span class="n">mmd</span>
                    <span class="n">val_cls</span> <span class="o">+=</span> <span class="n">cls_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">avg_val_loss</span> <span class="o">=</span> <span class="n">val_loss_to_prt</span> <span class="o">/</span> <span class="n">val_steps</span>
                <span class="n">avg_train_loss</span> <span class="o">=</span> <span class="n">train_loss</span> <span class="o">/</span> <span class="n">train_steps</span>
            <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Error: Division by zero occurred while calculating average losses.&quot;</span>
                <span class="p">)</span>
                <span class="n">avg_train_loss</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;cls_loss: </span><span class="si">{:.4f}</span><span class="s2">, mmd_loss: </span><span class="si">{:.4f}</span><span class="s2">, expr_loss: </span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">val_cls</span> <span class="o">/</span> <span class="n">val_steps</span><span class="p">,</span>
                    <span class="n">val_mmd</span> <span class="o">/</span> <span class="n">val_steps</span><span class="p">,</span>
                    <span class="n">val_loss_expr</span> <span class="o">/</span> <span class="n">val_steps</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train Loss: </span><span class="si">{</span><span class="n">avg_train_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Val Loss: </span><span class="si">{</span><span class="n">avg_val_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Store LR before scheduler step for comparison</span>
            <span class="n">lr_before</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;lr&quot;</span><span class="p">]</span>

            <span class="c1"># Update learning rate</span>
            <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">avg_val_loss</span><span class="p">)</span>

            <span class="c1"># Check if LR was reduced</span>
            <span class="n">lr_after</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">param_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;lr&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">lr_after</span> <span class="o">&lt;</span> <span class="n">lr_before</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;🔻 Learning rate reduced from </span><span class="si">{</span><span class="n">lr_before</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">lr_after</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2"> (factor: </span><span class="si">{</span><span class="n">lr_after</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">lr_before</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Learning rate unchanged: </span><span class="si">{</span><span class="n">lr_after</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Early stopping check (simple implementation)</span>
            <span class="k">if</span> <span class="n">epoch</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">val_loss</span> <span class="o">/</span> <span class="n">val_steps</span> <span class="o">&gt;</span> <span class="mf">1.3</span> <span class="o">*</span> <span class="n">avg_train_loss</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Early stopping due to overfitting&quot;</span><span class="p">)</span>
                <span class="k">break</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Manual fine-tuning completed!&quot;</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>


</div>


<div class="doc doc-object doc-function">


<h3 id="scprint2.tasks.finetune.mmd_loss" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">mmd_loss</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute Maximum Mean Discrepancy (MMD) loss between two 2D embedding matrices.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>X</code></b>
                  (<code><span title="torch.Tensor">Tensor</span></code>)
              –
              <div class="doc-md-description">
                <p>Tensor of shape (n1, emb_dim) - first set of embeddings</p>
              </div>
            </li>
            <li>
              <b><code>Y</code></b>
                  (<code><span title="torch.Tensor">Tensor</span></code>)
              –
              <div class="doc-md-description">
                <p>Tensor of shape (n2, emb_dim) - second set of embeddings</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="torch.Tensor">Tensor</span></code>
              –
              <div class="doc-md-description">
                <p>torch.Tensor: MMD loss value (negative to encourage dissimilarity)</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>scprint2/tasks/finetune.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">mmd_loss</span><span class="p">(</span><span class="n">X</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Y</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute Maximum Mean Discrepancy (MMD) loss between two 2D embedding matrices.</span>

<span class="sd">    Args:</span>
<span class="sd">        X (torch.Tensor): Tensor of shape (n1, emb_dim) - first set of embeddings</span>
<span class="sd">        Y (torch.Tensor): Tensor of shape (n2, emb_dim) - second set of embeddings</span>

<span class="sd">    Returns:</span>
<span class="sd">        torch.Tensor: MMD loss value (negative to encourage dissimilarity)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rbf_kernel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute RBF kernel between two sets of vectors&quot;&quot;&quot;</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">distance</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">energy_kernel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute Energy kernel between two sets of vectors&quot;&quot;&quot;</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cdist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">distance</span>

    <span class="c1"># Use multiple kernel bandwidths for better performance</span>
    <span class="n">sigmas</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># [0.1, 1.0, 10.0]</span>
    <span class="n">mmd_loss</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">for</span> <span class="n">sigma</span> <span class="ow">in</span> <span class="n">sigmas</span><span class="p">:</span>
        <span class="c1"># K(X, X) - kernel matrix within first group (n1 x n1)</span>
        <span class="c1"># k_xx = rbf_kernel(X, X, sigma)</span>
        <span class="n">k_xx</span> <span class="o">=</span> <span class="n">energy_kernel</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
        <span class="c1"># K(Y, Y) - kernel matrix within second group (n2 x n2)</span>
        <span class="c1"># k_yy = rbf_kernel(Y, Y, sigma)</span>
        <span class="n">k_yy</span> <span class="o">=</span> <span class="n">energy_kernel</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
        <span class="c1"># K(X, Y) - kernel matrix between groups (n1 x n2)</span>
        <span class="c1"># k_xy = rbf_kernel(X, Y, sigma)</span>
        <span class="n">k_xy</span> <span class="o">=</span> <span class="n">energy_kernel</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>

        <span class="c1"># Unbiased MMD estimation</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Remove diagonal elements for unbiased estimation of K(X,X) and K(Y,Y)</span>
        <span class="c1"># For K(X,X): exclude diagonal</span>
        <span class="k">if</span> <span class="n">n1</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mask_xx</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">k_xx_term</span> <span class="o">=</span> <span class="p">(</span><span class="n">k_xx</span> <span class="o">*</span> <span class="n">mask_xx</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">n1</span> <span class="o">*</span> <span class="p">(</span><span class="n">n1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k_xx_term</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># For K(Y,Y): exclude diagonal</span>
        <span class="k">if</span> <span class="n">n2</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mask_yy</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">Y</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">k_yy_term</span> <span class="o">=</span> <span class="p">(</span><span class="n">k_yy</span> <span class="o">*</span> <span class="n">mask_yy</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">n2</span> <span class="o">*</span> <span class="p">(</span><span class="n">n2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k_yy_term</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># For K(X,Y): use all elements (no diagonal to exclude)</span>
        <span class="n">k_xy_term</span> <span class="o">=</span> <span class="n">k_xy</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># MMD^2 = E[K(X,X)] + E[K(Y,Y)] - 2*E[K(X,Y)]</span>
        <span class="n">mmd_squared</span> <span class="o">=</span> <span class="n">k_xx_term</span> <span class="o">+</span> <span class="n">k_yy_term</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">k_xy_term</span>
        <span class="n">mmd_loss</span> <span class="o">+=</span> <span class="n">mmd_squared</span>

    <span class="c1"># Return negative MMD to encourage dissimilarity (higher MMD = more different)</span>
    <span class="k">return</span> <span class="n">mmd_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">sigmas</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../tokenizers/" class="btn btn-neutral float-left" title="tokenizers"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../utils/" class="btn btn-neutral float-right" title="utils">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../tokenizers/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../utils/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
