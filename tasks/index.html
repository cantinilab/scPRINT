<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://www.jkobject.com/scPRINT/tasks/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>tasks - scprint</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "tasks";
        var mkdocs_page_input_path = "tasks.md";
        var mkdocs_page_url = "/scPRINT/tasks/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> scprint
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../structure/">structure</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../pretrain/">pre-training</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../usage/">usage example</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">example notebooks</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../notebooks/cancer_usecase/">scPRINT use case on BPH</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../notebooks/cancer_usecase_part2/">scPRINT use case on BPH (part 2, GN analysis)</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">documentation</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../model/">model</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">tasks</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#scprint.tasks.cell_emb">cell_emb</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#scprint.tasks.cell_emb.Embedder">Embedder</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#scprint.tasks.cell_emb.Embedder.__call__">__call__</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scprint.tasks.cell_emb.compute_classification">compute_classification</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scprint.tasks.cell_emb.compute_corr">compute_corr</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scprint.tasks.cell_emb.default_benchmark">default_benchmark</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#scprint.tasks.grn">grn</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#scprint.tasks.grn.GNInfer">GNInfer</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#scprint.tasks.grn.GNInfer.__call__">__call__</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scprint.tasks.grn.default_benchmark">default_benchmark</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#scprint.tasks.denoise">denoise</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#scprint.tasks.denoise.Denoiser">Denoiser</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#scprint.tasks.denoise.Denoiser.__call__">__call__</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scprint.tasks.denoise.default_benchmark">default_benchmark</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#scprint.tasks.denoise.split_molecules">split_molecules</a>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cli/">cli</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../embedder/">embedders</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../utils/">utils</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">scprint</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">documentation</li>
      <li class="breadcrumb-item active">tasks</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="documentation-for-the-tasks">Documentation for the <code>tasks</code></h1>


<div class="doc doc-object doc-module">



<h2 id="scprint.tasks.cell_emb" class="doc doc-heading">
            <code>scprint.tasks.cell_emb</code>


</h2>

    <div class="doc doc-contents first">



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="scprint.tasks.cell_emb.Embedder" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">Embedder</span></code>

</h3>


    <div class="doc doc-contents ">


        <p>Embedder a class to embed and annotate cells using a model</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>batch_size</code></b>
                  (<code>int</code>, default:
                      <code>64</code>
)
              –
              <div class="doc-md-description">
                <p>The size of the batches to be used in the DataLoader. Defaults to 64.</p>
              </div>
            </li>
            <li>
              <b><code>num_workers</code></b>
                  (<code>int</code>, default:
                      <code>8</code>
)
              –
              <div class="doc-md-description">
                <p>The number of worker processes to use for data loading. Defaults to 8.</p>
              </div>
            </li>
            <li>
              <b><code>how</code></b>
                  (<code>str</code>, default:
                      <code>&#39;random expr&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>The method to be used for selecting valid genes. Defaults to "random expr".</p>
              </div>
            </li>
            <li>
              <b><code>max_len</code></b>
                  (<code>int</code>, default:
                      <code>2000</code>
)
              –
              <div class="doc-md-description">
                <p>The maximum length of the gene sequence. Defaults to 1000.</p>
              </div>
            </li>
            <li>
              <b><code>add_zero_genes</code></b>
                  (<code>int</code>, default:
                      <code>0</code>
)
              –
              <div class="doc-md-description">
                <p>The number of zero genes to add to the gene sequence. Defaults to 100.</p>
              </div>
            </li>
            <li>
              <b><code>precision</code></b>
                  (<code>str</code>, default:
                      <code>&#39;16-mixed&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>The precision to be used in the Trainer. Defaults to "16-mixed".</p>
              </div>
            </li>
            <li>
              <b><code>pred_embedding</code></b>
                  (<code><span title="typing.List">List</span>[str]</code>, default:
                      <code>[&#39;cell_type_ontology_term_id&#39;, &#39;disease_ontology_term_id&#39;, &#39;self_reported_ethnicity_ontology_term_id&#39;, &#39;sex_ontology_term_id&#39;]</code>
)
              –
              <div class="doc-md-description">
                <p>The list of labels to be used for plotting embeddings. Defaults to [ "cell_type_ontology_term_id", "disease_ontology_term_id", "self_reported_ethnicity_ontology_term_id", "sex_ontology_term_id", ].</p>
              </div>
            </li>
            <li>
              <b><code>doclass</code></b>
                  (<code>bool</code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to perform classification. Defaults to True.</p>
              </div>
            </li>
            <li>
              <b><code>doplot</code></b>
                  (<code>bool</code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to generate plots. Defaults to True.</p>
              </div>
            </li>
            <li>
              <b><code>keep_all_cls_pred</code></b>
                  (<code>bool</code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to keep all class predictions. Defaults to False.</p>
              </div>
            </li>
            <li>
              <b><code>dtype</code></b>
                  (<code><span title="torch.dtype">dtype</span></code>, default:
                      <code><span title="torch.float16">float16</span></code>
)
              –
              <div class="doc-md-description">
                <p>Data type for computations. Defaults to torch.float16.</p>
              </div>
            </li>
            <li>
              <b><code>output_expression</code></b>
                  (<code>str</code>, default:
                      <code>&#39;none&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>The method to output expression data. Options are "none", "all", "sample". Defaults to "none".</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
                  <details class="quote">
                    <summary>Source code in <code>scprint/tasks/cell_emb.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">how</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;random expr&quot;</span><span class="p">,</span>
    <span class="n">max_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>
    <span class="n">doclass</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">add_zero_genes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">precision</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;16-mixed&quot;</span><span class="p">,</span>
    <span class="n">pred_embedding</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;cell_type_ontology_term_id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;disease_ontology_term_id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;self_reported_ethnicity_ontology_term_id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sex_ontology_term_id&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">plot_corr_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
    <span class="n">doplot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">keep_all_cls_pred</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span>
    <span class="n">output_expression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Embedder a class to embed and annotate cells using a model</span>

<span class="sd">    Args:</span>
<span class="sd">        batch_size (int, optional): The size of the batches to be used in the DataLoader. Defaults to 64.</span>
<span class="sd">        num_workers (int, optional): The number of worker processes to use for data loading. Defaults to 8.</span>
<span class="sd">        how (str, optional): The method to be used for selecting valid genes. Defaults to &quot;random expr&quot;.</span>
<span class="sd">        max_len (int, optional): The maximum length of the gene sequence. Defaults to 1000.</span>
<span class="sd">        add_zero_genes (int, optional): The number of zero genes to add to the gene sequence. Defaults to 100.</span>
<span class="sd">        precision (str, optional): The precision to be used in the Trainer. Defaults to &quot;16-mixed&quot;.</span>
<span class="sd">        pred_embedding (List[str], optional): The list of labels to be used for plotting embeddings. Defaults to [ &quot;cell_type_ontology_term_id&quot;, &quot;disease_ontology_term_id&quot;, &quot;self_reported_ethnicity_ontology_term_id&quot;, &quot;sex_ontology_term_id&quot;, ].</span>
<span class="sd">        doclass (bool, optional): Whether to perform classification. Defaults to True.</span>
<span class="sd">        doplot (bool, optional): Whether to generate plots. Defaults to True.</span>
<span class="sd">        keep_all_cls_pred (bool, optional): Whether to keep all class predictions. Defaults to False.</span>
<span class="sd">        dtype (torch.dtype, optional): Data type for computations. Defaults to torch.float16.</span>
<span class="sd">        output_expression (str, optional): The method to output expression data. Options are &quot;none&quot;, &quot;all&quot;, &quot;sample&quot;. Defaults to &quot;none&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="o">=</span> <span class="n">num_workers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">=</span> <span class="n">how</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="n">max_len</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_zero_genes</span> <span class="o">=</span> <span class="n">add_zero_genes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pred_embedding</span> <span class="o">=</span> <span class="n">pred_embedding</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">keep_all_cls_pred</span> <span class="o">=</span> <span class="n">keep_all_cls_pred</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">plot_corr_size</span> <span class="o">=</span> <span class="n">plot_corr_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">doplot</span> <span class="o">=</span> <span class="n">doplot</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">doclass</span> <span class="o">=</span> <span class="n">doclass</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output_expression</span> <span class="o">=</span> <span class="n">output_expression</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="scprint.tasks.cell_emb.Embedder.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__call__</span></code>

</h4>


    <div class="doc doc-contents ">

        <p><strong>call</strong> function to call the embedding</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>model</code></b>
                  (<code><span title="torch.nn.Module">Module</span></code>)
              –
              <div class="doc-md-description">
                <p>The scPRINT model to be used for embedding and annotation.</p>
              </div>
            </li>
            <li>
              <b><code>adata</code></b>
                  (<code><span title="anndata.AnnData">AnnData</span></code>)
              –
              <div class="doc-md-description">
                <p>The annotated data matrix of shape n_obs x n_vars. Rows correspond to cells and columns to genes.</p>
              </div>
            </li>
            <li>
              <b><code>cache</code></b>
                  (<code>bool</code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to use cached results if available. Defaults to False.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code>ValueError</code>
              –
              <div class="doc-md-description">
                <p>If the model does not have a logger attribute.</p>
              </div>
            </li>
            <li>
                  <code>ValueError</code>
              –
              <div class="doc-md-description">
                <p>If the model does not have a global_step attribute.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>AnnData</code></b>              –
              <div class="doc-md-description">
                <p>The annotated data matrix with embedded cell representations.</p>
              </div>
            </li>
            <li>
              –
              <div class="doc-md-description">
                <p>List[str]: List of gene names used in the embedding.</p>
              </div>
            </li>
            <li>
              –
              <div class="doc-md-description">
                <p>np.ndarray: The predicted expression values if output_expression is not "none".</p>
              </div>
            </li>
            <li>
<b><code>dict</code></b>              –
              <div class="doc-md-description">
                <p>Additional metrics and information from the embedding process.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>scprint/tasks/cell_emb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    __call__ function to call the embedding</span>

<span class="sd">    Args:</span>
<span class="sd">        model (torch.nn.Module): The scPRINT model to be used for embedding and annotation.</span>
<span class="sd">        adata (AnnData): The annotated data matrix of shape n_obs x n_vars. Rows correspond to cells and columns to genes.</span>
<span class="sd">        cache (bool, optional): Whether to use cached results if available. Defaults to False.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the model does not have a logger attribute.</span>
<span class="sd">        ValueError: If the model does not have a global_step attribute.</span>

<span class="sd">    Returns:</span>
<span class="sd">        AnnData: The annotated data matrix with embedded cell representations.</span>
<span class="sd">        List[str]: List of gene names used in the embedding.</span>
<span class="sd">        np.ndarray: The predicted expression values if output_expression is not &quot;none&quot;.</span>
<span class="sd">        dict: Additional metrics and information from the embedding process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># one of &quot;all&quot; &quot;sample&quot; &quot;none&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mdir</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">save_dir</span> <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">save_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;data&quot;</span>
        <span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">mdir</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">file</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">mdir</span>
            <span class="o">+</span> <span class="s2">&quot;/step_&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">global_step</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;_predict_part_&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">counter</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">global_rank</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;.h5ad&quot;</span>
        <span class="p">)</span>
        <span class="n">hasfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">hasfile</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">cache</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">hasfile</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">predict_mode</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
        <span class="n">model</span><span class="o">.</span><span class="n">keep_all_cls_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_all_cls_pred</span>
        <span class="c1"># Add at least the organism you are working with</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;most var&quot;</span><span class="p">:</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">highly_variable_genes</span><span class="p">(</span>
                <span class="n">adata</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s2">&quot;seurat_v3&quot;</span><span class="p">,</span> <span class="n">n_top_genes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span>
            <span class="p">)</span>
            <span class="n">curr_genes</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">highly_variable</span><span class="p">]</span>
        <span class="n">adataset</span> <span class="o">=</span> <span class="n">SimpleAnnDataset</span><span class="p">(</span>
            <span class="n">adata</span><span class="p">,</span> <span class="n">obs_to_output</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;organism_ontology_term_id&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">Collator</span><span class="p">(</span>
            <span class="n">organisms</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">organisms</span><span class="p">,</span>
            <span class="n">valid_genes</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">genes</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">!=</span> <span class="s2">&quot;most var&quot;</span> <span class="k">else</span> <span class="s2">&quot;some&quot;</span><span class="p">,</span>
            <span class="n">max_len</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">,</span>
            <span class="n">add_zero_genes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">add_zero_genes</span><span class="p">,</span>
            <span class="n">genelist</span><span class="o">=</span><span class="p">[]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">!=</span> <span class="s2">&quot;most var&quot;</span> <span class="k">else</span> <span class="n">curr_genes</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">adataset</span><span class="p">,</span>
            <span class="n">collate_fn</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">on_predict_epoch_start</span><span class="p">()</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span>
        <span class="n">model</span><span class="o">.</span><span class="n">doplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doplot</span>
        <span class="k">with</span> <span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">(),</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
                <span class="n">gene_pos</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;genes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
                    <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
                    <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span>
                    <span class="n">gene_pos</span><span class="p">,</span>
                    <span class="n">expression</span><span class="p">,</span>
                    <span class="n">depth</span><span class="p">,</span>
                    <span class="n">predict_mode</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                    <span class="n">pred_embedding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pred_embedding</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">log_adata</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;predict_part_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">counter</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mdir</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">model</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">save_dir</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">save_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="s2">&quot;data&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">mdir</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span>
        <span class="n">file</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">mdir</span>
            <span class="o">+</span> <span class="s2">&quot;/step_&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">global_step</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
            <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">name</span>
            <span class="o">+</span> <span class="s2">&quot;_predict_part_&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">counter</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">global_rank</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;.h5ad&quot;</span>
        <span class="p">)</span>

    <span class="n">pred_adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_expression</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;scprint_mu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">expr_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;scprint_theta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">expr_pred</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;scprint_pi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">expr_pred</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;scprint_pos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_expression</span> <span class="o">==</span> <span class="s2">&quot;sample&quot;</span><span class="p">:</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;scprint_expr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">zinb_sample</span><span class="p">(</span>
                <span class="n">model</span><span class="o">.</span><span class="n">expr_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">model</span><span class="o">.</span><span class="n">expr_pred</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">model</span><span class="o">.</span><span class="n">expr_pred</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
            <span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;scprint_pos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_expression</span> <span class="o">==</span> <span class="s2">&quot;old&quot;</span><span class="p">:</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">expr_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">expr</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span>
                <span class="mi">1</span><span class="p">,</span>
                <span class="n">p</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">expr_pred</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">),</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">expr</span><span class="p">[</span><span class="n">expr</span> <span class="o">&lt;=</span> <span class="mf">0.3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">expr</span><span class="p">[(</span><span class="n">expr</span> <span class="o">&gt;=</span> <span class="mf">0.3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">expr</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;scprint_expr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;scprint_pos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">pred_adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;scprint_umap&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;X_umap&quot;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;too few cells to embed into a umap&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;scprint_leiden&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;leiden&quot;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;too few cells to compute a clustering&quot;</span><span class="p">)</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;scprint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_adata</span><span class="o">.</span><span class="n">X</span>
    <span class="n">pred_adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">pred_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_all_cls_pred</span><span class="p">:</span>
        <span class="n">allclspred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">pred</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">label_counts</span><span class="p">[</span><span class="n">cl</span><span class="p">]</span>
            <span class="n">columns</span> <span class="o">+=</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">label_decoders</span><span class="p">[</span><span class="n">cl</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
        <span class="n">allclspred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">allclspred</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span>
        <span class="p">)</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">allclspred</span><span class="p">)</span>

    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doclass</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_all_cls_pred</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">cl</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">class_topred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">label_decoders</span><span class="p">[</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">labels_hierarchy</span><span class="p">:</span>
                <span class="c1"># class_groupings = {</span>
                <span class="c1">#    k: [</span>
                <span class="c1">#        i.ontology_id</span>
                <span class="c1">#        for i in bt.CellType.filter(k).first().children.all()</span>
                <span class="c1">#    ]</span>
                <span class="c1">#    for k in set(adata.obs[cl].unique()) - set(class_topred)</span>
                <span class="c1"># }</span>
                <span class="n">cur_labels_hierarchy</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">label_decoders</span><span class="p">[</span><span class="n">cl</span><span class="p">][</span><span class="n">k</span><span class="p">]:</span> <span class="p">[</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">label_decoders</span><span class="p">[</span><span class="n">cl</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">labels_hierarchy</span><span class="p">[</span><span class="n">cl</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cur_labels_hierarchy</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">pred</span><span class="p">,</span> <span class="n">true</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[[</span><span class="s2">&quot;pred_&quot;</span> <span class="o">+</span> <span class="n">cl</span><span class="p">,</span> <span class="n">cl</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pred</span> <span class="o">==</span> <span class="n">true</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_labels_hierarchy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">true</span> <span class="ow">in</span> <span class="n">cur_labels_hierarchy</span><span class="p">:</span>
                        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span> <span class="ow">in</span> <span class="n">cur_labels_hierarchy</span><span class="p">[</span><span class="n">true</span><span class="p">])</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">true</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">class_topred</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;true label </span><span class="si">{</span><span class="n">true</span><span class="si">}</span><span class="s2"> not in available classes&quot;</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">true</span> <span class="o">!=</span> <span class="s2">&quot;unknown&quot;</span><span class="p">:</span>
                        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">true</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">class_topred</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;true label </span><span class="si">{</span><span class="n">true</span><span class="si">}</span><span class="s2"> not in available classes&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">true</span> <span class="o">!=</span> <span class="s2">&quot;unknown&quot;</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># else true is unknown</span>
                <span class="c1"># else we pass</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># true was always unknown</span>
                <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doplot</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    &quot;</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     accuracy:&quot;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">cl</span> <span class="o">+</span> <span class="s2">&quot;_accuracy&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)})</span>
    <span class="k">return</span> <span class="n">adata</span><span class="p">,</span> <span class="n">metrics</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h3 id="scprint.tasks.cell_emb.compute_classification" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_classification</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute classification metrics for the given annotated data.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>adata</code></b>
                  (<code><span title="anndata.AnnData">AnnData</span></code>)
              –
              <div class="doc-md-description">
                <p>The annotated data matrix of shape n_obs x n_vars. Rows correspond to cells and columns to genes.</p>
              </div>
            </li>
            <li>
              <b><code>classes</code></b>
                  (<code><span title="typing.List">List</span>[str]</code>)
              –
              <div class="doc-md-description">
                <p>List of class labels to be used for classification.</p>
              </div>
            </li>
            <li>
              <b><code>label_decoders</code></b>
                  (<code><span title="typing.Dict">Dict</span>[str, <span title="typing.Any">Any</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Dictionary of label decoders for each class.</p>
              </div>
            </li>
            <li>
              <b><code>labels_hierarchy</code></b>
                  (<code><span title="typing.Dict">Dict</span>[str, <span title="typing.Any">Any</span>]</code>)
              –
              <div class="doc-md-description">
                <p>Dictionary representing the hierarchy of labels.</p>
              </div>
            </li>
            <li>
              <b><code>metric_type</code></b>
                  (<code><span title="typing.List">List</span>[str]</code>, default:
                      <code>[&#39;macro&#39;, &#39;micro&#39;, &#39;weighted&#39;]</code>
)
              –
              <div class="doc-md-description">
                <p>List of metric types to compute. Defaults to ["macro", "micro", "weighted"].</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="typing.Dict">Dict</span>[str, <span title="typing.Dict">Dict</span>[str, float]]</code>
              –
              <div class="doc-md-description">
                <p>Dict[str, Dict[str, float]]: A dictionary containing classification metrics for each class.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>scprint/tasks/cell_emb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_classification</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span>
    <span class="n">classes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">label_decoders</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">labels_hierarchy</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">metric_type</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;macro&quot;</span><span class="p">,</span> <span class="s2">&quot;micro&quot;</span><span class="p">,</span> <span class="s2">&quot;weighted&quot;</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute classification metrics for the given annotated data.</span>

<span class="sd">    Args:</span>
<span class="sd">        adata (AnnData): The annotated data matrix of shape n_obs x n_vars. Rows correspond to cells and columns to genes.</span>
<span class="sd">        classes (List[str]): List of class labels to be used for classification.</span>
<span class="sd">        label_decoders (Dict[str, Any]): Dictionary of label decoders for each class.</span>
<span class="sd">        labels_hierarchy (Dict[str, Any]): Dictionary representing the hierarchy of labels.</span>
<span class="sd">        metric_type (List[str], optional): List of metric types to compute. Defaults to [&quot;macro&quot;, &quot;micro&quot;, &quot;weighted&quot;].</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, Dict[str, float]]: A dictionary containing classification metrics for each class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">labels_topred</span> <span class="o">=</span> <span class="n">label_decoders</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels_hierarchy</span><span class="p">:</span>
            <span class="n">parentdf</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">bt</span><span class="o">.</span><span class="n">CellType</span><span class="o">.</span><span class="n">filter</span><span class="p">()</span>
                <span class="o">.</span><span class="n">df</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;parents__ontology_id&quot;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;ontology_id&quot;</span><span class="p">)[[</span><span class="s2">&quot;parents__ontology_id&quot;</span><span class="p">]]</span>
            <span class="p">)</span>
            <span class="n">parentdf</span><span class="o">.</span><span class="n">parents__ontology_id</span> <span class="o">=</span> <span class="n">parentdf</span><span class="o">.</span><span class="n">parents__ontology_id</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">class_groupings</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">get_descendants</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">parentdf</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="p">}</span>
        <span class="k">for</span> <span class="n">pred</span><span class="p">,</span> <span class="n">true</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[[</span><span class="s2">&quot;pred_&quot;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span> <span class="n">label</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pred</span> <span class="o">==</span> <span class="n">true</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">true</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels_hierarchy</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">true</span> <span class="ow">in</span> <span class="n">class_groupings</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">true</span> <span class="k">if</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">class_groupings</span><span class="p">[</span><span class="n">true</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">true</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels_topred</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;true label </span><span class="si">{</span><span class="n">true</span><span class="si">}</span><span class="s2"> not in available classes&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">true</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labels_topred</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;true label </span><span class="si">{</span><span class="n">true</span><span class="si">}</span><span class="s2"> not in available classes&quot;</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s2">&quot;accuracy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">metric_type</span><span class="p">:</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="n">x</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">metrics</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="scprint.tasks.cell_emb.compute_corr" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_corr</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute the correlation between the output and target matrices.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>out</code></b>
                  (<code><span title="numpy.ndarray">ndarray</span></code>)
              –
              <div class="doc-md-description">
                <p>The output matrix.</p>
              </div>
            </li>
            <li>
              <b><code>to</code></b>
                  (<code><span title="numpy.ndarray">ndarray</span></code>)
              –
              <div class="doc-md-description">
                <p>The target matrix.</p>
              </div>
            </li>
            <li>
              <b><code>doplot</code></b>
                  (<code>bool</code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to generate a plot of the correlation coefficients. Defaults to True.</p>
              </div>
            </li>
            <li>
              <b><code>compute_mean_regress</code></b>
                  (<code>bool</code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to compute mean regression. Defaults to False.</p>
              </div>
            </li>
            <li>
              <b><code>plot_corr_size</code></b>
                  (<code>int</code>, default:
                      <code>64</code>
)
              –
              <div class="doc-md-description">
                <p>The size of the plot for correlation. Defaults to 64.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>dict</code></b>(                  <code>dict</code>
)              –
              <div class="doc-md-description">
                <p>A dictionary containing the computed metrics.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>scprint/tasks/cell_emb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_corr</span><span class="p">(</span>
    <span class="n">out</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">to</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">doplot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">compute_mean_regress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">plot_corr_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the correlation between the output and target matrices.</span>

<span class="sd">    Args:</span>
<span class="sd">        out (np.ndarray): The output matrix.</span>
<span class="sd">        to (np.ndarray): The target matrix.</span>
<span class="sd">        doplot (bool, optional): Whether to generate a plot of the correlation coefficients. Defaults to True.</span>
<span class="sd">        compute_mean_regress (bool, optional): Whether to compute mean regression. Defaults to False.</span>
<span class="sd">        plot_corr_size (int, optional): The size of the plot for correlation. Defaults to 64.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the computed metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">corr_coef</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">spearmanr</span><span class="p">(</span>
        <span class="n">out</span><span class="p">,</span>
        <span class="n">to</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">corr_coef</span><span class="p">[</span><span class="n">p_value</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># corr_coef[]</span>
    <span class="c1"># only on non zero values,</span>
    <span class="c1"># compare a1-b1 corr with a1-b(n) corr. should be higher</span>

    <span class="c1"># Plot correlation coefficient</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">plot_corr_size</span> <span class="o">+</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">compute_mean_regress</span> <span class="k">else</span> <span class="n">plot_corr_size</span>
    <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;recons_corr&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">corr_coef</span><span class="p">[</span><span class="n">val</span><span class="p">:,</span> <span class="p">:</span><span class="n">plot_corr_size</span><span class="p">]</span><span class="o">.</span><span class="n">diagonal</span><span class="p">())}</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">compute_mean_regress</span><span class="p">:</span>
        <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;mean_regress&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="n">corr_coef</span><span class="p">[</span>
                        <span class="n">plot_corr_size</span> <span class="p">:</span> <span class="n">plot_corr_size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="p">:</span><span class="n">plot_corr_size</span><span class="p">,</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">doplot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">corr_coef</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Correlation Coefficient of expr and i[&quot;x&quot;]&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">metrics</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="scprint.tasks.cell_emb.default_benchmark" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">default_benchmark</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Run the default benchmark for embedding and annotation using the scPRINT model.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>model</code></b>
                  (<code><span title="torch.nn.Module">Module</span></code>)
              –
              <div class="doc-md-description">
                <p>The scPRINT model to be used for embedding and annotation.</p>
              </div>
            </li>
            <li>
              <b><code>default_dataset</code></b>
                  (<code>str</code>, default:
                      <code>&#39;pancreas&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>The default dataset to use for benchmarking. Options are "pancreas", "lung", or a path to a dataset. Defaults to "pancreas".</p>
              </div>
            </li>
            <li>
              <b><code>do_class</code></b>
                  (<code>bool</code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to perform classification. Defaults to True.</p>
              </div>
            </li>
            <li>
              <b><code>coarse</code></b>
                  (<code>bool</code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to use coarse cell type annotations. Defaults to False.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>dict</code></b>(                  <code>dict</code>
)              –
              <div class="doc-md-description">
                <p>A dictionary containing the benchmark metrics.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>scprint/tasks/cell_emb.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">default_benchmark</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
    <span class="n">default_dataset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pancreas&quot;</span><span class="p">,</span>
    <span class="n">do_class</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">coarse</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the default benchmark for embedding and annotation using the scPRINT model.</span>

<span class="sd">    Args:</span>
<span class="sd">        model (torch.nn.Module): The scPRINT model to be used for embedding and annotation.</span>
<span class="sd">        default_dataset (str, optional): The default dataset to use for benchmarking. Options are &quot;pancreas&quot;, &quot;lung&quot;, or a path to a dataset. Defaults to &quot;pancreas&quot;.</span>
<span class="sd">        do_class (bool, optional): Whether to perform classification. Defaults to True.</span>
<span class="sd">        coarse (bool, optional): Whether to use coarse cell type annotations. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the benchmark metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">default_dataset</span> <span class="o">==</span> <span class="s2">&quot;pancreas&quot;</span><span class="p">:</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
            <span class="n">FILE_LOC</span> <span class="o">+</span> <span class="s2">&quot;/../../data/pancreas_atlas.h5ad&quot;</span><span class="p">,</span>
            <span class="n">backup_url</span><span class="o">=</span><span class="s2">&quot;https://figshare.com/ndownloader/files/24539828&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;cell_type_ontology_term_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;celltype&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="n">COARSE</span> <span class="k">if</span> <span class="n">coarse</span> <span class="k">else</span> <span class="n">FINE</span>
        <span class="p">)</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;assay_ontology_term_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;tech&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="n">COARSE</span> <span class="k">if</span> <span class="n">coarse</span> <span class="k">else</span> <span class="n">FINE</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">default_dataset</span> <span class="o">==</span> <span class="s2">&quot;lung&quot;</span><span class="p">:</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read</span><span class="p">(</span>
            <span class="n">FILE_LOC</span> <span class="o">+</span> <span class="s2">&quot;/../../data/lung_atlas.h5ad&quot;</span><span class="p">,</span>
            <span class="n">backup_url</span><span class="o">=</span><span class="s2">&quot;https://figshare.com/ndownloader/files/24539942&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;cell_type_ontology_term_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;cell_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="n">COARSE</span> <span class="k">if</span> <span class="n">coarse</span> <span class="k">else</span> <span class="n">FINE</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">default_dataset</span><span class="p">)</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;batch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;assay_ontology_term_id&quot;</span><span class="p">]</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;cell_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;cell_type_ontology_term_id&quot;</span><span class="p">]</span>
    <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">Preprocessor</span><span class="p">(</span>
        <span class="n">use_layer</span><span class="o">=</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span>
        <span class="n">is_symbol</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">force_preprocess</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">skip_validate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">do_postp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;organism_ontology_term_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NCBITaxon:9606&quot;</span>
    <span class="n">adata</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="n">embedder</span> <span class="o">=</span> <span class="n">Embedder</span><span class="p">(</span>
        <span class="n">pred_embedding</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cell_type_ontology_term_id&quot;</span><span class="p">],</span>
        <span class="n">doclass</span><span class="o">=</span><span class="p">(</span><span class="n">default_dataset</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pancreas&quot;</span><span class="p">,</span> <span class="s2">&quot;lung&quot;</span><span class="p">]),</span>
        <span class="n">max_len</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span>
        <span class="n">keep_all_cls_pred</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">output_expression</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">embed_adata</span><span class="p">,</span> <span class="n">metrics</span> <span class="o">=</span> <span class="n">embedder</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">adata</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

    <span class="n">bm</span> <span class="o">=</span> <span class="n">Benchmarker</span><span class="p">(</span>
        <span class="n">embed_adata</span><span class="p">,</span>
        <span class="n">batch_key</span><span class="o">=</span><span class="s2">&quot;tech&quot;</span> <span class="k">if</span> <span class="n">default_dataset</span> <span class="o">==</span> <span class="s2">&quot;pancreas&quot;</span> <span class="k">else</span> <span class="s2">&quot;batch&quot;</span><span class="p">,</span>
        <span class="n">label_key</span><span class="o">=</span><span class="s2">&quot;celltype&quot;</span> <span class="k">if</span> <span class="n">default_dataset</span> <span class="o">==</span> <span class="s2">&quot;pancreas&quot;</span> <span class="k">else</span> <span class="s2">&quot;cell_type&quot;</span><span class="p">,</span>
        <span class="n">embedding_obsm_keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;scprint&quot;</span><span class="p">],</span>
        <span class="n">n_jobs</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">bm</span><span class="o">.</span><span class="n">benchmark</span><span class="p">()</span>
    <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;scib&quot;</span><span class="p">:</span> <span class="n">bm</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="n">min_max_scale</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">&quot;scprint&quot;</span><span class="p">]})</span>
    <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;classif&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_classification</span><span class="p">(</span>
        <span class="n">embed_adata</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">label_decoders</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">labels_hierarchy</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">metrics</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="scprint.tasks.grn" class="doc doc-heading">
            <code>scprint.tasks.grn</code>


</h2>

    <div class="doc doc-contents first">



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="scprint.tasks.grn.GNInfer" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">GNInfer</span></code>

</h3>


    <div class="doc doc-contents ">


        <p>GNInfer a class to infer gene regulatory networks from a dataset using a scPRINT model.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>layer</code></b>
                  (<code><span title="typing.Optional">Optional</span>[list[int]]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>List of layers to use for the inference. Defaults to None.</p>
              </div>
            </li>
            <li>
              <b><code>batch_size</code></b>
                  (<code>int</code>, default:
                      <code>64</code>
)
              –
              <div class="doc-md-description">
                <p>Batch size for processing. Defaults to 64.</p>
              </div>
            </li>
            <li>
              <b><code>num_workers</code></b>
                  (<code>int</code>, default:
                      <code>8</code>
)
              –
              <div class="doc-md-description">
                <p>Number of workers for data loading. Defaults to 8.</p>
              </div>
            </li>
            <li>
              <b><code>drop_unexpressed</code></b>
                  (<code>bool</code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to drop unexpressed genes. Defaults to False.</p>
              </div>
            </li>
            <li>
              <b><code>num_genes</code></b>
                  (<code>int</code>, default:
                      <code>3000</code>
)
              –
              <div class="doc-md-description">
                <p>Number of genes to consider. Defaults to 3000.</p>
              </div>
            </li>
            <li>
              <b><code>precision</code></b>
                  (<code>str</code>, default:
                      <code>&#39;16-mixed&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Precision type for computations. Defaults to "16-mixed".</p>
              </div>
            </li>
            <li>
              <b><code>cell_type_col</code></b>
                  (<code>str</code>, default:
                      <code>&#39;cell_type&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Column name for cell type information. Defaults to "cell_type".</p>
              </div>
            </li>
            <li>
              <b><code>how</code></b>
                  (<code>str</code>, default:
                      <code>&#39;random expr&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Method to select genes. Options are "random expr", "most var within", "most var across", "given". Defaults to "random expr".</p>
              </div>
            </li>
            <li>
              <b><code>preprocess</code></b>
                  (<code>str</code>, default:
                      <code>&#39;softmax&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Preprocessing method. Options are "softmax", "sinkhorn", "none". Defaults to "softmax".</p>
              </div>
            </li>
            <li>
              <b><code>head_agg</code></b>
                  (<code>str</code>, default:
                      <code>&#39;mean&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Aggregation method for heads. Options are "mean", "sum", "none". Defaults to "mean".</p>
              </div>
            </li>
            <li>
              <b><code>filtration</code></b>
                  (<code>str</code>, default:
                      <code>&#39;thresh&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Filtration method for the adjacency matrix. Options are "thresh", "top-k", "mst", "known", "none". Defaults to "thresh".</p>
              </div>
            </li>
            <li>
              <b><code>k</code></b>
                  (<code>int</code>, default:
                      <code>10</code>
)
              –
              <div class="doc-md-description">
                <p>Number of top connections to keep if filtration is "top-k". Defaults to 10.</p>
              </div>
            </li>
            <li>
              <b><code>apc</code></b>
                  (<code>bool</code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to apply Average Product Correction. Defaults to False.</p>
              </div>
            </li>
            <li>
              <b><code>known_grn</code></b>
                  (<code>optional</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Known gene regulatory network to use as a reference. Defaults to None.</p>
              </div>
            </li>
            <li>
              <b><code>symmetrize</code></b>
                  (<code>bool</code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to symmetrize the adjacency matrix. Defaults to False.</p>
              </div>
            </li>
            <li>
              <b><code>doplot</code></b>
                  (<code>bool</code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to generate plots. Defaults to True.</p>
              </div>
            </li>
            <li>
              <b><code>max_cells</code></b>
                  (<code>int</code>, default:
                      <code>0</code>
)
              –
              <div class="doc-md-description">
                <p>Maximum number of cells to consider. Defaults to 0.</p>
              </div>
            </li>
            <li>
              <b><code>forward_mode</code></b>
                  (<code>str</code>, default:
                      <code>&#39;none&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Mode for forward pass. Defaults to "none".</p>
              </div>
            </li>
            <li>
              <b><code>genes</code></b>
                  (<code>list</code>, default:
                      <code>[]</code>
)
              –
              <div class="doc-md-description">
                <p>List of genes to consider. Defaults to an empty list.</p>
              </div>
            </li>
            <li>
              <b><code>loc</code></b>
                  (<code>str</code>, default:
                      <code>&#39;./&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Location to save results. Defaults to "./".</p>
              </div>
            </li>
            <li>
              <b><code>dtype</code></b>
                  (<code><span title="torch.dtype">dtype</span></code>, default:
                      <code><span title="torch.float16">float16</span></code>
)
              –
              <div class="doc-md-description">
                <p>Data type for computations. Defaults to torch.float16.</p>
              </div>
            </li>
            <li>
              <b><code>locname</code></b>
                  (<code>str</code>, default:
                      <code>&#39;&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Name for the location. Defaults to an empty string.</p>
              </div>
            </li>
            <li>
              <b><code>add_emb_in_model</code></b>
                  (<code>int</code>, default:
                      <code>8</code>
)
              –
              <div class="doc-md-description">
                <p>Number of embeddings to add in the model. Defaults to 8.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
                  <details class="quote">
                    <summary>Source code in <code>scprint/tasks/grn.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">layer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">drop_unexpressed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">num_genes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">,</span>
    <span class="n">precision</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;16-mixed&quot;</span><span class="p">,</span>
    <span class="n">cell_type_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_type&quot;</span><span class="p">,</span>
    <span class="n">how</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;random expr&quot;</span><span class="p">,</span>  <span class="c1"># random expr, most var within, most var across, given</span>
    <span class="n">max_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">,</span>
    <span class="n">preprocess</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;softmax&quot;</span><span class="p">,</span>  <span class="c1"># sinkhorn, softmax, none</span>
    <span class="n">head_agg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>  <span class="c1"># mean, sum, none</span>
    <span class="n">filtration</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;thresh&quot;</span><span class="p">,</span>  <span class="c1"># thresh, top-k, mst, known, none</span>
    <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">apc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">known_grn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">symmetrize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">doplot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">shared_qk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">max_cells</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">forward_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
    <span class="n">genes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="n">loc</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span>
    <span class="n">locname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">add_emb_in_model</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GNInfer a class to infer gene regulatory networks from a dataset using a scPRINT model.</span>

<span class="sd">    Args:</span>
<span class="sd">        layer (Optional[list[int]], optional): List of layers to use for the inference. Defaults to None.</span>
<span class="sd">        batch_size (int, optional): Batch size for processing. Defaults to 64.</span>
<span class="sd">        num_workers (int, optional): Number of workers for data loading. Defaults to 8.</span>
<span class="sd">        drop_unexpressed (bool, optional): Whether to drop unexpressed genes. Defaults to False.</span>
<span class="sd">        num_genes (int, optional): Number of genes to consider. Defaults to 3000.</span>
<span class="sd">        precision (str, optional): Precision type for computations. Defaults to &quot;16-mixed&quot;.</span>
<span class="sd">        cell_type_col (str, optional): Column name for cell type information. Defaults to &quot;cell_type&quot;.</span>
<span class="sd">        how (str, optional): Method to select genes. Options are &quot;random expr&quot;, &quot;most var within&quot;, &quot;most var across&quot;, &quot;given&quot;. Defaults to &quot;random expr&quot;.</span>
<span class="sd">        preprocess (str, optional): Preprocessing method. Options are &quot;softmax&quot;, &quot;sinkhorn&quot;, &quot;none&quot;. Defaults to &quot;softmax&quot;.</span>
<span class="sd">        head_agg (str, optional): Aggregation method for heads. Options are &quot;mean&quot;, &quot;sum&quot;, &quot;none&quot;. Defaults to &quot;mean&quot;.</span>
<span class="sd">        filtration (str, optional): Filtration method for the adjacency matrix. Options are &quot;thresh&quot;, &quot;top-k&quot;, &quot;mst&quot;, &quot;known&quot;, &quot;none&quot;. Defaults to &quot;thresh&quot;.</span>
<span class="sd">        k (int, optional): Number of top connections to keep if filtration is &quot;top-k&quot;. Defaults to 10.</span>
<span class="sd">        apc (bool, optional): Whether to apply Average Product Correction. Defaults to False.</span>
<span class="sd">        known_grn (optional): Known gene regulatory network to use as a reference. Defaults to None.</span>
<span class="sd">        symmetrize (bool, optional): Whether to symmetrize the adjacency matrix. Defaults to False.</span>
<span class="sd">        doplot (bool, optional): Whether to generate plots. Defaults to True.</span>
<span class="sd">        max_cells (int, optional): Maximum number of cells to consider. Defaults to 0.</span>
<span class="sd">        forward_mode (str, optional): Mode for forward pass. Defaults to &quot;none&quot;.</span>
<span class="sd">        genes (list, optional): List of genes to consider. Defaults to an empty list.</span>
<span class="sd">        loc (str, optional): Location to save results. Defaults to &quot;./&quot;.</span>
<span class="sd">        dtype (torch.dtype, optional): Data type for computations. Defaults to torch.float16.</span>
<span class="sd">        locname (str, optional): Name for the location. Defaults to an empty string.</span>
<span class="sd">        add_emb_in_model (int, optional): Number of embeddings to add in the model. Defaults to 8.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="o">=</span> <span class="n">num_workers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="n">layer</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">locname</span> <span class="o">=</span> <span class="n">locname</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">=</span> <span class="n">how</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">how</span>
        <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;most var within&quot;</span><span class="p">,</span>
            <span class="s2">&quot;most var across&quot;</span><span class="p">,</span>
            <span class="s2">&quot;random expr&quot;</span><span class="p">,</span>
            <span class="s2">&quot;given&quot;</span><span class="p">,</span>
            <span class="s2">&quot;most expr&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">),</span> <span class="s2">&quot;how must be one of &#39;most var within&#39;, &#39;most var across&#39;, &#39;random expr&#39;, &#39;given&#39;, &#39;most expr&#39;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_genes</span> <span class="o">=</span> <span class="n">num_genes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span> <span class="o">=</span> <span class="n">preprocess</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cell_type_col</span> <span class="o">=</span> <span class="n">cell_type_col</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">filtration</span> <span class="o">=</span> <span class="n">filtration</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">doplot</span> <span class="o">=</span> <span class="n">doplot</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">genes</span> <span class="o">=</span> <span class="n">genes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">apc</span> <span class="o">=</span> <span class="n">apc</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">forward_mode</span> <span class="o">=</span> <span class="n">forward_mode</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="n">max_len</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize</span> <span class="o">=</span> <span class="n">symmetrize</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">known_grn</span> <span class="o">=</span> <span class="n">known_grn</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">head_agg</span> <span class="o">=</span> <span class="n">head_agg</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_cells</span> <span class="o">=</span> <span class="n">max_cells</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">curr_genes</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">drop_unexpressed</span> <span class="o">=</span> <span class="n">drop_unexpressed</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">shared_qk</span> <span class="o">=</span> <span class="n">shared_qk</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_emb_in_model</span> <span class="o">=</span> <span class="n">add_emb_in_model</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filtration</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_agg</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;filtration must be &#39;none&#39; when head_agg is &#39;none&#39;&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="scprint.tasks.grn.GNInfer.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__call__</span></code>

</h4>


    <div class="doc doc-contents ">

        <p><strong>call</strong> runs the method</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>model</code></b>
                  (<code><span title="torch.nn.Module">Module</span></code>)
              –
              <div class="doc-md-description">
                <p>The model to be used for generating the network</p>
              </div>
            </li>
            <li>
              <b><code>adata</code></b>
                  (<code><span title="anndata.AnnData">AnnData</span></code>)
              –
              <div class="doc-md-description">
                <p>Annotated data matrix of shape <code>n_obs</code> × <code>n_vars</code>. <code>n_obs</code> is the number of cells and <code>n_vars</code> is the number of genes.</p>
              </div>
            </li>
            <li>
              <b><code>cell_type</code></b>
                  (<code>str</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Specific cell type to filter the data. Defaults to None.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>AnnData</code></b>              –
              <div class="doc-md-description">
                <p>Annotated data matrix with predictions and annotations.</p>
              </div>
            </li>
            <li>
              –
              <div class="doc-md-description">
                <p>np.ndarray: Filtered adjacency matrix.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>scprint/tasks/grn.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">,</span> <span class="n">cell_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    __call__ runs the method</span>

<span class="sd">    Args:</span>
<span class="sd">        model (torch.nn.Module): The model to be used for generating the network</span>
<span class="sd">        adata (AnnData): Annotated data matrix of shape `n_obs` × `n_vars`. `n_obs` is the number of cells and `n_vars` is the number of genes.</span>
<span class="sd">        cell_type (str, optional): Specific cell type to filter the data. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        AnnData: Annotated data matrix with predictions and annotations.</span>
<span class="sd">        np.ndarray: Filtered adjacency matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Add at least the organism you are working with</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">nlayers</span><span class="p">))</span>
    <span class="n">subadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">adata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">)</span>
    <span class="n">adjacencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">attn</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">model</span><span class="o">.</span><span class="n">genes</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_agg</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
            <span class="n">adjacencies</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">add_emb_in_model</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_emb_in_model</span> <span class="p">:,</span> <span class="p">:],</span>
            <span class="n">subadata</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">adjacencies</span><span class="p">)[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_emb_in_model</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_emb_in_model</span> <span class="p">:</span>
            <span class="p">],</span>
            <span class="n">subadata</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h3 id="scprint.tasks.grn.default_benchmark" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">default_benchmark</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>default_benchmark function to run the default scPRINT GRN benchmark</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>model</code></b>
                  (<code><span title="typing.Any">Any</span></code>)
              –
              <div class="doc-md-description">
                <p>The scPRINT model to be used for the benchmark.</p>
              </div>
            </li>
            <li>
              <b><code>default_dataset</code></b>
                  (<code>str</code>, default:
                      <code>&#39;sroy&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>The default dataset to use for benchmarking. Defaults to "sroy".</p>
              </div>
            </li>
            <li>
              <b><code>cell_types</code></b>
                  (<code><span title="typing.List">List</span>[str]</code>, default:
                      <code>[&#39;kidney distal convoluted tubule epithelial cell&#39;, &#39;kidney loop of Henle thick ascending limb epithelial cell&#39;, &#39;kidney collecting duct principal cell&#39;, &#39;mesangial cell&#39;, &#39;blood vessel smooth muscle cell&#39;, &#39;podocyte&#39;, &#39;macrophage&#39;, &#39;leukocyte&#39;, &#39;kidney interstitial fibroblast&#39;, &#39;endothelial cell&#39;]</code>
)
              –
              <div class="doc-md-description">
                <p>List of cell types to include in the benchmark. Defaults to [
"kidney distal convoluted tubule epithelial cell",
"kidney loop of Henle thick ascending limb epithelial cell",
"kidney collecting duct principal cell",
"mesangial cell",
"blood vessel smooth muscle cell",
"podocyte",
"macrophage",
"leukocyte",
"kidney interstitial fibroblast",
"endothelial cell",</p>
              </div>
            </li>
            <li>
              <b><code>maxlayers</code></b>
                  (<code>int</code>, default:
                      <code>16</code>
)
              –
              <div class="doc-md-description">
                <p>Maximum number of layers to use from the model. Defaults to 16.</p>
              </div>
            </li>
            <li>
              <b><code>maxgenes</code></b>
                  (<code>int</code>, default:
                      <code>5000</code>
)
              –
              <div class="doc-md-description">
                <p>Maximum number of genes to consider. Defaults to 5000.</p>
              </div>
            </li>
            <li>
              <b><code>batch_size</code></b>
                  (<code>int</code>, default:
                      <code>32</code>
)
              –
              <div class="doc-md-description">
                <p>Batch size for processing. Defaults to 32.</p>
              </div>
            </li>
            <li>
              <b><code>maxcells</code></b>
                  (<code>int</code>, default:
                      <code>1024</code>
)
              –
              <div class="doc-md-description">
                <p>Maximum number of cells to consider. Defaults to 1024.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>dict</code></b>              –
              <div class="doc-md-description">
                <p>A dictionary containing the benchmark metrics.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>scprint/tasks/grn.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">default_benchmark</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">default_dataset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sroy&quot;</span><span class="p">,</span>
    <span class="n">cell_types</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;kidney distal convoluted tubule epithelial cell&quot;</span><span class="p">,</span>
        <span class="s2">&quot;kidney loop of Henle thick ascending limb epithelial cell&quot;</span><span class="p">,</span>
        <span class="s2">&quot;kidney collecting duct principal cell&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mesangial cell&quot;</span><span class="p">,</span>
        <span class="s2">&quot;blood vessel smooth muscle cell&quot;</span><span class="p">,</span>
        <span class="s2">&quot;podocyte&quot;</span><span class="p">,</span>
        <span class="s2">&quot;macrophage&quot;</span><span class="p">,</span>
        <span class="s2">&quot;leukocyte&quot;</span><span class="p">,</span>
        <span class="s2">&quot;kidney interstitial fibroblast&quot;</span><span class="p">,</span>
        <span class="s2">&quot;endothelial cell&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">maxlayers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
    <span class="n">maxgenes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
    <span class="n">maxcells</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    default_benchmark function to run the default scPRINT GRN benchmark</span>

<span class="sd">    Args:</span>
<span class="sd">        model (Any): The scPRINT model to be used for the benchmark.</span>
<span class="sd">        default_dataset (str, optional): The default dataset to use for benchmarking. Defaults to &quot;sroy&quot;.</span>
<span class="sd">        cell_types (List[str], optional): List of cell types to include in the benchmark. Defaults to [</span>
<span class="sd">            &quot;kidney distal convoluted tubule epithelial cell&quot;,</span>
<span class="sd">            &quot;kidney loop of Henle thick ascending limb epithelial cell&quot;,</span>
<span class="sd">            &quot;kidney collecting duct principal cell&quot;,</span>
<span class="sd">            &quot;mesangial cell&quot;,</span>
<span class="sd">            &quot;blood vessel smooth muscle cell&quot;,</span>
<span class="sd">            &quot;podocyte&quot;,</span>
<span class="sd">            &quot;macrophage&quot;,</span>
<span class="sd">            &quot;leukocyte&quot;,</span>
<span class="sd">            &quot;kidney interstitial fibroblast&quot;,</span>
<span class="sd">            &quot;endothelial cell&quot;,</span>
<span class="sd">        ].</span>
<span class="sd">        maxlayers (int, optional): Maximum number of layers to use from the model. Defaults to 16.</span>
<span class="sd">        maxgenes (int, optional): Maximum number of genes to consider. Defaults to 5000.</span>
<span class="sd">        batch_size (int, optional): Batch size for processing. Defaults to 32.</span>
<span class="sd">        maxcells (int, optional): Maximum number of cells to consider. Defaults to 1024.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the benchmark metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">nlayers</span><span class="p">))[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">nlayers</span> <span class="o">-</span> <span class="n">maxlayers</span><span class="p">)</span> <span class="p">:]</span>
    <span class="n">clf_omni</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">default_dataset</span> <span class="o">==</span> <span class="s2">&quot;sroy&quot;</span><span class="p">:</span>
        <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">Preprocessor</span><span class="p">(</span>
            <span class="n">is_symbol</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">force_preprocess</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">skip_validate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">do_postp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">min_valid_genes_id</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
            <span class="n">min_dataset_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">clf_self</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">todo</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;han&quot;</span><span class="p">,</span> <span class="s2">&quot;human&quot;</span><span class="p">,</span> <span class="s2">&quot;full&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;mine&quot;</span><span class="p">,</span> <span class="s2">&quot;human&quot;</span><span class="p">,</span> <span class="s2">&quot;full&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;han&quot;</span><span class="p">,</span> <span class="s2">&quot;human&quot;</span><span class="p">,</span> <span class="s2">&quot;chip&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;han&quot;</span><span class="p">,</span> <span class="s2">&quot;human&quot;</span><span class="p">,</span> <span class="s2">&quot;ko&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tran&quot;</span><span class="p">,</span> <span class="s2">&quot;mouse&quot;</span><span class="p">,</span> <span class="s2">&quot;full&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;zhao&quot;</span><span class="p">,</span> <span class="s2">&quot;mouse&quot;</span><span class="p">,</span> <span class="s2">&quot;full&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tran&quot;</span><span class="p">,</span> <span class="s2">&quot;mouse&quot;</span><span class="p">,</span> <span class="s2">&quot;chip&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;tran&quot;</span><span class="p">,</span> <span class="s2">&quot;mouse&quot;</span><span class="p">,</span> <span class="s2">&quot;ko&quot;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">da</span><span class="p">,</span> <span class="n">spe</span><span class="p">,</span> <span class="n">gt</span> <span class="ow">in</span> <span class="n">todo</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">gt</span> <span class="o">!=</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">gt</span><span class="p">)</span>
            <span class="n">preadata</span> <span class="o">=</span> <span class="n">get_sroy_gt</span><span class="p">(</span><span class="n">get</span><span class="o">=</span><span class="n">da</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">spe</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="n">gt</span><span class="p">)</span>
            <span class="n">adata</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="p">(</span><span class="n">preadata</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="n">grn_inferer</span> <span class="o">=</span> <span class="n">GNInfer</span><span class="p">(</span>
                <span class="n">layer</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;most var within&quot;</span><span class="p">,</span>
                <span class="n">preprocess</span><span class="o">=</span><span class="s2">&quot;softmax&quot;</span><span class="p">,</span>
                <span class="n">head_agg</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                <span class="n">filtration</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                <span class="n">forward_mode</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                <span class="n">num_genes</span><span class="o">=</span><span class="n">maxgenes</span><span class="p">,</span>
                <span class="n">num_workers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                <span class="n">max_cells</span><span class="o">=</span><span class="n">maxcells</span><span class="p">,</span>
                <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">grn</span> <span class="o">=</span> <span class="n">grn_inferer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">adata</span><span class="p">)</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;ensembl_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_index_unique</span><span class="p">(</span><span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;mean_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">gt</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">preadata</span><span class="p">)</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="k">if</span> <span class="n">spe</span> <span class="o">==</span> <span class="s2">&quot;human&quot;</span><span class="p">:</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;mean_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">gt</span> <span class="o">+</span> <span class="s2">&quot;_base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span><span class="o">.</span><span class="n">scprint_benchmark</span><span class="p">()</span>

            <span class="c1">## OMNI</span>
            <span class="k">if</span> <span class="n">clf_omni</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">clf_omni</span> <span class="o">=</span> <span class="n">train_classifier</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span>
                    <span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">train_size</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                    <span class="n">class_weight</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">return_full</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">clf_omni</span><span class="p">,</span> <span class="s2">&quot;clf_omni.pkl&quot;</span><span class="p">)</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;omni_classifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">clf_omni</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spe</span> <span class="o">==</span> <span class="s2">&quot;human&quot;</span><span class="p">:</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;omni_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">gt</span> <span class="o">+</span> <span class="s2">&quot;_base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span><span class="o">.</span><span class="n">scprint_benchmark</span><span class="p">()</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;omni_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">gt</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">preadata</span><span class="p">)</span>

            <span class="c1">## SELF</span>
            <span class="k">if</span> <span class="n">clf_self</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">clf_self</span> <span class="o">=</span> <span class="n">train_classifier</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span>
                    <span class="n">other</span><span class="o">=</span><span class="n">preadata</span><span class="p">,</span>
                    <span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">train_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">class_weight</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">return_full</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;self_classifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">clf_self</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;self_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">gt</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">preadata</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spe</span> <span class="o">==</span> <span class="s2">&quot;human&quot;</span><span class="p">:</span>
                <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;self_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">gt</span> <span class="o">+</span> <span class="s2">&quot;_base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span><span class="o">.</span><span class="n">scprint_benchmark</span><span class="p">()</span>

            <span class="c1">## chip / ko</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">spe</span><span class="p">,</span> <span class="s2">&quot;chip&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">todo</span><span class="p">:</span>
                <span class="n">preadata</span> <span class="o">=</span> <span class="n">get_sroy_gt</span><span class="p">(</span><span class="n">get</span><span class="o">=</span><span class="n">da</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">spe</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="s2">&quot;chip&quot;</span><span class="p">)</span>
                <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;mean_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;chip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">preadata</span><span class="p">)</span>
                <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">clf_omni</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="p">)</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;omni_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;chip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">preadata</span><span class="p">)</span>
                <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">clf_self</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="p">)</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;self_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;chip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">preadata</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">da</span><span class="p">,</span> <span class="n">spe</span><span class="p">,</span> <span class="s2">&quot;ko&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">todo</span><span class="p">:</span>
                <span class="n">preadata</span> <span class="o">=</span> <span class="n">get_sroy_gt</span><span class="p">(</span><span class="n">get</span><span class="o">=</span><span class="n">da</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="n">spe</span><span class="p">,</span> <span class="n">gt</span><span class="o">=</span><span class="s2">&quot;ko&quot;</span><span class="p">)</span>
                <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;mean_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;ko&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">preadata</span><span class="p">)</span>
                <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">clf_omni</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="p">)</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;omni_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;ko&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">preadata</span><span class="p">)</span>
                <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">clf_self</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="p">)</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;self_&quot;</span> <span class="o">+</span> <span class="n">da</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;ko&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">preadata</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">grn</span>
    <span class="k">elif</span> <span class="n">default_dataset</span> <span class="o">==</span> <span class="s2">&quot;gwps&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">FILEDIR</span> <span class="o">+</span> <span class="s2">&quot;/../../data/perturb_gt.h5ad&quot;</span><span class="p">):</span>
            <span class="n">adata</span> <span class="o">=</span> <span class="n">get_perturb_gt</span><span class="p">()</span>
            <span class="n">adata</span><span class="o">.</span><span class="n">write_h5ad</span><span class="p">(</span><span class="n">FILEDIR</span> <span class="o">+</span> <span class="s2">&quot;/../../data/perturb_gt.h5ad&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">adata</span> <span class="o">=</span> <span class="n">read_h5ad</span><span class="p">(</span><span class="n">FILEDIR</span> <span class="o">+</span> <span class="s2">&quot;/../../data/perturb_gt.h5ad&quot;</span><span class="p">)</span>
        <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">Preprocessor</span><span class="p">(</span>
            <span class="n">force_preprocess</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">skip_validate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">do_postp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">min_valid_genes_id</span><span class="o">=</span><span class="n">maxgenes</span><span class="p">,</span>
            <span class="n">min_dataset_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">nadata</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;isTF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">gene_name</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">grnutils</span><span class="o">.</span><span class="n">TF</span><span class="p">),</span> <span class="s2">&quot;isTF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;isTF&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">grn_inferer</span> <span class="o">=</span> <span class="n">GNInfer</span><span class="p">(</span>
            <span class="n">layer</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;most var within&quot;</span><span class="p">,</span>
            <span class="n">preprocess</span><span class="o">=</span><span class="s2">&quot;softmax&quot;</span><span class="p">,</span>
            <span class="n">head_agg</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="n">filtration</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="n">forward_mode</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="n">num_genes</span><span class="o">=</span><span class="n">maxgenes</span><span class="p">,</span>
            <span class="n">max_cells</span><span class="o">=</span><span class="n">maxcells</span><span class="p">,</span>
            <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">grn</span> <span class="o">=</span> <span class="n">grn_inferer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">nadata</span><span class="p">)</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span>

        <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span><span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">adata</span><span class="p">)</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;ensembl_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;mean_base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
            <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span><span class="o">.</span><span class="n">scprint_benchmark</span><span class="p">()</span>

        <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;ensembl_id&quot;</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">clf_omni</span> <span class="o">=</span> <span class="n">train_classifier</span><span class="p">(</span>
            <span class="n">grn</span><span class="p">,</span>
            <span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">train_size</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
            <span class="n">class_weight</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">return_full</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">use_col</span><span class="o">=</span><span class="s2">&quot;gene_name&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">clf_omni</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;omni&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span><span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">adata</span><span class="p">)</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;omni_classifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;omni_base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
            <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span><span class="o">.</span><span class="n">scprint_benchmark</span><span class="p">()</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;ensembl_id&quot;</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">clf_self</span> <span class="o">=</span> <span class="n">train_classifier</span><span class="p">(</span>
            <span class="n">grn</span><span class="p">,</span>
            <span class="n">other</span><span class="o">=</span><span class="n">adata</span><span class="p">,</span>
            <span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">train_size</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">class_weight</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
            <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">return_full</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">use_col</span><span class="o">=</span><span class="s2">&quot;ensembl_id&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">clf_self</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;self&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span><span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">adata</span><span class="p">)</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;self_classifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span>
        <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;self_base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
            <span class="n">grn</span><span class="p">,</span> <span class="n">do_auc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span><span class="o">.</span><span class="n">scprint_benchmark</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># max_genes=4000</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">default_dataset</span><span class="p">)</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;isTF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">grnutils</span><span class="o">.</span><span class="n">TF</span><span class="p">),</span> <span class="s2">&quot;isTF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">celltype</span> <span class="ow">in</span> <span class="n">cell_types</span><span class="p">:</span>
            <span class="c1"># print(celltype)</span>
            <span class="c1"># grn_inferer = GNInfer(</span>
            <span class="c1">#    layer=layers,</span>
            <span class="c1">#    how=&quot;random expr&quot;,</span>
            <span class="c1">#    preprocess=&quot;softmax&quot;,</span>
            <span class="c1">#    head_agg=&quot;max&quot;,</span>
            <span class="c1">#    filtration=&quot;none&quot;,</span>
            <span class="c1">#    forward_mode=&quot;none&quot;,</span>
            <span class="c1">#    num_workers=8,</span>
            <span class="c1">#    num_genes=2200,</span>
            <span class="c1">#    max_cells=maxcells,</span>
            <span class="c1">#    doplot=False,</span>
            <span class="c1">#    batch_size=batch_size,</span>
            <span class="c1"># )</span>
            <span class="c1">#</span>
            <span class="c1"># grn = grn_inferer(model, adata[adata.X.sum(1) &gt; 500], cell_type=celltype)</span>
            <span class="c1"># grn.var.index = make_index_unique(grn.var[&quot;symbol&quot;].astype(str))</span>
            <span class="c1"># metrics[celltype + &quot;_scprint&quot;] = BenGRN(</span>
            <span class="c1">#    grn, doplot=False</span>
            <span class="c1"># ).scprint_benchmark()</span>
            <span class="c1"># del grn</span>
            <span class="c1"># gc.collect()</span>
            <span class="n">grn_inferer</span> <span class="o">=</span> <span class="n">GNInfer</span><span class="p">(</span>
                <span class="n">layer</span><span class="o">=</span><span class="n">layers</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;most var across&quot;</span><span class="p">,</span>
                <span class="n">preprocess</span><span class="o">=</span><span class="s2">&quot;softmax&quot;</span><span class="p">,</span>
                <span class="n">head_agg</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                <span class="n">filtration</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                <span class="n">forward_mode</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                <span class="n">num_workers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                <span class="n">num_genes</span><span class="o">=</span><span class="n">maxgenes</span><span class="p">,</span>
                <span class="n">max_cells</span><span class="o">=</span><span class="n">maxcells</span><span class="p">,</span>
                <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">grn</span> <span class="o">=</span> <span class="n">grn_inferer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">],</span> <span class="n">cell_type</span><span class="o">=</span><span class="n">celltype</span><span class="p">)</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">make_index_unique</span><span class="p">(</span><span class="n">grn</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">celltype</span> <span class="o">+</span> <span class="s2">&quot;_scprint_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                <span class="n">grn</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span><span class="o">.</span><span class="n">scprint_benchmark</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">clf_omni</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">clf_omni</span> <span class="o">=</span> <span class="n">train_classifier</span><span class="p">(</span>
                    <span class="n">grn</span><span class="p">,</span>
                    <span class="n">C</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">train_size</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                    <span class="n">max_iter</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                    <span class="n">class_weight</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                    <span class="n">return_full</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">clf_omni</span><span class="p">,</span> <span class="s2">&quot;clf_omni.pkl&quot;</span><span class="p">)</span>
                <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;classifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
            <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;GRN&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grn</span><span class="o">.</span><span class="n">varp</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">clf_omni</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">celltype</span> <span class="o">+</span> <span class="s2">&quot;_scprint_class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BenGRN</span><span class="p">(</span>
                <span class="n">grn</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span><span class="o">.</span><span class="n">scprint_benchmark</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">grn</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">metrics</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="scprint.tasks.denoise" class="doc doc-heading">
            <code>scprint.tasks.denoise</code>


</h2>

    <div class="doc doc-contents first">



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="scprint.tasks.denoise.Denoiser" class="doc doc-heading">
              <code class="highlight language-python"><span class="n">Denoiser</span></code>

</h3>


    <div class="doc doc-contents ">


        <p>Denoiser class for denoising scRNA-seq data using a scPRINT model</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>batch_size</code></b>
                  (<code>int</code>, default:
                      <code>10</code>
)
              –
              <div class="doc-md-description">
                <p>Batch size for processing. Defaults to 10.</p>
              </div>
            </li>
            <li>
              <b><code>num_workers</code></b>
                  (<code>int</code>, default:
                      <code>1</code>
)
              –
              <div class="doc-md-description">
                <p>Number of workers for data loading. Defaults to 1.</p>
              </div>
            </li>
            <li>
              <b><code>max_len</code></b>
                  (<code>int</code>, default:
                      <code>5000</code>
)
              –
              <div class="doc-md-description">
                <p>Maximum number of genes to consider. Defaults to 5000.</p>
              </div>
            </li>
            <li>
              <b><code>precision</code></b>
                  (<code>str</code>, default:
                      <code>&#39;16-mixed&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Precision type for computations. Defaults to "16-mixed".</p>
              </div>
            </li>
            <li>
              <b><code>how</code></b>
                  (<code>str</code>, default:
                      <code>&#39;most var&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Method to select genes. Options are "most var". Defaults to "most var".</p>
              </div>
            </li>
            <li>
              <b><code>max_cells</code></b>
                  (<code>int</code>, default:
                      <code>500000</code>
)
              –
              <div class="doc-md-description">
                <p>Number of cells to use for plotting correlation. Defaults to 10000.</p>
              </div>
            </li>
            <li>
              <b><code>doplot</code></b>
                  (<code>bool</code>, default:
                      <code>False</code>
)
              –
              <div class="doc-md-description">
                <p>Whether to generate plots. Defaults to False.</p>
              </div>
            </li>
            <li>
              <b><code>predict_depth_mult</code></b>
                  (<code>int</code>, default:
                      <code>4</code>
)
              –
              <div class="doc-md-description">
                <p>Multiplier for prediction depth. Defaults to 4.</p>
              </div>
            </li>
            <li>
              <b><code>downsample</code></b>
                  (<code><span title="typing.Optional">Optional</span>[float]</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>Fraction of data to downsample. Defaults to None.</p>
              </div>
            </li>
            <li>
              <b><code>devices</code></b>
                  (<code><span title="typing.List">List</span>[int]</code>)
              –
              <div class="doc-md-description">
                <p>List of device IDs to use. Defaults to [0].</p>
              </div>
            </li>
            <li>
              <b><code>dtype</code></b>
                  (<code><span title="torch.dtype">dtype</span></code>, default:
                      <code><span title="torch.float16">float16</span></code>
)
              –
              <div class="doc-md-description">
                <p>Data type for computations. Defaults to torch.float16.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
                  <details class="quote">
                    <summary>Source code in <code>scprint/tasks/denoise.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">max_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5_000</span><span class="p">,</span>
    <span class="n">precision</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;16-mixed&quot;</span><span class="p">,</span>
    <span class="n">how</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;most var&quot;</span><span class="p">,</span>
    <span class="n">max_cells</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500_000</span><span class="p">,</span>
    <span class="n">doplot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">predict_depth_mult</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">downsample</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Denoiser class for denoising scRNA-seq data using a scPRINT model</span>

<span class="sd">    Args:</span>
<span class="sd">        batch_size (int, optional): Batch size for processing. Defaults to 10.</span>
<span class="sd">        num_workers (int, optional): Number of workers for data loading. Defaults to 1.</span>
<span class="sd">        max_len (int, optional): Maximum number of genes to consider. Defaults to 5000.</span>
<span class="sd">        precision (str, optional): Precision type for computations. Defaults to &quot;16-mixed&quot;.</span>
<span class="sd">        how (str, optional): Method to select genes. Options are &quot;most var&quot;. Defaults to &quot;most var&quot;.</span>
<span class="sd">        max_cells (int, optional): Number of cells to use for plotting correlation. Defaults to 10000.</span>
<span class="sd">        doplot (bool, optional): Whether to generate plots. Defaults to False.</span>
<span class="sd">        predict_depth_mult (int, optional): Multiplier for prediction depth. Defaults to 4.</span>
<span class="sd">        downsample (Optional[float], optional): Fraction of data to downsample. Defaults to None.</span>
<span class="sd">        devices (List[int], optional): List of device IDs to use. Defaults to [0].</span>
<span class="sd">        dtype (torch.dtype, optional): Data type for computations. Defaults to torch.float16.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span> <span class="o">=</span> <span class="n">num_workers</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_len</span> <span class="o">=</span> <span class="n">max_len</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">max_cells</span> <span class="o">=</span> <span class="n">max_cells</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">doplot</span> <span class="o">=</span> <span class="n">doplot</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">predict_depth_mult</span> <span class="o">=</span> <span class="n">predict_depth_mult</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">=</span> <span class="n">how</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">downsample</span> <span class="o">=</span> <span class="n">downsample</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="scprint.tasks.denoise.Denoiser.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__call__</span></code>

</h4>


    <div class="doc doc-contents ">

        <p><strong>call</strong> calling the function</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>model</code></b>
                  (<code><span title="torch.nn.Module">Module</span></code>)
              –
              <div class="doc-md-description">
                <p>The scPRINT model to be used for denoising.</p>
              </div>
            </li>
            <li>
              <b><code>adata</code></b>
                  (<code><span title="anndata.AnnData">AnnData</span></code>)
              –
              <div class="doc-md-description">
                <p>The annotated data matrix of shape n_obs x n_vars. Rows correspond to cells and columns to genes.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>AnnData</code></b>              –
              <div class="doc-md-description">
                <p>The denoised annotated data matrix.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>scprint/tasks/denoise.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">adata</span><span class="p">:</span> <span class="n">AnnData</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    __call__ calling the function</span>

<span class="sd">    Args:</span>
<span class="sd">        model (torch.nn.Module): The scPRINT model to be used for denoising.</span>
<span class="sd">        adata (AnnData): The annotated data matrix of shape n_obs x n_vars. Rows correspond to cells and columns to genes.</span>

<span class="sd">    Returns:</span>
<span class="sd">        AnnData: The denoised annotated data matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;collator_output.txt&quot;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;collator_output.txt&quot;</span><span class="p">)</span>
    <span class="n">random_indices</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cells</span> <span class="o">&lt;</span> <span class="n">adata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">random_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
            <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cells</span>
        <span class="p">)</span>
        <span class="n">adataset</span> <span class="o">=</span> <span class="n">SimpleAnnDataset</span><span class="p">(</span>
            <span class="n">adata</span><span class="p">[</span><span class="n">random_indices</span><span class="p">],</span> <span class="n">obs_to_output</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;organism_ontology_term_id&quot;</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">adataset</span> <span class="o">=</span> <span class="n">SimpleAnnDataset</span><span class="p">(</span>
            <span class="n">adata</span><span class="p">,</span> <span class="n">obs_to_output</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;organism_ontology_term_id&quot;</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;most var&quot;</span><span class="p">:</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">highly_variable_genes</span><span class="p">(</span>
            <span class="n">adata</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s2">&quot;seurat_v3&quot;</span><span class="p">,</span> <span class="n">n_top_genes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">,</span> <span class="n">span</span><span class="o">=</span><span class="mf">0.99</span>
        <span class="p">)</span>
        <span class="n">genelist</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">highly_variable</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">genelist</span><span class="p">))</span>
    <span class="n">col</span> <span class="o">=</span> <span class="n">Collator</span><span class="p">(</span>
        <span class="n">organisms</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">organisms</span><span class="p">,</span>
        <span class="n">valid_genes</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">genes</span><span class="p">,</span>
        <span class="n">max_len</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_len</span><span class="p">,</span>
        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;some&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;most var&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span><span class="p">,</span>
        <span class="n">genelist</span><span class="o">=</span><span class="n">genelist</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;most var&quot;</span> <span class="k">else</span> <span class="p">[],</span>
        <span class="n">downsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">downsample</span><span class="p">,</span>
        <span class="n">save_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
        <span class="n">adataset</span><span class="p">,</span>
        <span class="n">collate_fn</span><span class="o">=</span><span class="n">col</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_workers</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">doplot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doplot</span>
    <span class="n">model</span><span class="o">.</span><span class="n">on_predict_epoch_start</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">type</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">(),</span> <span class="n">torch</span><span class="o">.</span><span class="n">autocast</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
            <span class="n">gene_pos</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;genes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
                <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;depth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_predict</span><span class="p">(</span>
                <span class="n">gene_pos</span><span class="p">,</span>
                <span class="n">expression</span><span class="p">,</span>
                <span class="n">depth</span><span class="p">,</span>
                <span class="n">predict_mode</span><span class="o">=</span><span class="s2">&quot;denoise&quot;</span><span class="p">,</span>
                <span class="n">depth_mult</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_depth_mult</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">empty_cache</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">genes</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">model</span><span class="o">.</span><span class="n">pos</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">!=</span> <span class="s2">&quot;most var&quot;</span>
        <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">genes</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">genelist</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="n">tokeep</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">reco</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">expr_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">reco</span> <span class="o">=</span> <span class="n">reco</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">tokeep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">reco</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">reco</span> <span class="o">=</span> <span class="n">reco</span><span class="p">[</span><span class="n">tokeep</span><span class="p">]</span>
        <span class="n">noisy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s2">&quot;collator_output.txt&quot;</span><span class="p">)[</span><span class="n">tokeep</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">random_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">true</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">random_indices</span><span class="p">][</span><span class="n">tokeep</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">true</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">tokeep</span><span class="p">]</span>
        <span class="n">true</span> <span class="o">=</span> <span class="n">true</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span> <span class="k">if</span> <span class="n">issparse</span><span class="p">(</span><span class="n">true</span><span class="p">)</span> <span class="k">else</span> <span class="n">true</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">how</span> <span class="o">==</span> <span class="s2">&quot;most var&quot;</span><span class="p">:</span>
            <span class="n">true</span> <span class="o">=</span> <span class="n">true</span><span class="p">[:,</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genes</span><span class="p">)]</span>
            <span class="c1"># noisy[true==0]=0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">true</span><span class="p">[</span>
                        <span class="n">i</span><span class="p">,</span>
                        <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_indexer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">genes</span><span class="p">)[</span><span class="n">val</span><span class="p">]),</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genes</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="c1"># reco[true==0] = 0</span>
        <span class="c1"># import pdb</span>
        <span class="c1"># pdb.set_trace()</span>
        <span class="c1"># reco[reco!=0] = 2</span>
        <span class="c1"># corr_coef = np.corrcoef(</span>
        <span class="c1">#    np.vstack([reco[true!=0], noisy[true!=0], true[true!=0]])</span>
        <span class="c1"># )</span>
        <span class="n">corr_coef</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">spearmanr</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">reco</span><span class="p">[</span><span class="n">true</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="n">noisy</span><span class="p">[</span><span class="n">true</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">],</span> <span class="n">true</span><span class="p">[</span><span class="n">true</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
        <span class="p">)</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;reco2noisy&quot;</span><span class="p">:</span> <span class="n">corr_coef</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;reco2full&quot;</span><span class="p">:</span> <span class="n">corr_coef</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;noisy2full&quot;</span><span class="p">:</span> <span class="n">corr_coef</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="c1"># corr_coef[p_value &gt; 0.05] = 0</span>
        <span class="c1"># if self.doplot:</span>
        <span class="c1">#    plt.figure(figsize=(10, 5))</span>
        <span class="c1">#    plt.imshow(</span>
        <span class="c1">#        corr_coef, cmap=&quot;coolwarm&quot;, interpolation=&quot;none&quot;, vmin=-1, vmax=1</span>
        <span class="c1">#    )</span>
        <span class="c1">#    plt.colorbar()</span>
        <span class="c1">#    plt.title(&quot;Expression Correlation Coefficient&quot;)</span>
        <span class="c1">#    plt.show()</span>
        <span class="c1"># metrics = {</span>
        <span class="c1">#    &quot;reco2noisy&quot;: np.mean(</span>
        <span class="c1">#        corr_coef[</span>
        <span class="c1">#            self.max_cells : self.max_cells * 2, : self.max_cells</span>
        <span class="c1">#        ].diagonal()</span>
        <span class="c1">#    ),</span>
        <span class="c1">#    &quot;reco2full&quot;: np.mean(</span>
        <span class="c1">#        corr_coef[self.max_cells * 2 :, : self.max_cells].diagonal()</span>
        <span class="c1">#    ),</span>
        <span class="c1">#    &quot;noisy2full&quot;: np.mean(</span>
        <span class="c1">#        corr_coef[</span>
        <span class="c1">#            self.max_cells * 2 :,</span>
        <span class="c1">#            self.max_cells : self.max_cells * 2,</span>
        <span class="c1">#        ].diagonal()</span>
        <span class="c1">#    ),</span>
        <span class="c1"># }</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">metrics</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="n">random_indices</span><span class="p">[</span><span class="n">tokeep</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">random_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tokeep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">random_indices</span>
        <span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genes</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">expr_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">tokeep</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tokeep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">model</span><span class="o">.</span><span class="n">expr_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h3 id="scprint.tasks.denoise.default_benchmark" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">default_benchmark</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>default_benchmark function used to run the default denoising benchmark of scPRINT</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>model</code></b>
                  (<code><span title="typing.Any">Any</span></code>)
              –
              <div class="doc-md-description">
                <p>The scPRINT model to be used for the benchmark.</p>
              </div>
            </li>
            <li>
              <b><code>default_dataset</code></b>
                  (<code>str</code>, default:
                      <code><span title="scprint.tasks.denoise.FILE_DIR">FILE_DIR</span> + &#39;/../../data/r4iCehg3Tw5IbCLiCIbl.h5ad&#39;</code>
)
              –
              <div class="doc-md-description">
                <p>Path to the default dataset to use for benchmarking. Defaults to FILE_DIR + "/../../data/r4iCehg3Tw5IbCLiCIbl.h5ad".</p>
              </div>
            </li>
            <li>
              <b><code>max_len</code></b>
                  (<code>int</code>, default:
                      <code>5000</code>
)
              –
              <div class="doc-md-description">
                <p>Maximum number of genes to consider. Defaults to 5000.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>dict</code></b>              –
              <div class="doc-md-description">
                <p>A dictionary containing the benchmark metrics.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
            <details class="quote">
              <summary>Source code in <code>scprint/tasks/denoise.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">default_benchmark</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">default_dataset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">FILE_DIR</span> <span class="o">+</span> <span class="s2">&quot;/../../data/r4iCehg3Tw5IbCLiCIbl.h5ad&quot;</span><span class="p">,</span>
    <span class="n">max_len</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    default_benchmark function used to run the default denoising benchmark of scPRINT</span>

<span class="sd">    Args:</span>
<span class="sd">        model (Any): The scPRINT model to be used for the benchmark.</span>
<span class="sd">        default_dataset (str, optional): Path to the default dataset to use for benchmarking. Defaults to FILE_DIR + &quot;/../../data/r4iCehg3Tw5IbCLiCIbl.h5ad&quot;.</span>
<span class="sd">        max_len (int, optional): Maximum number of genes to consider. Defaults to 5000.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the benchmark metrics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">default_dataset</span><span class="p">)</span>
    <span class="n">denoise</span> <span class="o">=</span> <span class="n">Denoiser</span><span class="p">(</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
        <span class="n">max_len</span><span class="o">=</span><span class="n">max_len</span><span class="p">,</span>
        <span class="n">max_cells</span><span class="o">=</span><span class="mi">10_000</span><span class="p">,</span>
        <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">predict_depth_mult</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">downsample</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">denoise</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">adata</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="scprint.tasks.denoise.split_molecules" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">split_molecules</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Splits molecules into two (potentially overlapping) groups.
:param umis: Array of molecules to split
:param data_split: Proportion of molecules to assign to the first group
:param overlap_factor: Overlap correction factor, if desired
:param random_state: For reproducible sampling
:return: umis_X and umis_Y, representing <code>split</code> and <code>~(1 - split)</code> counts
         sampled from the input array</p>

            <details class="quote">
              <summary>Source code in <code>scprint/tasks/denoise.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">split_molecules</span><span class="p">(</span>
    <span class="n">umis</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">data_split</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">overlap_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">random_state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Splits molecules into two (potentially overlapping) groups.</span>
<span class="sd">    :param umis: Array of molecules to split</span>
<span class="sd">    :param data_split: Proportion of molecules to assign to the first group</span>
<span class="sd">    :param overlap_factor: Overlap correction factor, if desired</span>
<span class="sd">    :param random_state: For reproducible sampling</span>
<span class="sd">    :return: umis_X and umis_Y, representing ``split`` and ``~(1 - split)`` counts</span>
<span class="sd">             sampled from the input array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">random_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">random_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">()</span>

    <span class="n">umis_X_disjoint</span> <span class="o">=</span> <span class="n">random_state</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="n">umis</span><span class="p">,</span> <span class="n">data_split</span> <span class="o">-</span> <span class="n">overlap_factor</span><span class="p">)</span>
    <span class="n">umis_Y_disjoint</span> <span class="o">=</span> <span class="n">random_state</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span>
        <span class="n">umis</span> <span class="o">-</span> <span class="n">umis_X_disjoint</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">data_split</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">data_split</span> <span class="o">+</span> <span class="n">overlap_factor</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">overlap_factor</span> <span class="o">=</span> <span class="n">umis</span> <span class="o">-</span> <span class="n">umis_X_disjoint</span> <span class="o">-</span> <span class="n">umis_Y_disjoint</span>
    <span class="n">umis_X</span> <span class="o">=</span> <span class="n">umis_X_disjoint</span> <span class="o">+</span> <span class="n">overlap_factor</span>
    <span class="n">umis_Y</span> <span class="o">=</span> <span class="n">umis_Y_disjoint</span> <span class="o">+</span> <span class="n">overlap_factor</span>

    <span class="k">return</span> <span class="n">umis_X</span><span class="p">,</span> <span class="n">umis_Y</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../model/" class="btn btn-neutral float-left" title="model"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../cli/" class="btn btn-neutral float-right" title="cli">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../model/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../cli/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
