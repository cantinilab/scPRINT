<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://www.jkobject.com/scPRINT/pretrain/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>pre-training - scprint</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "pre-training";
        var mkdocs_page_input_path = "pretrain.md";
        var mkdocs_page_url = "/scPRINT/pretrain/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> scprint
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../structure/">structure</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">pre-training</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#setup-of-the-database">Setup of the database</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#pre-training">Pre-training</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#fine-tuning">Fine-tuning</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../usage/">usage example</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">example notebooks</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../notebooks/cancer_usecase/">scPRINT use case on BPH</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../notebooks/cancer_usecase_part2/">scPRINT use case on BPH (part 2, GN analysis)</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">documentation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../model/">model</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../tasks/">tasks</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cli/">cli</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../embedder/">embedders</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../utils/">utils</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">scprint</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">pre-training</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="pre-training-scprint">Pre-training scPRINT</h1>
<p>scPRINT is a large model that can be pre-trained on a large dataset of single cell data.</p>
<p>This pre-training is quite efficient for scPRINT and smaller models can be pretrained on any hardware with a 20GB NVIDIA GPU.</p>
<h2 id="setup-of-the-database">Setup of the database</h2>
<p>To perform pretraining you will need a large dataset. We recommend using the <a href="https://lamin.ai">laminDB</a> to assemble such a large database of dataset and to use our <a href="https://github.com/jkobject/scDataLoader">scdataloader</a> package to perform the data loading to the model.</p>
<p>In addition, you will need to preprocess your datasets. To make sure that the fields are all here, the genes are in the right format, the raw counts are used, etc... We recommend using the Preprocessor class of the <code>scdataloader</code> package.</p>
<p>Moreover scdataloader works with a set of ontologies. To install these, use the function <code>populate_my_ontologies</code> from the <code>scdataloader</code> package.</p>
<p>If you do not have your own database of anndatas, we recommend the <a href="https://cellxgene.cziscience.com/">cellxgene database</a> and our associated helper function to download and preprocess all of cellxgene in a single command with <code>scdataloader</code>.</p>
<p>Finally you might want to generate gene embeddings to use with scPRINT instead of learning these tokens from scratch. For this you can use the <a href="../embedder/">gene_embedders</a> module of scPRINT, which usage is detailed in the <code>notebooks/generate_gene_embeddings.ipynb</code> notebook.</p>
<h2 id="pre-training">Pre-training</h2>
<p>to pretrain scPRINT we strongly recommend using command line as it can take multiple days (and using some HPC plateform like slurm or others). If on your own machine, use something like <code>screen</code> at least ðŸ˜‰.</p>
<p>Most of the pre-training usage follows from <a href="https://lightning.ai/docs/pytorch/stable/levels/intermediate.html">pytorch lightning</a> with <code>scprint fit</code> you will launch a training run. It will populate both the datamodule (see <code>scdataloader</code>), the model (see <code>model.py</code>), the trainer (see <code>pytorch lightning</code>) and the various callbacks.</p>
<p>But you might want to use additional parameters. For this, you can use the <code>config</code> folder and the <code>yaml</code> files in it. These files are used to store the main hyperparameters of the model and the training scheme.</p>
<p>More hyperparameters are given to the scPRINT model via a Trainer callback I created (see <code>trainer/trainer.py</code>). This is used to specify parameters to scPRINT that are used solely during training and are not part of the model definition itself, like lr, schedulers, optimizers, etc.. I use a callback as it is how pytorch lightning requires us to send training parameters to the model.</p>
<p>Thus a full command line to train scPRINT on a slurm cluster might look like this:</p>
<pre><code class="language-bash">conda activate scprint
### slurm level stuff
module load cuda/11.7
srun 
  -p gpu #gpu partition
  -q gpu #gpu queue
  --gres=gpu:A40:4,gmem:40G #gpu type (4 A40 with 40GB of GPU mem)
  --cpus-per-task 16
  --mem-per-gpu 90G #RAM per GPU
  --ntasks-per-node=1 
####
  # actuall scprint command
  scprint fit 
    --config config/base.yml #base config file (see below)
    --config config/pretrain_large.yml #the differences when training a large model
    --model.nhead 8 # changing this parameter from the large model directly in command line (cannot do 4 heads of 128dim with A40 GPUs...)
    --scprint_training.name o2uniqsx #an id for the model (not needed but useful)
    --trainer.strategy auto #here the strategy selected will be &quot;ddp_find_unused_parameters_true&quot;
</code></pre>
<p>with the base yaml file containing:</p>
<pre><code class="language-yaml"># general params
project: scprint_scale #project name for saving data and wandb
seed_everything: 42
ckpt_path: null #we don't have a checkpoint weights as we train from scratch
set_float32_matmul_precision: True
wandblog: all #we use wandb here
log_freq: 200
log_graph: True
trainer: #training level params
  precision: 16-mixed #we use mixed precision 16bit for training
  gradient_clip_val: 100 #needed
  log_every_n_steps: 100
  ....
  logger: #we can add multiple loggers (see below)
    - class_path: lightning.pytorch.loggers.WandbLogger
  callbacks: #you can create your own callback and add it here or use lightning's callbacks
    - class_path: lightning.pytorch.callbacks.StochasticWeightAveraging
      init_args:
        swa_lrs: 0.03
    ...
model: # model params
  dropout: 0.1
  transformer: flash #flashattention is used
  mvc_decoder: inner product
  residual_in_fp32: True
  ...
data: #datamodule params
  organisms: #we will use these 2 species
    - NCBITaxon:9606
    - NCBITaxon:10090
  gene_position_tolerance: 10_000 #gene location: if genes are closer than 10kb, they are considered as the same location
  gene_embeddings: ./data/main/gene_embeddings.parquet #the embeddings of genes (see above  )
  collection_name: all no zhang13M # the name of the laminDB collection we will use
  how: random expr # how we collate the expression data (here random expressed genes)
  max_len: 2200 #how many genes we use in the model context during training
  weight_scaler: 50 #how do we scale the weighted random sampling procedure (see our manuscript)
  ...
</code></pre>
<p>We use wanDB in our case and our previous wandb training runs are available <a href="https://wandb.ai/ml4ig/scprint_scale/reports/scPRINT-trainings--Vmlldzo4ODIxMjgx?accessToken=80metwx7b08hhourotpskdyaxiflq700xzmzymr6scvkp69agybt79l341tv68hp">here</a>, however scPRINT and pytorch lightning support a breadth of logging tools: <a href="https://lightning.ai/docs/pytorch/stable/api_references.html#loggers">see loggers</a>.</p>
<p>We use slurm in our usecase here but scPRINT and pytorch lightning has been made to work in a breadth of environments <a href="https://lightning.ai/docs/pytorch/stable/levels/intermediate_level_7.html">e.g.</a>.</p>
<h2 id="fine-tuning">Fine-tuning</h2>
<p>For now scPRINT doesn't have a fine-tuning script. But PRs are very welcome on using LoRA and its alternatives to fine-tune scPRINT on novel tasks!</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../structure/" class="btn btn-neutral float-left" title="structure"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../usage/" class="btn btn-neutral float-right" title="usage example">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../structure/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../usage/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
